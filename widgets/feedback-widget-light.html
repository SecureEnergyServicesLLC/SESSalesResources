<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback & Support - Secure Energy Analytics Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #003B5C;
            --primary-blue-light: #005580;
            --accent-green: #00A651;
            --accent-orange: #F7941D;
            --accent-red: #DC3545;
            --bg-primary: #1a1d23;
            --bg-secondary: #22262e;
            --bg-tertiary: #2a2f38;
            --bg-card: #282c34;
            --bg-hover: #32373f;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --text-muted: #6c757d;
            --border-color: #3d4450;
            --status-open: #17a2b8;
            --status-in-progress: #ffc107;
            --status-awaiting: #6f42c1;
            --status-resolved: #28a745;
            --status-closed: #6c757d;
        }
        [data-theme="light"] {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8e8;
            --bg-card: #ffffff;
            --bg-hover: #f0f0f0;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #ddd;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; padding: 20px; }
        
        .widget-container { max-width: 100%; }
        
        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; background: var(--bg-card); border-radius: 10px;
            margin-bottom: 16px; border: 1px solid var(--border-color);
        }
        .header-bar h2 { font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; gap: 10px; }
        
        .btn {
            display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px;
            border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 500;
            cursor: pointer; transition: all 0.15s ease;
        }
        .btn-primary { background: var(--primary-blue); color: white; }
        .btn-primary:hover { background: var(--primary-blue-light); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--bg-hover); }
        
        .stats-row {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;
        }
        .stat-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 12px; text-align: center;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-green); }
        .stat-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; }
        
        .tickets-container {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 10px; overflow: hidden;
        }
        .tickets-header {
            padding: 12px 16px; background: var(--bg-tertiary);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .tickets-header select {
            padding: 6px 10px; background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 4px; color: var(--text-primary); font-size: 0.8rem;
        }
        
        .ticket-list { min-height: 200px; }
        
        .ticket-item {
            display: flex; align-items: stretch; padding: 14px 16px;
            border-bottom: 1px solid var(--border-color); cursor: pointer;
            transition: background 0.15s;
        }
        .ticket-item:hover { background: var(--bg-hover); }
        .ticket-item:last-child { border-bottom: none; }
        
        .ticket-priority {
            width: 4px; border-radius: 2px; margin-right: 14px; flex-shrink: 0;
        }
        .ticket-priority.critical { background: var(--accent-red); }
        .ticket-priority.high { background: var(--accent-orange); }
        .ticket-priority.medium { background: #ffc107; }
        .ticket-priority.low { background: var(--accent-green); }
        
        .ticket-content { flex: 1; min-width: 0; }
        .ticket-header-row { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
        .ticket-id {
            font-family: monospace; font-size: 0.75rem; color: var(--text-muted);
            background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px;
        }
        .ticket-subject { font-weight: 500; font-size: 0.9rem; }
        .ticket-meta { font-size: 0.75rem; color: var(--text-secondary); }
        
        .ticket-badges { display: flex; gap: 6px; align-items: center; flex-shrink: 0; margin-left: 12px; }
        .badge {
            padding: 3px 8px; border-radius: 10px; font-size: 0.65rem;
            font-weight: 600; text-transform: uppercase;
        }
        .badge-status { background: rgba(23,162,184,0.2); color: var(--status-open); }
        .badge-status.in-progress { background: rgba(255,193,7,0.2); color: var(--status-in-progress); }
        .badge-status.awaiting-response { background: rgba(111,66,193,0.2); color: var(--status-awaiting); }
        .badge-status.resolved { background: rgba(40,167,69,0.2); color: var(--status-resolved); }
        .badge-status.closed { background: rgba(108,117,125,0.2); color: var(--status-closed); }
        
        .empty-state {
            text-align: center; padding: 50px 20px; color: var(--text-muted);
        }
        .empty-state .icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; justify-content: center;
            align-items: center; z-index: 1000; padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-card); border-radius: 12px; width: 100%;
            max-width: 600px; max-height: 90vh; overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }
        .modal-header h3 { font-size: 1rem; }
        .modal-close {
            background: none; border: none; color: var(--text-secondary);
            font-size: 1.3rem; cursor: pointer; padding: 4px;
        }
        .modal-body { padding: 20px; }
        .modal-footer {
            padding: 14px 20px; background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
            display: flex; justify-content: flex-end; gap: 10px;
        }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 6px; }
        .form-group .required { color: var(--accent-red); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px 12px; background: var(--bg-tertiary);
            border: 1px solid var(--border-color); border-radius: 6px;
            color: var(--text-primary); font-size: 0.9rem;
        }
        .form-group textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary-blue);
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .help-text { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        
        .file-upload {
            border: 2px dashed var(--border-color); border-radius: 8px;
            padding: 20px; text-align: center; cursor: pointer;
            transition: all 0.15s;
        }
        .file-upload:hover, .file-upload.dragover {
            border-color: var(--primary-blue); background: rgba(0,59,92,0.1);
        }
        .file-upload .icon { font-size: 2rem; margin-bottom: 8px; }
        .screenshot-previews { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .screenshot-preview {
            position: relative; width: 70px; height: 70px;
            border-radius: 6px; overflow: hidden; border: 1px solid var(--border-color);
        }
        .screenshot-preview img { width: 100%; height: 100%; object-fit: cover; }
        .screenshot-preview .remove {
            position: absolute; top: 2px; right: 2px; background: rgba(220,53,69,0.9);
            color: white; border: none; border-radius: 50%; width: 18px; height: 18px;
            font-size: 0.7rem; cursor: pointer; line-height: 1;
        }
        
        /* View Ticket Modal */
        .ticket-detail-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 16px;
        }
        .ticket-detail-meta {
            display: flex; flex-wrap: wrap; gap: 16px; font-size: 0.85rem;
            color: var(--text-secondary); margin-bottom: 16px;
        }
        .ticket-detail-meta strong { color: var(--text-muted); font-weight: 400; }
        .ticket-section { margin-bottom: 20px; }
        .ticket-section h4 {
            font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 8px; padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }
        .conversation-thread {
            max-height: 300px; overflow-y: auto; background: var(--bg-primary);
            border-radius: 8px; padding: 12px; margin-bottom: 12px;
        }
        .message {
            margin-bottom: 12px; padding: 10px 14px; border-radius: 10px; max-width: 85%;
        }
        .message.user {
            background: var(--primary-blue); color: white; margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message.admin {
            background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        .message.system {
            background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3);
            margin: 0 auto; max-width: 100%; text-align: center;
            font-size: 0.8rem; color: var(--text-secondary);
        }
        .message-header { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 4px; }
        .message-body { font-size: 0.9rem; }
        
        .reply-box textarea {
            width: 100%; padding: 10px; background: var(--bg-tertiary);
            border: 1px solid var(--border-color); border-radius: 6px;
            color: var(--text-primary); font-size: 0.9rem; min-height: 70px;
        }
        .reply-actions { display: flex; justify-content: flex-end; margin-top: 10px; }
        
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast {
            padding: 12px 18px; border-radius: 8px; background: var(--bg-card);
            border: 1px solid var(--border-color); margin-top: 10px;
            display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease;
        }
        .toast.success { border-left: 4px solid var(--accent-green); }
        .toast.error { border-left: 4px solid var(--accent-red); }
        .toast.info { border-left: 4px solid var(--primary-blue); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        @media (max-width: 600px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .form-row { grid-template-columns: 1fr; }
            .ticket-badges { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <!-- Header -->
        <div class="header-bar">
            <h2>ðŸ“‹ My Support Tickets</h2>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="refreshTickets()">â†» Refresh</button>
                <button class="btn btn-primary" onclick="openNewTicketModal()">+ New Ticket</button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-value" id="statOpen">0</div>
                <div class="stat-label">Open</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statInProgress">0</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statResolved">0</div>
                <div class="stat-label">Resolved</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">Total</div>
            </div>
        </div>
        
        <!-- Tickets List -->
        <div class="tickets-container">
            <div class="tickets-header">
                <span>Your Tickets</span>
                <select id="filterStatus" onchange="renderTickets()">
                    <option value="all">All Statuses</option>
                    <option value="open">Open</option>
                    <option value="in-progress">In Progress</option>
                    <option value="awaiting-response">Awaiting Response</option>
                    <option value="resolved">Resolved</option>
                    <option value="closed">Closed</option>
                </select>
            </div>
            <div class="ticket-list" id="ticketList">
                <div class="empty-state">
                    <div class="icon">ðŸ“­</div>
                    <p>No tickets yet</p>
                    <span style="font-size:0.85rem;">Create a ticket to request features or report issues</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Ticket Modal -->
    <div class="modal-overlay" id="newTicketModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Create New Ticket</h3>
                <button class="modal-close" onclick="closeModal('newTicketModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newTicketForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Category <span class="required">*</span></label>
                            <select id="ticketCategory" required>
                                <option value="">Select...</option>
                                <option value="flow">Flow / Navigation Issue</option>
                                <option value="new-widget">New Widget Request</option>
                                <option value="enhanced-widget">Enhanced Widget Feature</option>
                                <option value="troubleshoot">Troubleshoot Issue</option>
                                <option value="data-issue">Data Issue / Discrepancy</option>
                                <option value="performance">Performance Problem</option>
                                <option value="ui-ux">UI/UX Improvement</option>
                                <option value="documentation">Documentation Request</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priority <span class="required">*</span></label>
                            <select id="ticketPriority" required>
                                <option value="medium" selected>Medium</option>
                                <option value="low">Low - Nice to have</option>
                                <option value="high">High - Impacting work</option>
                                <option value="critical">Critical - Cannot proceed</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Subject <span class="required">*</span></label>
                        <input type="text" id="ticketSubject" placeholder="Brief description" required maxlength="200">
                    </div>
                    
                    <div class="form-group">
                        <label>Description <span class="required">*</span></label>
                        <textarea id="ticketDescription" placeholder="Please describe the issue or request in detail..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Related Widget</label>
                        <select id="ticketWidget">
                            <option value="">Select if applicable...</option>
                            <option value="client-admin">Client Administration</option>
                            <option value="client-lookup">Client Lookup</option>
                            <option value="energy-utilization">Energy Utilization</option>
                            <option value="bid-management">Bid Management</option>
                            <option value="ai-assistant">AI Assistant</option>
                            <option value="aei-intelligence">AE Intelligence (BUDA)</option>
                            <option value="lmp-analytics">LMP Analytics</option>
                            <option value="lmp-comparison">LMP Comparison</option>
                            <option value="peak-demand">Peak Demand Analytics</option>
                            <option value="data-manager">Data Manager</option>
                            <option value="dashboard">Main Dashboard</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Error Messages (if any)</label>
                        <textarea id="ticketErrorLog" placeholder="Copy and paste any error messages here. Press F12 â†’ Console to see technical errors." style="font-family:monospace;font-size:0.8rem;"></textarea>
                        <span class="help-text">ðŸ’¡ Open browser console (F12 â†’ Console tab) to find error details</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Screenshots</label>
                        <div class="file-upload" id="fileUpload" onclick="document.getElementById('screenshotInput').click()">
                            <input type="file" id="screenshotInput" multiple accept="image/*" hidden>
                            <div class="icon">ðŸ“·</div>
                            <p>Click to upload screenshots</p>
                            <span class="help-text">PNG, JPG up to 5MB each (max 5 files)</span>
                        </div>
                        <div class="screenshot-previews" id="screenshotPreviews"></div>
                    </div>
                    
                    <input type="hidden" id="ticketBrowser">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('newTicketModal')">Cancel</button>
                <button type="submit" class="btn btn-primary" form="newTicketForm">Submit Ticket</button>
            </div>
        </div>
    </div>
    
    <!-- View Ticket Modal -->
    <div class="modal-overlay" id="viewTicketModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h3>Ticket #<span id="viewTicketId"></span></h3>
                <button class="modal-close" onclick="closeModal('viewTicketModal')">&times;</button>
            </div>
            <div class="modal-body" id="viewTicketBody">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
    // =====================================================
    // CONFIGURATION
    // =====================================================
    const CONFIG = {
        TICKET_PREFIX: 'SE',
        MAX_SCREENSHOTS: 5,
        MAX_FILE_SIZE: 5 * 1024 * 1024
    };
    
    const CATEGORY_NAMES = {
        'flow': 'Flow / Navigation', 'new-widget': 'New Widget', 'enhanced-widget': 'Enhanced Widget',
        'troubleshoot': 'Troubleshoot', 'data-issue': 'Data Issue', 'performance': 'Performance',
        'ui-ux': 'UI/UX', 'documentation': 'Documentation', 'other': 'Other'
    };
    
    const STATUS_NAMES = {
        'open': 'Open', 'in-progress': 'In Progress', 'awaiting-response': 'Awaiting Response',
        'resolved': 'Resolved', 'closed': 'Closed'
    };
    
    let state = { tickets: [], currentUser: null, pendingScreenshots: [], currentTicket: null };
    
    // =====================================================
    // INITIALIZATION
    // =====================================================
    document.addEventListener('DOMContentLoaded', async () => {
        await initUser();
        await loadTickets();
        setupEventListeners();
        detectBrowser();
        renderTickets();
        updateStats();
        
        // Listen for theme changes
        window.addEventListener('message', (e) => {
            if (e.data?.type === 'THEME_CHANGE') {
                document.documentElement.setAttribute('data-theme', e.data.theme);
            }
            if (e.data?.type === 'USER_DATA') {
                state.currentUser = e.data.user;
                loadTickets().then(() => { renderTickets(); updateStats(); });
            }
        });
        
        // Request user data from parent
        window.parent?.postMessage({ type: 'REQUEST_USER_DATA' }, '*');
    });
    
    async function initUser() {
        try {
            if (window.parent !== window && window.parent.currentUser) {
                state.currentUser = window.parent.currentUser;
            } else {
                const stored = localStorage.getItem('secureEnergy_currentUser');
                if (stored) state.currentUser = JSON.parse(stored);
            }
        } catch (e) { console.warn('Could not get user:', e); }
        
        if (!state.currentUser) {
            state.currentUser = { id: 'guest', name: 'Guest User', email: 'guest@example.com' };
        }
    }
    
    async function loadTickets() {
        try {
            // Try to get from parent's TicketStore
            if (window.parent?.TicketStore) {
                const data = await window.parent.TicketStore.getTickets();
                state.tickets = (data?.tickets || []).filter(t => t.submittedBy?.id === state.currentUser?.id);
                return;
            }
            
            // Fallback to localStorage
            const stored = localStorage.getItem('secureEnergy_tickets');
            if (stored) {
                const data = JSON.parse(stored);
                state.tickets = (data.tickets || []).filter(t => t.submittedBy?.id === state.currentUser?.id);
            }
        } catch (e) {
            console.error('Error loading tickets:', e);
            state.tickets = [];
        }
    }
    
    async function saveTicket(ticket) {
        try {
            // Send to parent for central storage
            window.parent?.postMessage({ type: 'TICKET_CREATED', ticket }, '*');
            
            // Also save locally
            const stored = localStorage.getItem('secureEnergy_tickets');
            const data = stored ? JSON.parse(stored) : { tickets: [], activityLog: [] };
            data.tickets.unshift(ticket);
            data.lastUpdated = new Date().toISOString();
            localStorage.setItem('secureEnergy_tickets', JSON.stringify(data));
            
            state.tickets.unshift(ticket);
        } catch (e) {
            console.error('Error saving ticket:', e);
        }
    }
    
    async function saveTicketReply(ticketId, reply) {
        try {
            window.parent?.postMessage({ type: 'TICKET_REPLY', ticketId, reply }, '*');
            
            const stored = localStorage.getItem('secureEnergy_tickets');
            if (stored) {
                const data = JSON.parse(stored);
                const ticket = data.tickets.find(t => t.id === ticketId);
                if (ticket) {
                    if (!ticket.conversation) ticket.conversation = [];
                    ticket.conversation.push(reply);
                    ticket.updatedAt = new Date().toISOString();
                    localStorage.setItem('secureEnergy_tickets', JSON.stringify(data));
                }
            }
            
            const localTicket = state.tickets.find(t => t.id === ticketId);
            if (localTicket) {
                if (!localTicket.conversation) localTicket.conversation = [];
                localTicket.conversation.push(reply);
                localTicket.updatedAt = new Date().toISOString();
            }
        } catch (e) {
            console.error('Error saving reply:', e);
        }
    }
    
    // =====================================================
    // EVENT LISTENERS
    // =====================================================
    function setupEventListeners() {
        document.getElementById('newTicketForm').addEventListener('submit', handleSubmitTicket);
        
        const uploadArea = document.getElementById('fileUpload');
        const fileInput = document.getElementById('screenshotInput');
        
        fileInput.addEventListener('change', (e) => processScreenshots(e.target.files));
        
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            processScreenshots(e.dataTransfer.files);
        });
    }
    
    // =====================================================
    // TICKET RENDERING
    // =====================================================
    function renderTickets() {
        const container = document.getElementById('ticketList');
        const filter = document.getElementById('filterStatus').value;
        
        let filtered = state.tickets;
        if (filter !== 'all') {
            filtered = filtered.filter(t => t.status === filter);
        }
        
        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">ðŸ“­</div>
                    <p>${filter !== 'all' ? 'No ' + STATUS_NAMES[filter].toLowerCase() + ' tickets' : 'No tickets yet'}</p>
                    <span style="font-size:0.85rem;">Create a ticket to request features or report issues</span>
                </div>`;
            return;
        }
        
        container.innerHTML = filtered.map(t => `
            <div class="ticket-item" onclick="viewTicket('${t.id}')">
                <div class="ticket-priority ${t.priority}"></div>
                <div class="ticket-content">
                    <div class="ticket-header-row">
                        <span class="ticket-id">#${t.id}</span>
                        <span class="ticket-subject">${escapeHtml(t.subject)}</span>
                    </div>
                    <div class="ticket-meta">
                        ðŸ“… ${formatDate(t.createdAt)} Â· ${CATEGORY_NAMES[t.category] || t.category}
                    </div>
                </div>
                <div class="ticket-badges">
                    <span class="badge badge-status ${t.status}">${STATUS_NAMES[t.status]}</span>
                    ${t.conversation?.length ? '<span title="Has replies">ðŸ’¬</span>' : ''}
                </div>
            </div>
        `).join('');
    }
    
    function updateStats() {
        const stats = { open: 0, inProgress: 0, resolved: 0, total: state.tickets.length };
        state.tickets.forEach(t => {
            if (t.status === 'open') stats.open++;
            else if (t.status === 'in-progress') stats.inProgress++;
            else if (t.status === 'resolved' || t.status === 'closed') stats.resolved++;
        });
        document.getElementById('statOpen').textContent = stats.open;
        document.getElementById('statInProgress').textContent = stats.inProgress;
        document.getElementById('statResolved').textContent = stats.resolved;
        document.getElementById('statTotal').textContent = stats.total;
    }
    
    // =====================================================
    // TICKET CREATION
    // =====================================================
    async function handleSubmitTicket(e) {
        e.preventDefault();
        
        const ticket = {
            id: generateTicketId(),
            category: document.getElementById('ticketCategory').value,
            priority: document.getElementById('ticketPriority').value,
            subject: document.getElementById('ticketSubject').value.trim(),
            description: document.getElementById('ticketDescription').value.trim(),
            widget: document.getElementById('ticketWidget').value || null,
            errorLog: document.getElementById('ticketErrorLog').value.trim() || null,
            screenshots: [...state.pendingScreenshots],
            browser: document.getElementById('ticketBrowser').value,
            status: 'open',
            submittedBy: {
                id: state.currentUser.id,
                name: state.currentUser.firstName ? `${state.currentUser.firstName} ${state.currentUser.lastName}` : state.currentUser.name,
                email: state.currentUser.email
            },
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            conversation: []
        };
        
        await saveTicket(ticket);
        
        closeModal('newTicketModal');
        document.getElementById('newTicketForm').reset();
        state.pendingScreenshots = [];
        document.getElementById('screenshotPreviews').innerHTML = '';
        detectBrowser();
        
        renderTickets();
        updateStats();
        
        showToast(`Ticket ${ticket.id} created!`, 'success');
    }
    
    // =====================================================
    // VIEW TICKET
    // =====================================================
    function viewTicket(ticketId) {
        const ticket = state.tickets.find(t => t.id === ticketId);
        if (!ticket) return;
        
        state.currentTicket = ticket;
        document.getElementById('viewTicketId').textContent = ticket.id;
        
        const body = document.getElementById('viewTicketBody');
        body.innerHTML = `
            <div class="ticket-detail-header">
                <div>
                    <h2 style="font-size:1.1rem;margin-bottom:4px;">${escapeHtml(ticket.subject)}</h2>
                    <span class="badge badge-status ${ticket.status}" style="font-size:0.75rem;">${STATUS_NAMES[ticket.status]}</span>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:0.8rem;color:var(--text-muted);">Priority</div>
                    <div style="font-weight:600;text-transform:capitalize;">${ticket.priority}</div>
                </div>
            </div>
            
            <div class="ticket-detail-meta">
                <span><strong>Created:</strong> ${new Date(ticket.createdAt).toLocaleString()}</span>
                <span><strong>Category:</strong> ${CATEGORY_NAMES[ticket.category] || ticket.category}</span>
                ${ticket.widget ? `<span><strong>Widget:</strong> ${ticket.widget}</span>` : ''}
            </div>
            
            <div class="ticket-section">
                <h4>Description</h4>
                <p style="white-space:pre-wrap;font-size:0.9rem;">${escapeHtml(ticket.description)}</p>
            </div>
            
            ${ticket.errorLog ? `
                <div class="ticket-section">
                    <h4>Error Log</h4>
                    <pre style="background:var(--bg-primary);padding:12px;border-radius:6px;font-size:0.8rem;overflow-x:auto;color:var(--accent-red);">${escapeHtml(ticket.errorLog)}</pre>
                </div>
            ` : ''}
            
            ${ticket.screenshots?.length ? `
                <div class="ticket-section">
                    <h4>Screenshots</h4>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;">
                        ${ticket.screenshots.map(s => `<img src="${s.data}" style="max-width:150px;border-radius:6px;cursor:pointer;" onclick="openImage('${s.data}')">`).join('')}
                    </div>
                </div>
            ` : ''}
            
            <div class="ticket-section">
                <h4>Conversation</h4>
                <div class="conversation-thread" id="conversationThread">
                    ${renderConversation(ticket.conversation)}
                </div>
                ${ticket.status !== 'closed' ? `
                    <div class="reply-box">
                        <textarea id="replyMessage" placeholder="Type your response..."></textarea>
                        <div class="reply-actions">
                            <button class="btn btn-primary" onclick="submitReply()">Send Reply</button>
                        </div>
                    </div>
                ` : '<p style="text-align:center;color:var(--text-muted);font-size:0.85rem;">This ticket is closed</p>'}
            </div>
        `;
        
        openModal('viewTicketModal');
    }
    
    function renderConversation(conversation) {
        if (!conversation || conversation.length === 0) {
            return '<p style="text-align:center;color:var(--text-muted);padding:20px;">No messages yet</p>';
        }
        
        return conversation.map(msg => {
            const isUser = msg.userId === state.currentUser?.id;
            const isSystem = msg.type === 'system';
            
            if (isSystem) {
                return `<div class="message system">
                    <div class="message-body">${escapeHtml(msg.text)}</div>
                    <div style="font-size:0.7rem;margin-top:4px;">${formatDate(msg.timestamp)}</div>
                </div>`;
            }
            
            return `<div class="message ${isUser ? 'user' : 'admin'}">
                <div class="message-header">
                    <span style="font-weight:600;">${escapeHtml(msg.userName)}</span>
                    <span>${formatDate(msg.timestamp)}</span>
                </div>
                <div class="message-body">${escapeHtml(msg.text)}</div>
            </div>`;
        }).join('');
    }
    
    async function submitReply() {
        const message = document.getElementById('replyMessage').value.trim();
        if (!message) return showToast('Please enter a message', 'error');
        
        const reply = {
            id: 'msg-' + Date.now(),
            userId: state.currentUser.id,
            userName: state.currentUser.firstName ? `${state.currentUser.firstName} ${state.currentUser.lastName}` : state.currentUser.name,
            text: message,
            timestamp: new Date().toISOString(),
            type: 'user'
        };
        
        await saveTicketReply(state.currentTicket.id, reply);
        
        document.getElementById('replyMessage').value = '';
        document.getElementById('conversationThread').innerHTML = renderConversation(state.currentTicket.conversation);
        document.getElementById('conversationThread').scrollTop = document.getElementById('conversationThread').scrollHeight;
        
        showToast('Reply sent', 'success');
    }
    
    // =====================================================
    // SCREENSHOTS
    // =====================================================
    function processScreenshots(files) {
        for (const file of files) {
            if (!file.type.startsWith('image/')) continue;
            if (file.size > CONFIG.MAX_FILE_SIZE) { showToast('File too large: ' + file.name, 'error'); continue; }
            if (state.pendingScreenshots.length >= CONFIG.MAX_SCREENSHOTS) { showToast('Max 5 screenshots', 'error'); break; }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                state.pendingScreenshots.push({ name: file.name, data: e.target.result, type: file.type });
                renderScreenshotPreviews();
            };
            reader.readAsDataURL(file);
        }
    }
    
    function renderScreenshotPreviews() {
        const container = document.getElementById('screenshotPreviews');
        container.innerHTML = state.pendingScreenshots.map((s, i) => `
            <div class="screenshot-preview">
                <img src="${s.data}" alt="${s.name}">
                <button class="remove" onclick="removeScreenshot(${i})">&times;</button>
            </div>
        `).join('');
    }
    
    function removeScreenshot(index) {
        state.pendingScreenshots.splice(index, 1);
        renderScreenshotPreviews();
    }
    
    // =====================================================
    // UTILITIES
    // =====================================================
    function generateTicketId() {
        return CONFIG.TICKET_PREFIX + '-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substring(2, 5).toUpperCase();
    }
    
    function formatDate(dateStr) {
        const d = new Date(dateStr);
        const now = new Date();
        const diff = (now - d) / 1000;
        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
        return d.toLocaleDateString();
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function detectBrowser() {
        const ua = navigator.userAgent;
        let browser = 'Unknown';
        if (ua.includes('Firefox')) browser = 'Firefox';
        else if (ua.includes('Chrome') && !ua.includes('Edg')) browser = 'Chrome';
        else if (ua.includes('Safari') && !ua.includes('Chrome')) browser = 'Safari';
        else if (ua.includes('Edg')) browser = 'Edge';
        document.getElementById('ticketBrowser').value = `${browser} on ${navigator.platform} (${window.screen.width}x${window.screen.height})`;
    }
    
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function openNewTicketModal() { openModal('newTicketModal'); }
    
    async function refreshTickets() {
        await loadTickets();
        renderTickets();
        updateStats();
        showToast('Tickets refreshed', 'info');
    }
    
    function openImage(src) {
        window.open(src, '_blank', 'width=800,height=600');
    }
    
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹'}</span> ${escapeHtml(message)}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }
    
    // Close modals on escape
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeModal('newTicketModal'); closeModal('viewTicketModal'); } });
    document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', (e) => { if (e.target === m) m.classList.remove('active'); }));
    </script>
</body>
</html>
