<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Administration</title>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #003366;
            --primary-light: #004080;
            --accent: #FF6B35;
            --accent-hover: #e85a28;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-input: #0f1629;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --border: #2d3748;
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 12px;
        }
        .widget-container {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            height: calc(100vh - 24px);
            display: flex;
            flex-direction: column;
        }
        .widget-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        .widget-title {
            font-size: 1.15rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-stats {
            display: flex;
            gap: 16px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .stat-item { display: flex; align-items: center; gap: 4px; }
        .stat-value { color: var(--accent); font-weight: 600; }
        .tab-container {
            display: flex;
            background: var(--bg-input);
            border-bottom: 1px solid var(--border);
        }
        .tab-btn {
            flex: 1;
            padding: 10px 14px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: rgba(255,107,53,0.1); }
        .tab-content { display: none; flex: 1; overflow: hidden; }
        .tab-content.active { display: flex; flex-direction: column; }
        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--border);
            flex: 1;
            overflow: hidden;
        }
        .panel { background: var(--bg-card); display: flex; flex-direction: column; overflow: hidden; }
        .panel-header {
            padding: 10px 14px;
            background: var(--bg-input);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-title { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); }
        .panel-body { flex: 1; overflow-y: auto; padding: 12px; }
        .btn {
            padding: 7px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 4px 8px; font-size: 0.75rem; }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 3px; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 0.85rem;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
        .form-textarea { resize: vertical; min-height: 60px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-row-3 { grid-template-columns: 1fr 1fr 1fr; }
        .search-container { position: relative; margin-bottom: 10px; }
        .search-input {
            width: 100%;
            padding: 8px 10px 8px 32px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        .client-list { display: flex; flex-direction: column; gap: 6px; }
        .client-card {
            padding: 10px 12px;
            background: var(--bg-input);
            border-radius: 6px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .client-card:hover { border-color: var(--border); background: rgba(255,255,255,0.03); }
        .client-card.selected { border-color: var(--accent); background: rgba(255,107,53,0.1); }
        .client-card.active-client { border-color: var(--success); background: rgba(40,167,69,0.1); }
        .client-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 3px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .client-meta { font-size: 0.75rem; color: var(--text-secondary); display: flex; gap: 10px; flex-wrap: wrap; }
        .client-badge { padding: 2px 6px; border-radius: 3px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
        .badge-active { background: rgba(40,167,69,0.2); color: var(--success); }
        .badge-prospect { background: rgba(255,193,7,0.2); color: var(--warning); }
        .badge-inactive { background: rgba(108,117,125,0.2); color: #6c757d; }
        .badge-iso { background: rgba(0,51,102,0.3); color: #4da6ff; }
        .badge-account { background: rgba(59,130,246,0.2); color: #3b82f6; }
        .set-active-badge { font-size: 0.6rem; padding: 2px 5px; background: var(--success); color: white; border-radius: 3px; }
        /* Account List Styles */
        .accounts-section {
            margin-top: 16px;
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }
        .accounts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .accounts-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #3b82f6;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .account-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 250px;
            overflow-y: auto;
        }
        .account-card {
            padding: 10px 12px;
            background: var(--bg-input);
            border-radius: 6px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .account-card:hover { border-color: rgba(59,130,246,0.5); background: rgba(59,130,246,0.05); }
        .account-card.active-account { border-color: #3b82f6; background: rgba(59,130,246,0.15); }
        .account-name { font-weight: 500; font-size: 0.85rem; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
        .account-meta { font-size: 0.7rem; color: var(--text-secondary); display: flex; gap: 8px; flex-wrap: wrap; }
        .account-actions { display: flex; gap: 4px; margin-top: 6px; }
        /* Active Context Banner */
        .active-account-indicator {
            background: rgba(59,130,246,0.15);
            border: 1px solid #3b82f6;
            border-radius: 6px;
            padding: 6px 10px;
            margin-top: 8px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .active-account-indicator svg { color: #3b82f6; }
        .context-breadcrumb {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .context-breadcrumb .separator { color: var(--accent); }
        .import-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 14px;
        }
        .import-zone:hover, .import-zone.dragover { border-color: var(--accent); background: rgba(255,107,53,0.05); }
        .import-zone p { color: var(--text-secondary); margin-bottom: 6px; font-size: 0.85rem; }
        .import-options {
            display: flex;
            gap: 10px;
            margin-top: 14px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 6px;
            font-size: 0.8rem;
        }
        .import-option { display: flex; align-items: center; gap: 5px; }
        .import-mode-toggle {
            display: flex;
            gap: 0;
            margin-bottom: 14px;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        .import-mode-btn {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-input);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.78rem;
            font-weight: 500;
            transition: all 0.15s;
            text-align: center;
        }
        .import-mode-btn:not(:last-child) { border-right: 1px solid var(--border); }
        .import-mode-btn.active { background: var(--accent); color: white; }
        .import-mode-btn.active.danger { background: #dc3545; }
        .import-mode-btn:hover:not(.active) { background: rgba(255,255,255,0.04); }
        .import-mode-warn {
            font-size: 0.75rem;
            color: #dc3545;
            padding: 8px 10px;
            background: rgba(220,53,69,0.08);
            border-radius: 6px;
            margin-bottom: 12px;
            display: none;
        }
        .import-mode-warn.visible { display: block; }
        .import-field-list {
            font-size: 0.72rem;
            color: var(--text-muted);
            padding: 10px;
            background: var(--bg-input);
            border-radius: 6px;
            margin-bottom: 12px;
            line-height: 1.6;
        }
        .import-field-list strong { color: var(--text-secondary); }
        .detail-section { margin-bottom: 16px; }
        .detail-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .detail-item { padding: 6px 8px; background: var(--bg-input); border-radius: 5px; }
        .detail-label { font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 1px; }
        .detail-value { font-size: 0.85rem; word-break: break-word; }
        .detail-value.empty { color: var(--text-secondary); font-style: italic; }
        .active-client-banner {
            background: linear-gradient(135deg, rgba(40,167,69,0.2) 0%, rgba(40,167,69,0.1) 100%);
            border: 1px solid var(--success);
            border-radius: 8px;
            padding: 10px 14px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .active-client-info { display: flex; align-items: center; gap: 10px; }
        .active-client-info svg { color: var(--success); }
        .active-client-name { font-weight: 600; font-size: 1rem; }
        .active-client-meta { font-size: 0.8rem; color: var(--text-secondary); }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 18px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            font-size: 0.85rem;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--primary); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .empty-state { text-align: center; padding: 30px 16px; color: var(--text-secondary); }
        .empty-state svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            max-width: 550px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 14px 18px;
            background: var(--bg-input);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 1rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px; }
        .modal-body { padding: 16px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 14px 18px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-input); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4a5568; }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="widget-header">
            <div class="widget-title">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Client Administration
            </div>
            <div class="header-stats">
                <div class="stat-item"><span>Total:</span><span class="stat-value" id="statTotal">0</span></div>
                <div class="stat-item"><span>Active:</span><span class="stat-value" id="statActive">0</span></div>
            </div>
        </div>
        
        <div class="tab-container">
            <button class="tab-btn active" data-tab="clients">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                </svg>
                Clients
            </button>
            <button class="tab-btn" data-tab="import">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Import
            </button>
            <button class="tab-btn" data-tab="create">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/>
                </svg>
                Add Client
            </button>
            <button class="tab-btn" data-tab="export">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export
            </button>
        </div>
        
        <div class="tab-content active" id="tab-clients">
            <div id="activeClientBanner" class="active-client-banner" style="display:none;margin:12px 12px 0;">
                <div class="active-client-info">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    <div>
                        <div class="active-client-name" id="activeClientName">-</div>
                        <div class="active-client-meta" id="activeClientMeta">Active for all widgets</div>
                    </div>
                </div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <button class="btn btn-secondary btn-sm" onclick="clearActiveClient()">Clear</button>
                </div>
            </div>
            <!-- Active Account Indicator (shown when account is selected) -->
            <div id="activeAccountBanner" class="active-account-indicator" style="display:none;margin:0 12px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    <path d="M20 8v6M23 11h-6"/>
                </svg>
                <div style="flex:1;">
                    <span style="color:#3b82f6;font-weight:500;" id="activeAccountName">-</span>
                    <span class="context-breadcrumb">
                        <span class="separator">‚Üê</span> child of <span id="activeAccountParent">-</span>
                    </span>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="clearActiveAccount()" style="font-size:0.7rem;padding:3px 8px;">Clear Account</button>
            </div>
            <div class="split-layout">
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Client List</span>
                        <span id="clientCount" style="font-size:0.75rem;color:var(--text-secondary);">0 clients</span>
                    </div>
                    <div class="panel-body">
                        <div class="search-container">
                            <svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                            <input type="text" class="search-input" id="clientSearch" placeholder="Search clients...">
                        </div>
                        <div id="clientList" class="client-list"></div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Client Details</span>
                        <div id="detailActions" style="display:none;gap:6px;">
                            <button class="btn btn-success btn-sm" id="btnSetActive" onclick="setSelectedAsActive()">Set Active</button>
                            <button class="btn btn-secondary btn-sm" onclick="editSelectedClient()">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSelectedClient()">Delete</button>
                        </div>
                    </div>
                    <div class="panel-body" id="clientDetails">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                            </svg>
                            <p>Select a client to view details</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-import">
            <div class="panel-body" style="max-width:800px;margin:0 auto;">
                <!-- Parent Client Import -->
                <div style="margin-bottom:30px;padding-bottom:24px;border-bottom:1px solid var(--border);">
                    <h3 style="margin-bottom:12px;font-size:1.1rem;">
                        <span style="background:var(--accent);color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;margin-right:8px;">1</span>
                        Import Parent Clients
                    </h3>
                    <p style="color:var(--text-secondary);margin-bottom:12px;font-size:0.85rem;">
                        Upload the <strong>Parent Level</strong> Salesforce report. Rows are grouped by Parent Account ‚Äî each row's contracts &amp; opportunities are stored under the parent.
                    </p>
                    <div class="import-field-list">
                        <strong>Expected columns:</strong> Parent Account: Account ID Unique, Parent Account: Account Name, Parent Account: Customer, Account Contract Name, Opportunity: Opportunity Name, Assigned To: Contract Assignment Group Name, Status, Number Of Meters, # Active MC, Sign Date, Contract Start/End Date, Supplier: Account Name, Product Category, Estimated Annual Usage (Kwh/Dth), Estimated Contract Margin, BUDA Eligible/Notes, Account Contract ID, Contract Mils, Contract Rate
                    </div>
                    <div class="import-mode-toggle" id="parentImportMode">
                        <button class="import-mode-btn active" onclick="setImportMode('parent','append',this)">üìé Append &amp; Update</button>
                        <button class="import-mode-btn" onclick="setImportMode('parent','replace',this)">üîÑ Replace All</button>
                    </div>
                    <div class="import-mode-warn" id="parentReplaceWarn">‚ö†Ô∏è Replace All will <strong>delete all existing clients</strong> and import fresh. This cannot be undone.</div>
                    <div class="import-zone" id="importZone" onclick="document.getElementById('importFile').click()">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--text-secondary);margin-bottom:8px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p><strong>Click to upload</strong> or drag and drop</p>
                        <p style="font-size:0.8rem;">Excel (.xlsx), CSV, or JSON ‚Äî Parent Level report</p>
                        <input type="file" id="importFile" accept=".xlsx,.xls,.csv,.json" style="display:none;" onchange="handleFileSelect(event)">
                    </div>
                    <div class="import-options">
                        <label class="import-option"><input type="checkbox" id="optUpdateExisting" checked> Update existing clients</label>
                        <label class="import-option"><input type="checkbox" id="optMatchByName"> Match by name (in addition to SF ID)</label>
                    </div>
                    <div id="importPreview" style="display:none;margin-top:16px;"></div>
                    <div id="importResults" style="display:none;margin-top:16px;"></div>
                </div>
                
                <!-- Account Enrichment Import -->
                <div>
                    <h3 style="margin-bottom:12px;font-size:1.1rem;">
                        <span style="background:#3b82f6;color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;margin-right:8px;">2</span>
                        Import Child Accounts
                    </h3>
                    <p style="color:var(--text-secondary);margin-bottom:12px;font-size:0.85rem;">
                        Upload the <strong>Child Level</strong> Salesforce report. Accounts are linked to parents via <em>Parent Account</em> (Col T) or <em>Parent Account ID</em> (Col A).
                        Parents are auto-created when <em>Pending Opportunity</em> is not blank.
                    </p>
                    <div class="import-field-list">
                        <strong>Expected columns:</strong> Parent Account ID, Account Owner, Account Name, Active Account Contract, Pending Opportunity, Renewal Status, Service Zip/Postal Code, Service State/Province, Supplier Applied Payment Number, Account Number, Last Modified Date, Latest Sign Date, Contract Start/End Date, Current Supplier, Gas Utility, Electric Utility, Supplier Annual KWH/DTH, Parent Account
                    </div>
                    <div class="import-mode-toggle" id="accountImportMode">
                        <button class="import-mode-btn active" onclick="setImportMode('account','append',this)">üìé Append &amp; Update</button>
                        <button class="import-mode-btn" onclick="setImportMode('account','replace',this)">üîÑ Replace All</button>
                    </div>
                    <div class="import-mode-warn" id="accountReplaceWarn">‚ö†Ô∏è Replace All will <strong>clear all child accounts</strong> from every client and import fresh.</div>
                    <div class="import-zone" id="accountImportZone" onclick="document.getElementById('accountImportFile').click()" style="border-color:#3b82f6;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#3b82f6;margin-bottom:8px;">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="8.5" cy="7" r="4"/>
                            <path d="M20 8v6M23 11h-6"/>
                        </svg>
                        <p><strong>Click to upload</strong> child account data</p>
                        <p style="font-size:0.8rem;">Excel (.xlsx), CSV, or JSON ‚Äî Child Level report</p>
                        <input type="file" id="accountImportFile" accept=".xlsx,.xls,.csv,.json" style="display:none;" onchange="handleAccountFileSelect(event)">
                    </div>
                    <div class="import-options">
                        <label class="import-option"><input type="checkbox" id="optAcctUpdateExisting" checked> Update existing accounts</label>
                        <label class="import-option"><input type="checkbox" id="optCreateOrphans"> Create missing parents (even without Pending Opportunity)</label>
                    </div>
                    <div id="accountImportPreview" style="display:none;margin-top:16px;"></div>
                    <div id="accountImportResults" style="display:none;margin-top:16px;"></div>
                </div>
                
                <!-- Utilization Import -->
                <div style="margin-top:30px;padding-top:24px;border-top:1px solid var(--border);">
                    <h3 style="margin-bottom:12px;font-size:1.1rem;">
                        <span style="background:#10b981;color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;margin-right:8px;">3</span>
                        Import Supplier Utilization
                    </h3>
                    <p style="color:var(--text-secondary);margin-bottom:12px;font-size:0.85rem;">
                        Upload the <strong>Supplier Utilization</strong> report. Records are matched to accounts under each parent via <em>Account #</em> or <em>Supplier Payment Number</em>. Utilization summaries roll up to the parent level automatically.
                    </p>
                    <div class="import-field-list">
                        <strong>Expected columns:</strong> Supplier Payment Number, LDC_Account_No, Account #, LDC Status, Meter Contract: Supplier Applied Payment Number, Parent Account: Account Name, Total Usage, Usage Comm Amount, Start Date, End Date, Parent Account: Account ID
                    </div>
                    <div class="import-mode-toggle" id="utilImportMode">
                        <button class="import-mode-btn active" onclick="setImportMode('util','append',this)">üìé Append &amp; Update</button>
                        <button class="import-mode-btn" onclick="setImportMode('util','replace',this)">üîÑ Replace All</button>
                    </div>
                    <div class="import-mode-warn" id="utilReplaceWarn">‚ö†Ô∏è Replace All will <strong>clear all utilization data</strong> from every account and import fresh.</div>
                    <div class="import-zone" id="utilImportZone" onclick="document.getElementById('utilImportFile').click()" style="border-color:#10b981;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#10b981;margin-bottom:8px;">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                        <p><strong>Click to upload</strong> utilization data</p>
                        <p style="font-size:0.8rem;">Excel (.xlsx), CSV, or JSON ‚Äî Supplier Utilization report</p>
                        <input type="file" id="utilImportFile" accept=".xlsx,.xls,.csv,.json" style="display:none;" onchange="handleUtilFileSelect(event)">
                    </div>
                    <div class="import-options">
                        <label class="import-option"><input type="checkbox" id="optUtilUpdateExisting" checked> Update existing periods</label>
                        <label class="import-option"><input type="checkbox" id="optUtilCreateUnmatched"> Create stub accounts for unmatched</label>
                    </div>
                    <div id="utilImportPreview" style="display:none;margin-top:16px;"></div>
                    <div id="utilImportResults" style="display:none;margin-top:16px;"></div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-create">
            <div class="panel-body" style="max-width:700px;margin:0 auto;">
                <h3 style="margin-bottom:12px;font-size:1.1rem;">Add New Client</h3>
                <form id="createClientForm" onsubmit="handleCreateClient(event)">
                    <div class="detail-section">
                        <div class="detail-section-title">Basic Information</div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Client Name *</label><input type="text" class="form-input" name="name" required></div>
                            <div class="form-group"><label class="form-label">Salesforce ID</label><input type="text" class="form-input" name="salesforceId"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Account Type</label>
                                <select class="form-select" name="accountType">
                                    <option value="Prospect">Prospect</option>
                                    <option value="Customer">Customer</option>
                                    <option value="Former Customer">Former Customer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">Contact</div>
                        <div class="form-group"><label class="form-label">Address</label><input type="text" class="form-input" name="address"></div>
                        <div class="form-row form-row-3">
                            <div class="form-group"><label class="form-label">City</label><input type="text" class="form-input" name="city"></div>
                            <div class="form-group"><label class="form-label">State</label><input type="text" class="form-input" name="state"></div>
                            <div class="form-group"><label class="form-label">ZIP</label><input type="text" class="form-input" name="zip"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" name="phone"></div>
                            <div class="form-group"><label class="form-label">Website</label><input type="url" class="form-input" name="website"></div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">Energy</div>
                        <div class="form-row form-row-3">
                            <div class="form-group">
                                <label class="form-label">ISO</label>
                                <select class="form-select" name="iso">
                                    <option value="">Select...</option>
                                    <option value="PJM">PJM</option>
                                    <option value="ISO-NE">ISO-NE</option>
                                    <option value="NYISO">NYISO</option>
                                    <option value="ERCOT">ERCOT</option>
                                    <option value="MISO">MISO</option>
                                    <option value="CAISO">CAISO</option>
                                </select>
                            </div>
                            <div class="form-group"><label class="form-label">Utility</label><input type="text" class="form-input" name="utility"></div>
                            <div class="form-group"><label class="form-label">Load Zone</label><input type="text" class="form-input" name="loadZone"></div>
                        </div>
                        <div class="form-row form-row-3">
                            <div class="form-group"><label class="form-label">Annual Usage (MWh)</label><input type="number" class="form-input" name="annualUsageMWh" step="0.01"></div>
                            <div class="form-group"><label class="form-label">Contract End Date</label><input type="date" class="form-input" name="contractEndDate"></div>
                            <div class="form-group"><label class="form-label">Current Supplier</label><input type="text" class="form-input" name="currentSupplier"></div>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" name="notes"></textarea></div>
                    <div style="display:flex;gap:8px;">
                        <button type="submit" class="btn btn-primary">Create Client</button>
                        <button type="reset" class="btn btn-secondary">Clear</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="tab-content" id="tab-export">
            <div class="panel-body" style="max-width:600px;margin:0 auto;">
                <h3 style="margin-bottom:12px;font-size:1.1rem;">Export & Save Client Data</h3>
                <p style="color:var(--text-secondary);margin-bottom:24px;font-size:0.85rem;">
                    Client data is stored in <code>data/clients.json</code> on GitHub. 
                    After importing, download the JSON and upload to your repository.
                </p>
                
                <div id="storageInfo" style="background:var(--bg-input);padding:12px;border-radius:8px;margin-bottom:20px;font-size:0.85rem;"></div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="downloadForGitHub()" style="padding:14px;background:#28a745;">
                        ‚¨áÔ∏è Download clients.json<br><span style="font-size:0.75rem;opacity:0.8;">For GitHub upload</span>
                    </button>
                    <button class="btn btn-secondary" onclick="exportClients('csv')" style="padding:14px;">
                        üìä Export as CSV<br><span style="font-size:0.75rem;opacity:0.8;">For Excel/Sheets</span>
                    </button>
                </div>
                
                <div style="border-top:1px solid var(--border);padding-top:16px;margin-top:16px;">
                    <p style="color:var(--text-secondary);font-size:0.8rem;margin-bottom:12px;">
                        <strong>How to save:</strong><br>
                        1. Click "Download clients.json"<br>
                        2. Go to your GitHub repo ‚Üí data folder<br>
                        3. Upload/replace clients.json<br>
                        4. Commit the changes
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="editModal" style="display:none;">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Edit Client</span>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <div class="modal-body" id="editModalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditedClient()">Save</button>
            </div>
        </div>
    </div>

    <script>
        let ClientStore = null;
        let selectedClientId = null;
        let pendingImportData = null;
        let pendingAccountData = null;
        let pendingUtilData = null;
        
        function initStores() {
            if (window.parent?.SecureEnergyClients) {
                ClientStore = window.parent.SecureEnergyClients;
                console.log('[ClientAdmin] Connected to parent SecureEnergyClients');
            } else if (window.SecureEnergyClients) {
                ClientStore = window.SecureEnergyClients;
                console.log('[ClientAdmin] Connected to local SecureEnergyClients');
            } else {
                console.warn('[ClientAdmin] SecureEnergyClients not found!');
            }
            console.log('[ClientAdmin] initStores complete - ClientStore:', !!ClientStore);
            return !!ClientStore;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Try immediately
            if (initStores()) {
                loadClientsWhenReady();
            }
            
            // Also listen for clientsReady event from parent
            window.addEventListener('message', function(e) {
                if (e.data?.type === 'clientsReady' || e.data?.type === 'CLIENTS_LOADED') {
                    console.log('[ClientAdmin] Received clients ready event');
                    if (!ClientStore) initStores();
                    loadClients();
                    updateStats();
                }
            });
            
            // Retry with increasing delays to ensure clients are loaded
            [100, 300, 600, 1000, 2000].forEach(delay => {
                setTimeout(() => {
                    if (initStores()) {
                        const clients = ClientStore.getAllClients();
                        if (clients && clients.length > 0) {
                            console.log('[ClientAdmin] Loaded ' + clients.length + ' clients after ' + delay + 'ms');
                            loadClients();
                            updateStats();
                            updateActiveClientBanner();
                            updateActiveAccountBanner();
                        }
                    }
                }, delay);
            });
            
            // Subscribe to changes
            setTimeout(() => {
                if (ClientStore) {
                    ClientStore.subscribe((e) => { 
                        loadClients(); 
                        updateStats(); 
                        updateActiveClientBanner(); 
                        updateActiveAccountBanner();
                        if (selectedClientId) showClientDetails(selectedClientId);
                    });
                }
            }, 200);
            
            initTabs();
            initSearch();
            initDragDrop();
        });
        
        function loadClientsWhenReady() {
            // Use SecureEnergyClients.onReady if available
            if (ClientStore?.onReady) {
                ClientStore.onReady(() => {
                    console.log('[ClientAdmin] ClientStore ready callback fired');
                    loadClients();
                    updateStats();
                    updateActiveClientBanner();
                    updateActiveAccountBanner();
                });
            } else {
                // Fallback - just try loading
                loadClients();
                updateStats();
                updateActiveClientBanner();
                updateActiveAccountBanner();
            }
        }
        
        window.addEventListener('message', function(e) {
            if (e.data?.type === 'ACTIVE_CLIENT_CHANGED') { 
                updateActiveClientBanner(); 
                loadClients(); 
                // Re-render details if we have a selection
                if (selectedClientId) showClientDetails(selectedClientId);
            }
            if (e.data?.type === 'ACTIVE_ACCOUNT_CHANGED') { 
                updateActiveAccountBanner(); 
                // Re-render details to show updated active state
                if (selectedClientId) showClientDetails(selectedClientId);
            }
        });
        
        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
                    
                    // Update storage info when switching to export tab
                    if (btn.dataset.tab === 'export') {
                        updateStorageInfo();
                    }
                };
            });
        }
        
        function initSearch() {
            const s = document.getElementById('clientSearch');
            let t;
            s.oninput = () => { clearTimeout(t); t = setTimeout(() => loadClients(s.value), 200); };
        }
        
        function initDragDrop() {
            // Parent import zone
            const z = document.getElementById('importZone');
            ['dragenter','dragover'].forEach(e => z.addEventListener(e, ev => { ev.preventDefault(); z.classList.add('dragover'); }));
            ['dragleave','drop'].forEach(e => z.addEventListener(e, ev => { ev.preventDefault(); z.classList.remove('dragover'); }));
            z.addEventListener('drop', ev => { if (ev.dataTransfer.files.length) handleFile(ev.dataTransfer.files[0]); });
            
            // Account import zone
            const az = document.getElementById('accountImportZone');
            if (az) {
                ['dragenter','dragover'].forEach(e => az.addEventListener(e, ev => { ev.preventDefault(); az.classList.add('dragover'); }));
                ['dragleave','drop'].forEach(e => az.addEventListener(e, ev => { ev.preventDefault(); az.classList.remove('dragover'); }));
                az.addEventListener('drop', ev => { if (ev.dataTransfer.files.length) handleAccountFile(ev.dataTransfer.files[0]); });
            }
            
            // Utilization import zone
            const uz = document.getElementById('utilImportZone');
            if (uz) {
                ['dragenter','dragover'].forEach(e => uz.addEventListener(e, ev => { ev.preventDefault(); uz.classList.add('dragover'); }));
                ['dragleave','drop'].forEach(e => uz.addEventListener(e, ev => { ev.preventDefault(); uz.classList.remove('dragover'); }));
                uz.addEventListener('drop', ev => { if (ev.dataTransfer.files.length) handleUtilFile(ev.dataTransfer.files[0]); });
            }
        }
        
        function loadClients(q = '') {
            if (!ClientStore) return;
            const clients = q ? ClientStore.searchClients(q) : ClientStore.getAllClients();
            const activeId = ClientStore.getActiveClientId();
            const list = document.getElementById('clientList');
            document.getElementById('clientCount').textContent = clients.length + ' clients';
            
            if (!clients.length) {
                list.innerHTML = '<div class="empty-state"><p>' + (q ? 'No matches' : 'No clients yet') + '</p></div>';
                return;
            }
            
            list.innerHTML = clients.map(c => {
                const sel = c.id === selectedClientId;
                const act = c.id === activeId;
                const accountCount = c.accounts?.length || 0;
                // Format usage
                let usageStr = '';
                if (c.aggregates?.totalAnnualKwh) {
                    usageStr = Number(c.aggregates.totalAnnualKwh).toLocaleString() + ' kWh (agg)';
                } else if (c.annualUsageMWh) {
                    usageStr = Number(c.annualUsageMWh).toLocaleString() + ' MWh/yr';
                } else if (c.annualUsageKwh) {
                    usageStr = Number(c.annualUsageKwh).toLocaleString() + ' kWh/yr';
                }
                return '<div class="client-card ' + (sel ? 'selected ' : '') + (act ? 'active-client' : '') + '" onclick="selectClient(\'' + c.id + '\')" ondblclick="setClientActive(\'' + c.id + '\')">' +
                    '<div class="client-name">' + c.name +
                    ' <span class="client-badge badge-' + ((c.contractStatus || c.status || 'active').toLowerCase().replace(/\s+/g, '-')) + '">' + (c.contractStatus || c.status || 'Active') + '</span>' +
                    (c.productCategory ? ' <span class="client-badge badge-iso">' + c.productCategory + '</span>' : '') +
                    (accountCount > 0 ? ' <span class="client-badge" style="background:#3b82f6;color:white;">' + accountCount + ' acct' + (accountCount > 1 ? 's' : '') + '</span>' : '') +
                    (act ? ' <span class="set-active-badge">ACTIVE</span>' : '') +
                    '</div><div class="client-meta">' +
                    (c.currentSupplier ? '<span>Supplier: ' + c.currentSupplier + '</span>' : '') +
                    (usageStr ? '<span>' + usageStr + '</span>' : '') +
                    (c.contractEndDate ? '<span>Ends: ' + c.contractEndDate + '</span>' : '') +
                    '</div></div>';
            }).join('');
        }
        
        function selectClient(id) {
            selectedClientId = id;
            loadClients(document.getElementById('clientSearch').value);
            showClientDetails(id);
            document.getElementById('detailActions').style.display = 'flex';
        }
        
        function showClientDetails(id) {
            const c = ClientStore?.getClient(id);
            if (!c) return;
            const d = document.getElementById('clientDetails');
            
            let usageDisplay = 'N/A';
            if (c.annualUsageMWh) usageDisplay = Number(c.annualUsageMWh).toLocaleString() + ' MWh';
            else if (c.annualUsageKwh) usageDisplay = Number(c.annualUsageKwh).toLocaleString() + ' kWh';
            
            // Aggregates
            let aggregateInfo = '';
            if (c.aggregates && c.aggregates.accountCount > 0) {
                aggregateInfo = '<div class="detail-section" style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;padding:12px;margin-bottom:16px;">' +
                    '<div class="detail-section-title" style="color:#3b82f6;">üìä Aggregated from ' + c.aggregates.accountCount + ' Accounts</div>' +
                    '<div class="detail-grid">' +
                    '<div class="detail-item"><div class="detail-label">Total kWh</div><div class="detail-value">' + (c.aggregates.totalAnnualKwh?.toLocaleString() || 0) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Total MWh</div><div class="detail-value">' + (c.aggregates.totalAnnualMWh?.toLocaleString(undefined, {maximumFractionDigits: 1}) || 0) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Total Dth</div><div class="detail-value">' + (c.aggregates.totalAnnualDth?.toLocaleString() || 0) + '</div></div>' +
                    '</div></div>';
            }
            
            // Utilization summary (parent-level rollup)
            let utilInfo = '';
            const us = c.utilizationSummary;
            if (us && us.totalRecords > 0) {
                const fN = (n) => n != null ? Number(n).toLocaleString(undefined, {maximumFractionDigits: 0}) : '0';
                const fD = (n) => n != null ? Number(n).toLocaleString(undefined, {maximumFractionDigits: 2}) : '0';
                utilInfo = '<div class="detail-section" style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:8px;padding:12px;margin-bottom:16px;">' +
                    '<div class="detail-section-title" style="color:#10b981;">‚ö° Utilization Summary ‚Äî ' + us.accountsWithUtilization + ' of ' + us.totalAccounts + ' accounts (' + us.totalRecords + ' records)</div>' +
                    '<div class="detail-grid">' +
                    '<div class="detail-item"><div class="detail-label">Total Usage</div><div class="detail-value">' + fN(us.totalUsage) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Total Comm Amount</div><div class="detail-value">$' + fD(us.totalCommAmount) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Avg Usage / Acct</div><div class="detail-value">' + fN(us.avgUsagePerAccount) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Avg Comm / Acct</div><div class="detail-value">$' + fD(us.avgCommPerAccount) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">Date Range</div><div class="detail-value">' + (us.startDate || 'N/A') + ' ‚Äî ' + (us.endDate || 'N/A') + '</div></div>' +
                    '</div>' +
                    (us.topAccounts?.length > 0 ? '<div style="margin-top:8px;font-size:0.72rem;color:var(--text-secondary);"><strong>Top accounts:</strong> ' + us.topAccounts.map(a => a.accountName + ' (' + fN(a.totalUsage) + ')').join(', ') + '</div>' : '') +
                    '</div>';
            }
            
            // Contracts table
            let contractsInfo = '';
            const contracts = c.contracts || [];
            if (contracts.length > 0) {
                let rows = '';
                contracts.forEach(ct => {
                    rows += '<tr style="font-size:0.78rem;border-bottom:1px solid var(--border);">' +
                        '<td style="padding:4px 6px;">' + (ct.contractName || ct.opportunityName || 'N/A') + '</td>' +
                        '<td style="padding:4px 6px;">' + (ct.contractStatus || '') + '</td>' +
                        '<td style="padding:4px 6px;">' + (ct.currentSupplier || '') + '</td>' +
                        '<td style="padding:4px 6px;">' + (ct.contractStartDate || '') + '</td>' +
                        '<td style="padding:4px 6px;">' + (ct.contractEndDate || '') + '</td>' +
                        '</tr>';
                });
                contractsInfo = '<div class="detail-section"><div class="detail-section-title">Contracts (' + contracts.length + ')</div>' +
                    '<div style="overflow-x:auto;max-height:180px;overflow-y:auto;">' +
                    '<table style="width:100%;border-collapse:collapse;font-size:0.78rem;">' +
                    '<thead><tr style="background:var(--bg-input);position:sticky;top:0;">' +
                    '<th style="padding:4px 6px;text-align:left;">Name</th>' +
                    '<th style="padding:4px 6px;text-align:left;">Status</th>' +
                    '<th style="padding:4px 6px;text-align:left;">Supplier</th>' +
                    '<th style="padding:4px 6px;text-align:left;">Start</th>' +
                    '<th style="padding:4px 6px;text-align:left;">End</th>' +
                    '</tr></thead><tbody>' + rows + '</tbody></table></div></div>';
            }
            
            // Accounts tree with per-account utilization
            let accountsTree = '';
            const activeAccountId = ClientStore?.getActiveAccountId?.() || null;
            const isActiveClient = ClientStore?.getActiveClientId?.() === c.id;
            
            if (c.accounts && c.accounts.length > 0) {
                accountsTree = '<div class="accounts-section">' +
                    '<div class="accounts-header"><div class="accounts-title">' +
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                    '<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6M23 11h-6"/>' +
                    '</svg>Accounts / Locations (' + c.accounts.length + ')' +
                    '</div></div><div class="account-list">';
                
                c.accounts.forEach((acc, idx) => {
                    const isActiveAccount = activeAccountId === acc.id;
                    // Per-account utilization snippet
                    let accUtilSnippet = '';
                    const accUtil = acc.utilizationSummary;
                    if (accUtil && accUtil.recordCount > 0) {
                        accUtilSnippet = '<div class="account-meta" style="margin-top:4px;color:#10b981;">' +
                            '<span>‚ö° ' + Number(accUtil.totalUsage).toLocaleString(undefined, {maximumFractionDigits:0}) + ' usage</span>' +
                            '<span>$' + Number(accUtil.totalCommAmount).toLocaleString(undefined, {maximumFractionDigits:2}) + ' comm</span>' +
                            '<span>' + accUtil.recordCount + ' periods</span>' +
                            (accUtil.startDate ? '<span>' + accUtil.startDate + ' ‚Äî ' + accUtil.endDate + '</span>' : '') +
                            '</div>';
                    }
                    
                    accountsTree += '<div class="account-card' + (isActiveAccount ? ' active-account' : '') + '">' +
                        '<div class="account-name">' +
                        (acc.accountName || 'Account ' + (idx + 1)) +
                        (acc.accountNumber ? '<span class="client-badge badge-account">#' + acc.accountNumber + '</span>' : '') +
                        (isActiveAccount ? '<span class="client-badge badge-active">ACTIVE</span>' : '') +
                        '</div>' +
                        '<div class="account-meta">' +
                        (acc.serviceZip ? '<span>üìç ' + acc.serviceZip + '</span>' : '') +
                        (acc.electricUtility ? '<span>‚ö° ' + acc.electricUtility + '</span>' : '') +
                        (acc.gasUtility ? '<span>üî• ' + acc.gasUtility + '</span>' : '') +
                        '</div>' +
                        (acc.supplierAnnualKwh || acc.supplierAnnualDth ? 
                            '<div class="account-meta" style="margin-top:4px;">' +
                            (acc.supplierAnnualKwh ? '<span style="color:#10b981;">' + Number(acc.supplierAnnualKwh).toLocaleString() + ' kWh</span>' : '') +
                            (acc.supplierAnnualDth ? '<span style="color:#f59e0b;">' + Number(acc.supplierAnnualDth).toLocaleString() + ' Dth</span>' : '') +
                            '</div>' : '') +
                        accUtilSnippet +
                        '<div class="account-actions">' +
                        (isActiveClient && !isActiveAccount ? 
                            '<button class="btn btn-success btn-sm" onclick="setAccountAsActive(\'' + acc.id + '\')" style="font-size:0.7rem;padding:3px 8px;">Set Active</button>' : '') +
                        (isActiveAccount ? 
                            '<button class="btn btn-secondary btn-sm" onclick="clearActiveAccount()" style="font-size:0.7rem;padding:3px 8px;">Clear Active</button>' : '') +
                        '<button class="btn btn-danger btn-sm" onclick="removeAccount(\'' + c.id + '\',\'' + acc.id + '\')" style="font-size:0.7rem;padding:3px 8px;">Remove</button>' +
                        '</div></div>';
                });
                
                accountsTree += '</div>';
                if (!isActiveClient) {
                    accountsTree += '<div style="margin-top:10px;padding:8px;background:rgba(255,193,7,0.15);border-radius:6px;font-size:0.75rem;color:#d4a200;">' +
                        'üí° Set this client as active to select an account for use in other widgets.</div>';
                }
                accountsTree += '</div>';
            }
            
            d.innerHTML = aggregateInfo + utilInfo +
                '<div class="detail-section"><div class="detail-section-title">Account Info</div>' +
                '<div class="detail-grid">' +
                '<div class="detail-item"><div class="detail-label">Client ID</div><div class="detail-value">' + c.id + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Salesforce ID</div><div class="detail-value ' + (!c.salesforceId ? 'empty' : '') + '">' + (c.salesforceId || 'Not linked') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Parent Account</div><div class="detail-value">' + (c.parentAccountCustomer || c.name || 'N/A') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Status</div><div class="detail-value">' + (c.contractStatus || c.status || 'Active') + '</div></div>' +
                '</div></div>' +
                
                contractsInfo + accountsTree +
                
                '<div class="detail-section"><div class="detail-section-title">Contract Details</div>' +
                '<div class="detail-grid">' +
                '<div class="detail-item"><div class="detail-label">Contract Name</div><div class="detail-value">' + (c.contractName || 'N/A') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Product Category</div><div class="detail-value">' + (c.productCategory || 'N/A') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Contract Start</div><div class="detail-value">' + (c.contractStartDate || 'N/A') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Contract End</div><div class="detail-value">' + (c.contractEndDate || 'N/A') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Sign Date</div><div class="detail-value">' + (c.signDate || 'N/A') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Current Supplier</div><div class="detail-value">' + (c.currentSupplier || 'N/A') + '</div></div>' +
                '</div></div>' +
                
                '<div class="detail-section"><div class="detail-section-title">Usage & Meters</div>' +
                '<div class="detail-grid">' +
                '<div class="detail-item"><div class="detail-label">Annual Usage</div><div class="detail-value">' + usageDisplay + '</div></div>' +
                '<div class="detail-item"><div class="detail-label"># of Meters</div><div class="detail-value">' + (c.numberOfMeters || 'N/A') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Active Meter Count</div><div class="detail-value">' + (c.activeMeterCount || 'N/A') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Contract Margin</div><div class="detail-value">' + (c.contractMargin ? '$' + Number(c.contractMargin).toLocaleString() : 'N/A') + '</div></div>' +
                '</div></div>' +
                
                '<div class="detail-section"><div class="detail-section-title">Energy Details</div>' +
                '<div class="detail-grid">' +
                '<div class="detail-item"><div class="detail-label">ISO</div><div class="detail-value">' + (c.iso || 'N/A') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Utility</div><div class="detail-value">' + (c.utility || 'N/A') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Load Zone</div><div class="detail-value">' + (c.loadZone || 'N/A') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Assigned Group</div><div class="detail-value">' + (c.assignedGroup || 'N/A') + '</div></div>' +
                '</div></div>' +
                
                (c.budaEligible || c.budaNotes ? '<div class="detail-section"><div class="detail-section-title">BUDA Info</div>' +
                '<div class="detail-grid">' +
                '<div class="detail-item"><div class="detail-label">BUDA Eligible</div><div class="detail-value">' + (c.budaEligible || 'N/A') + '</div></div>' +
                '<div class="detail-item" style="grid-column:span 2"><div class="detail-label">BUDA Notes</div><div class="detail-value">' + (c.budaNotes || 'N/A') + '</div></div>' +
                '</div></div>' : '') +
                
                (c.notes ? '<div class="detail-section"><div class="detail-section-title">Notes</div><div style="padding:8px;background:var(--bg-input);border-radius:5px;font-size:0.85rem;">' + c.notes + '</div></div>' : '') +
                '<div style="font-size:0.7rem;color:var(--text-secondary);margin-top:12px;">Created: ' + new Date(c.createdAt).toLocaleDateString() + ' | Updated: ' + new Date(c.updatedAt).toLocaleDateString() + '</div>';
        }
        
        function removeAccount(clientId, accountId) {
            if (confirm('Remove this account from the client?')) {
                if (ClientStore?.removeAccountFromClient) {
                    ClientStore.removeAccountFromClient(clientId, accountId);
                    showClientDetails(clientId);
                    showToast('Account removed', 'info');
                }
            }
        }
        
        function updateStats() {
            if (!ClientStore) return;
            const s = ClientStore.getStats();
            document.getElementById('statTotal').textContent = s.total;
            document.getElementById('statActive').textContent = s.active;
        }
        
        function updateActiveClientBanner() {
            if (!ClientStore) return;
            const c = ClientStore.getActiveClient();
            const b = document.getElementById('activeClientBanner');
            if (c) {
                document.getElementById('activeClientName').textContent = c.name;
                document.getElementById('activeClientMeta').textContent = (c.iso || '') + ' ' + (c.city ? '‚Ä¢ ' + c.city + ', ' + c.state : '') + ' ‚Ä¢ Active for all widgets';
                b.style.display = 'flex';
            } else {
                b.style.display = 'none';
            }
            // Also update account banner
            updateActiveAccountBanner();
        }
        
        function updateActiveAccountBanner() {
            if (!ClientStore) return;
            const acc = ClientStore.getActiveAccount();
            const client = ClientStore.getActiveClient();
            const b = document.getElementById('activeAccountBanner');
            
            if (acc && client) {
                document.getElementById('activeAccountName').textContent = acc.accountName || acc.id;
                document.getElementById('activeAccountParent').textContent = client.name;
                b.style.display = 'flex';
            } else {
                b.style.display = 'none';
            }
        }
        
        function setSelectedAsActive() {
            if (selectedClientId && ClientStore) {
                ClientStore.setActiveClient(selectedClientId);
                showToast('Client set as active', 'success');
            }
        }
        
        function setClientActive(id) {
            console.log('[ClientAdmin] setClientActive called with id:', id);
            if (ClientStore) {
                console.log('[ClientAdmin] Calling ClientStore.setActiveClient...');
                const result = ClientStore.setActiveClient(id);
                console.log('[ClientAdmin] ClientStore.setActiveClient result:', result);
                showToast('Client set as active', 'success');
            } else {
                console.error('[ClientAdmin] ClientStore not available!');
            }
        }
        
        function setAccountAsActive(accountId) {
            console.log('[ClientAdmin] setAccountAsActive called with accountId:', accountId);
            if (ClientStore && accountId) {
                console.log('[ClientAdmin] Calling ClientStore.setActiveAccount...');
                const result = ClientStore.setActiveAccount(accountId);
                console.log('[ClientAdmin] ClientStore.setActiveAccount result:', result);
                updateActiveAccountBanner();
                // Re-render accounts list to show active state
                if (selectedClientId) {
                    showClientDetails(selectedClientId);
                }
                showToast('Account set as active', 'success');
            } else {
                console.error('[ClientAdmin] Cannot set account - ClientStore:', !!ClientStore, 'accountId:', accountId);
            }
        }
        
        function clearActiveClient() {
            if (ClientStore) {
                ClientStore.clearActiveClient();
                showToast('Active client cleared', 'info');
            }
        }
        
        function clearActiveAccount() {
            if (ClientStore) {
                ClientStore.clearActiveAccount();
                updateActiveAccountBanner();
                // Re-render accounts list to show cleared state
                if (selectedClientId) {
                    showClientDetails(selectedClientId);
                }
                showToast('Active account cleared', 'info');
            }
        }
        
        function editSelectedClient() {
            if (!selectedClientId || !ClientStore) return;
            const c = ClientStore.getClient(selectedClientId);
            if (!c) return;
            const m = document.getElementById('editModalBody');
            m.innerHTML = '<form id="editForm">' +
                '<input type="hidden" name="id" value="' + c.id + '">' +
                '<div class="form-row"><div class="form-group"><label class="form-label">Name</label><input class="form-input" name="name" value="' + (c.name || '') + '"></div>' +
                '<div class="form-group"><label class="form-label">Salesforce ID</label><input class="form-input" name="salesforceId" value="' + (c.salesforceId || '') + '"></div></div>' +
                '<div class="form-row"><div class="form-group"><label class="form-label">City</label><input class="form-input" name="city" value="' + (c.city || '') + '"></div>' +
                '<div class="form-group"><label class="form-label">State</label><input class="form-input" name="state" value="' + (c.state || '') + '"></div></div>' +
                '<div class="form-row"><div class="form-group"><label class="form-label">ISO</label><input class="form-input" name="iso" value="' + (c.iso || '') + '"></div>' +
                '<div class="form-group"><label class="form-label">Annual Usage (MWh)</label><input class="form-input" name="annualUsageMWh" value="' + (c.annualUsageMWh || '') + '"></div></div>' +
                '<div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" name="notes">' + (c.notes || '') + '</textarea></div>' +
                '</form>';
            document.getElementById('editModal').style.display = 'flex';
        }
        
        function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }
        
        function saveEditedClient() {
            const f = document.getElementById('editForm');
            const d = new FormData(f);
            const u = {};
            d.forEach((v, k) => { if (k !== 'id') u[k] = v; });
            ClientStore.updateClient(d.get('id'), u);
            closeEditModal();
            selectClient(d.get('id'));
            showToast('Client updated', 'success');
        }
        
        function deleteSelectedClient() {
            if (!selectedClientId || !ClientStore) return;
            if (confirm('Delete this client?')) {
                ClientStore.deleteClient(selectedClientId);
                selectedClientId = null;
                document.getElementById('detailActions').style.display = 'none';
                document.getElementById('clientDetails').innerHTML = '<div class="empty-state"><p>Select a client</p></div>';
                showToast('Client deleted', 'info');
            }
        }
        
        function handleCreateClient(e) {
            e.preventDefault();
            const f = new FormData(e.target);
            const d = {};
            f.forEach((v, k) => d[k] = v);
            const c = ClientStore.createClient(d);
            e.target.reset();
            document.querySelector('[data-tab="clients"]').click();
            selectClient(c.id);
            showToast('Client created', 'success');
        }
        
        function handleFileSelect(e) { if (e.target.files.length) handleFile(e.target.files[0]); }
        
        function handleFile(file) {
            console.log('[ClientAdmin] handleFile called with:', file.name, file.type, file.size, 'bytes');
            
            const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
            const isCSV = file.name.endsWith('.csv');
            const isJSON = file.name.endsWith('.json');
            
            console.log('[ClientAdmin] File type detection:', { isExcel, isCSV, isJSON });
            
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    let data;
                    
                    if (isJSON) {
                        // Parse JSON directly
                        data = JSON.parse(e.target.result);
                        console.log('[ClientAdmin] Parsed JSON:', data);
                    } else if (isExcel) {
                        // Parse Excel using SheetJS
                        console.log('[ClientAdmin] Parsing Excel file...');
                        const workbook = XLSX.read(e.target.result, { type: 'array' });
                        console.log('[ClientAdmin] Workbook sheets:', workbook.SheetNames);
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        // Convert to JSON array with headers
                        data = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                        console.log('[ClientAdmin] Parsed Excel, rows:', data.length);
                        if (data.length > 0) {
                            console.log('[ClientAdmin] Headers:', Object.keys(data[0]));
                            console.log('[ClientAdmin] First row data:', data[0]);
                        } else {
                            console.log('[ClientAdmin] WARNING: No data rows found in Excel file!');
                        }
                    } else if (isCSV) {
                        // Parse CSV using SheetJS for consistency
                        console.log('[ClientAdmin] Parsing CSV file...');
                        const workbook = XLSX.read(e.target.result, { type: 'string' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        data = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                        console.log('[ClientAdmin] Parsed CSV, rows:', data.length);
                    } else {
                        // Try to parse as CSV text fallback
                        console.log('[ClientAdmin] Unknown file type, treating as text');
                        data = e.target.result;
                    }
                    
                    pendingImportData = data;
                    const count = Array.isArray(data) ? data.length : 1;
                    
                    console.log('[ClientAdmin] pendingImportData set with', count, 'records');
                    
                    // Show preview with field mapping info
                    let fieldPreview = '';
                    if (Array.isArray(data) && data.length > 0) {
                        const headers = Object.keys(data[0]);
                        fieldPreview = '<div style="margin-top:10px;font-size:0.8rem;color:var(--text-secondary);">' +
                            '<strong>Detected columns:</strong> ' + headers.slice(0, 5).join(', ') + 
                            (headers.length > 5 ? '... (+' + (headers.length - 5) + ' more)' : '') +
                            '</div>';
                    } else if (count === 0) {
                        fieldPreview = '<div style="margin-top:10px;font-size:0.8rem;color:#dc3545;">' +
                            '<strong>Warning:</strong> No data rows found in file. Make sure your file has data below the header row.' +
                            '</div>';
                    }
                    
                    document.getElementById('importPreview').innerHTML = '<div style="padding:12px;background:var(--bg-input);border-radius:6px;">' +
                        '<strong>' + (count > 0 ? '‚úì' : '‚ö†') + ' Ready to import:</strong> ' + count + ' records from ' + file.name + fieldPreview +
                        '<div style="margin-top:12px;">' +
                        '<button class="btn btn-primary" onclick="executeImport()"' + (count === 0 ? ' disabled' : '') + '>Import Now</button> ' +
                        '<button class="btn btn-secondary" onclick="cancelImport()">Cancel</button></div></div>';
                    document.getElementById('importPreview').style.display = 'block';
                } catch (err) {
                    console.error('[ClientAdmin] Parse error:', err);
                    showToast('Error parsing file: ' + err.message, 'error');
                }
            };
            
            r.onerror = (err) => {
                console.error('[ClientAdmin] FileReader error:', err);
                showToast('Error reading file', 'error');
            };
            
            // Read as ArrayBuffer for Excel, text for others
            if (isExcel) {
                console.log('[ClientAdmin] Reading as ArrayBuffer');
                r.readAsArrayBuffer(file);
            } else {
                console.log('[ClientAdmin] Reading as Text');
                r.readAsText(file);
            }
        }
        
        // Import mode state
        let parentImportMode = 'append';
        let accountImportMode = 'append';
        let utilImportMode = 'append';

        function setImportMode(type, mode, btn) {
            if (type === 'parent') {
                parentImportMode = mode;
                document.getElementById('parentReplaceWarn').classList.toggle('visible', mode === 'replace');
            } else if (type === 'account') {
                accountImportMode = mode;
                document.getElementById('accountReplaceWarn').classList.toggle('visible', mode === 'replace');
            } else if (type === 'util') {
                utilImportMode = mode;
                document.getElementById('utilReplaceWarn').classList.toggle('visible', mode === 'replace');
            }
            btn.parentElement.querySelectorAll('.import-mode-btn').forEach(b => b.classList.remove('active', 'danger'));
            btn.classList.add('active');
            if (mode === 'replace') btn.classList.add('danger');
        }

        function executeImport() {
            console.log('[ClientAdmin] executeImport called');
            
            if (!pendingImportData) {
                showToast('No data to import', 'error');
                return;
            }
            
            if (!ClientStore) {
                showToast('Client store not available - try refreshing the page', 'error');
                return;
            }
            
            const isReplace = parentImportMode === 'replace';
            if (isReplace && !confirm('‚ö†Ô∏è REPLACE ALL will delete all existing clients and import fresh.\n\nThis cannot be undone. Continue?')) return;
            
            const opts = {
                updateExisting: document.getElementById('optUpdateExisting').checked,
                matchByName: document.getElementById('optMatchByName').checked,
                replaceAll: isReplace
            };
            
            console.log('[ClientAdmin] Import options:', opts);
            console.log('[ClientAdmin] Calling importFromSalesforce with', Array.isArray(pendingImportData) ? pendingImportData.length : 1, 'records');
            
            try {
                const r = ClientStore.importFromSalesforce(pendingImportData, opts);
                
                console.log('[ClientAdmin] Import result:', r);
                
                let resultHtml = '<div style="padding:12px;background:var(--bg-input);border-radius:6px;">' +
                    '<strong>Import Complete</strong><br>' +
                    'Imported: ' + r.imported + '<br>' +
                    'Updated: ' + r.updated + '<br>' +
                    'Skipped: ' + r.skipped;
                
                if (r.contracts > 0) {
                    resultHtml += '<br>Contracts mapped: ' + r.contracts;
                }
                
                if (r.errors && r.errors.length > 0) {
                    resultHtml += '<br><br><strong style="color:#dc3545;">Errors (' + r.errors.length + '):</strong><br>';
                    resultHtml += '<div style="max-height:150px;overflow-y:auto;font-size:0.8rem;color:#dc3545;">';
                    r.errors.forEach(err => {
                        resultHtml += err + '<br>';
                    });
                    resultHtml += '</div>';
                }
                
                resultHtml += '</div>';
                
                document.getElementById('importResults').innerHTML = resultHtml;
                document.getElementById('importResults').style.display = 'block';
                document.getElementById('importPreview').style.display = 'none';
                
                loadClients();
                updateStats();
                
                if (r.imported > 0 || r.updated > 0) {
                    showToast((isReplace ? 'Replaced: ' : 'Imported ') + r.imported + ' new, updated ' + r.updated, 'success');
                } else if (r.skipped > 0) {
                    showToast('All ' + r.skipped + ' records skipped - check errors', 'warning');
                }
                
            } catch (e) {
                console.error('[ClientAdmin] Import error:', e);
                showToast('Import failed: ' + e.message, 'error');
            }
            
            pendingImportData = null;
            document.getElementById('importFile').value = '';
        }
        
        function cancelImport() {
            pendingImportData = null;
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importFile').value = '';
        }
        
        // ========================================
        // Account Enrichment Import
        // ========================================
        
        function handleAccountFileSelect(e) { 
            if (e.target.files.length) handleAccountFile(e.target.files[0]); 
        }
        
        function handleAccountFile(file) {
            console.log('[ClientAdmin] handleAccountFile called with:', file.name);
            
            const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
            const isCSV = file.name.endsWith('.csv');
            const isJSON = file.name.endsWith('.json');
            
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    let data;
                    
                    if (isJSON) {
                        data = JSON.parse(e.target.result);
                    } else if (isExcel) {
                        const workbook = XLSX.read(e.target.result, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        data = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                        console.log('[ClientAdmin] Parsed account Excel, rows:', data.length);
                    } else if (isCSV) {
                        const workbook = XLSX.read(e.target.result, { type: 'string' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        data = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                    } else {
                        data = e.target.result;
                    }
                    
                    pendingAccountData = data;
                    const count = Array.isArray(data) ? data.length : 1;
                    
                    // Check for Parent Account column
                    let hasParentColumn = false;
                    let fieldPreview = '';
                    if (Array.isArray(data) && data.length > 0) {
                        const headers = Object.keys(data[0]);
                        hasParentColumn = headers.some(h => h.toLowerCase().includes('parent'));
                        fieldPreview = '<div style="margin-top:10px;font-size:0.8rem;color:var(--text-secondary);">' +
                            '<strong>Detected columns:</strong> ' + headers.slice(0, 5).join(', ') + 
                            (headers.length > 5 ? '... (+' + (headers.length - 5) + ' more)' : '') +
                            '</div>';
                        
                        if (!hasParentColumn) {
                            fieldPreview += '<div style="margin-top:8px;padding:8px;background:rgba(220,53,69,0.2);border-radius:4px;color:#dc3545;font-size:0.8rem;">' +
                                '‚ö†Ô∏è Warning: No "Parent Account" column detected. Accounts need a parent to link to.' +
                                '</div>';
                        }
                    }
                    
                    document.getElementById('accountImportPreview').innerHTML = '<div style="padding:12px;background:var(--bg-input);border-radius:6px;">' +
                        '<strong>' + (count > 0 && hasParentColumn ? '‚úì' : '‚ö†') + ' Ready to import:</strong> ' + count + ' account records from ' + file.name + fieldPreview +
                        '<div style="margin-top:12px;">' +
                        '<button class="btn btn-primary" onclick="executeAccountImport()" style="background:#3b82f6;">Import Accounts</button> ' +
                        '<button class="btn btn-secondary" onclick="cancelAccountImport()">Cancel</button></div></div>';
                    document.getElementById('accountImportPreview').style.display = 'block';
                } catch (err) {
                    console.error('[ClientAdmin] Account parse error:', err);
                    showToast('Error parsing file: ' + err.message, 'error');
                }
            };
            
            if (isExcel) {
                r.readAsArrayBuffer(file);
            } else {
                r.readAsText(file);
            }
        }
        
        function executeAccountImport() {
            console.log('[ClientAdmin] executeAccountImport called');
            
            if (!pendingAccountData) {
                showToast('No account data to import', 'error');
                return;
            }
            
            if (!ClientStore) {
                showToast('Client store not available', 'error');
                return;
            }
            
            if (!ClientStore.importAccounts) {
                showToast('Account import not supported - update client-store.js', 'error');
                return;
            }
            
            const isReplace = accountImportMode === 'replace';
            if (isReplace && !confirm('‚ö†Ô∏è REPLACE ALL will clear all child accounts from every client and import fresh.\n\nThis cannot be undone. Continue?')) return;
            
            const opts = {
                updateExisting: document.getElementById('optAcctUpdateExisting')?.checked,
                createOrphans: document.getElementById('optCreateOrphans')?.checked,
                replaceAll: isReplace
            };
            
            try {
                const r = ClientStore.importAccounts(pendingAccountData, opts);
                
                let resultHtml = '<div style="padding:12px;background:var(--bg-input);border-radius:6px;">' +
                    '<strong>Account Import Complete</strong><br>' +
                    '‚úì Added: ' + r.imported + ' accounts<br>' +
                    '‚Üª Updated: ' + r.updated + '<br>' +
                    '‚äò Skipped: ' + r.skipped + '<br>' +
                    '‚ö† Orphaned (no parent): ' + r.orphaned;
                
                if (r.parentsCreated > 0) {
                    resultHtml += '<br><span style="color:var(--accent);">+ ' + r.parentsCreated + ' parents auto-created (Pending Opportunity)</span>';
                }
                
                if (r.errors && r.errors.length > 0) {
                    resultHtml += '<br><br><strong style="color:#dc3545;">Errors (' + r.errors.length + '):</strong>';
                    resultHtml += '<div style="max-height:100px;overflow-y:auto;font-size:0.75rem;color:#dc3545;margin-top:4px;">';
                    r.errors.slice(0, 10).forEach(err => { resultHtml += err + '<br>'; });
                    if (r.errors.length > 10) resultHtml += '... and ' + (r.errors.length - 10) + ' more';
                    resultHtml += '</div>';
                }
                
                resultHtml += '</div>';
                
                document.getElementById('accountImportResults').innerHTML = resultHtml;
                document.getElementById('accountImportResults').style.display = 'block';
                document.getElementById('accountImportPreview').style.display = 'none';
                
                loadClients();
                updateStats();
                
                if (r.imported > 0 || r.updated > 0) {
                    showToast((isReplace ? 'Replaced: ' : '') + r.imported + ' accounts imported, ' + r.updated + ' updated', 'success');
                }
                
            } catch (e) {
                console.error('[ClientAdmin] Account import error:', e);
                showToast('Import failed: ' + e.message, 'error');
            }
            
            pendingAccountData = null;
            document.getElementById('accountImportFile').value = '';
        }
        
        function cancelAccountImport() {
            pendingAccountData = null;
            document.getElementById('accountImportPreview').style.display = 'none';
            document.getElementById('accountImportFile').value = '';
        }
        
        // ========================================
        // Utilization Import (Step 3)
        // ========================================
        
        function handleUtilFileSelect(e) { 
            if (e.target.files.length) handleUtilFile(e.target.files[0]); 
        }
        
        function handleUtilFile(file) {
            console.log('[ClientAdmin] handleUtilFile called with:', file.name);
            const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
            const isCSV = file.name.endsWith('.csv');
            const isJSON = file.name.endsWith('.json');
            
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    let data;
                    if (isJSON) { data = JSON.parse(e.target.result); }
                    else if (isExcel) {
                        const workbook = XLSX.read(e.target.result, { type: 'array' });
                        data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: '' });
                    } else if (isCSV) {
                        const workbook = XLSX.read(e.target.result, { type: 'string' });
                        data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: '' });
                    }
                    
                    pendingUtilData = data;
                    const count = Array.isArray(data) ? data.length : 1;
                    document.getElementById('utilImportPreview').innerHTML = 
                        '<div style="padding:12px;background:var(--bg-input);border-radius:6px;">' +
                        '<strong>' + count + '</strong> utilization records ready from <em>' + file.name + '</em>' +
                        '<div style="margin-top:12px;">' +
                        '<button class="btn btn-primary" onclick="executeUtilImport()" style="background:#10b981;">Import Utilization</button> ' +
                        '<button class="btn btn-ghost" onclick="cancelUtilImport()">Cancel</button></div></div>';
                    document.getElementById('utilImportPreview').style.display = 'block';
                } catch (err) {
                    console.error('[ClientAdmin] Util parse error:', err);
                    showToast('Error parsing file: ' + err.message, 'error');
                }
            };
            if (isExcel) r.readAsArrayBuffer(file); else r.readAsText(file);
        }
        
        function executeUtilImport() {
            if (!pendingUtilData) { showToast('No utilization data to import', 'error'); return; }
            if (!ClientStore || !ClientStore.importUtilization) { showToast('Utilization import not supported - update client-store.js to v2.7+', 'error'); return; }
            
            const isReplace = utilImportMode === 'replace';
            if (isReplace && !confirm('‚ö†Ô∏è REPLACE ALL will clear all utilization data from every account and import fresh.\n\nThis cannot be undone. Continue?')) return;
            
            const opts = {
                updateExisting: document.getElementById('optUtilUpdateExisting')?.checked,
                createUnmatched: document.getElementById('optUtilCreateUnmatched')?.checked,
                replaceAll: isReplace
            };
            
            try {
                const r = ClientStore.importUtilization(pendingUtilData, opts);
                let resultHtml = '<div style="padding:12px;background:var(--bg-input);border-radius:6px;">' +
                    '<strong>Utilization Import Complete</strong><br>' +
                    '‚úì Imported: ' + r.imported + '<br>' +
                    '‚Üª Updated: ' + r.updated + '<br>' +
                    '‚äò Skipped: ' + r.skipped + '<br>' +
                    'üìä Parents updated: ' + r.parentsUpdated;
                if (r.orphanedParents > 0) resultHtml += '<br><span style="color:#dc3545;">‚ö† Orphaned parents: ' + r.orphanedParents + '</span>';
                if (r.orphanedAccounts > 0) resultHtml += '<br><span style="color:#f59e0b;">‚ö† Unmatched accounts: ' + r.orphanedAccounts + '</span>';
                if (r.errors?.length > 0) {
                    resultHtml += '<br><br><strong style="color:#dc3545;">Errors (' + r.errors.length + '):</strong>';
                    resultHtml += '<div style="max-height:100px;overflow-y:auto;font-size:0.75rem;color:#dc3545;margin-top:4px;">';
                    r.errors.slice(0, 10).forEach(err => { resultHtml += err + '<br>'; });
                    if (r.errors.length > 10) resultHtml += '... and ' + (r.errors.length - 10) + ' more';
                    resultHtml += '</div>';
                }
                resultHtml += '</div>';
                document.getElementById('utilImportResults').innerHTML = resultHtml;
                document.getElementById('utilImportResults').style.display = 'block';
                document.getElementById('utilImportPreview').style.display = 'none';
                loadClients();
                updateStats();
                if (selectedClientId) showClientDetails(selectedClientId);
                showToast((isReplace ? 'Replaced: ' : '') + r.imported + ' utilization records, ' + r.parentsUpdated + ' parents updated', 'success');
            } catch (e) {
                console.error('[ClientAdmin] Util import error:', e);
                showToast('Import failed: ' + e.message, 'error');
            }
            pendingUtilData = null;
            document.getElementById('utilImportFile').value = '';
        }
        
        function cancelUtilImport() {
            pendingUtilData = null;
            document.getElementById('utilImportPreview').style.display = 'none';
            document.getElementById('utilImportFile').value = '';
        }
        
        function downloadForGitHub() {
            if (!ClientStore) {
                showToast('Client store not available', 'error');
                return;
            }
            
            if (ClientStore.downloadClientsJSON) {
                ClientStore.downloadClientsJSON();
                showToast('Downloaded clients.json - upload to GitHub data/ folder', 'success');
            } else if (ClientStore.exportForGitHub) {
                const data = ClientStore.exportForGitHub();
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'clients.json';
                a.click();
                URL.revokeObjectURL(url);
                showToast('Downloaded clients.json - upload to GitHub data/ folder', 'success');
            } else {
                exportClients('json');
            }
        }
        
        function updateStorageInfo() {
            const infoDiv = document.getElementById('storageInfo');
            if (!infoDiv || !ClientStore) return;
            
            const info = ClientStore.getStorageInfo ? ClientStore.getStorageInfo() : { clientCount: 0, accountCount: 0, sizeKB: 0 };
            const hasChanges = ClientStore.hasUnsavedChanges ? ClientStore.hasUnsavedChanges() : false;
            
            infoDiv.innerHTML = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center;">' +
                '<div><div style="font-size:1.5rem;font-weight:bold;color:var(--accent);">' + (info.clientCount || 0) + '</div><div style="font-size:0.75rem;color:var(--text-secondary);">Clients</div></div>' +
                '<div><div style="font-size:1.5rem;font-weight:bold;color:#3b82f6;">' + (info.accountCount || 0) + '</div><div style="font-size:0.75rem;color:var(--text-secondary);">Accounts</div></div>' +
                '<div><div style="font-size:1.5rem;font-weight:bold;color:#10b981;">' + (info.sizeKB || 0) + '</div><div style="font-size:0.75rem;color:var(--text-secondary);">KB</div></div>' +
                '</div>' +
                (hasChanges ? '<div style="margin-top:10px;padding:8px;background:rgba(255,193,7,0.2);border-radius:4px;color:#d4a200;font-size:0.8rem;text-align:center;">‚ö†Ô∏è Unsaved changes - download JSON to save</div>' : '');
        }
        
        function exportClients(fmt) {
            if (!ClientStore) return;
            const data = ClientStore.exportClients(fmt);
            const blob = new Blob([data], { type: fmt === 'json' ? 'application/json' : 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'clients.' + fmt;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Export complete', 'success');
        }
        
        function syncToGitHub() {
            if (ClientStore?.syncToGitHub) {
                ClientStore.syncToGitHub().then(ok => showToast(ok ? 'Synced to GitHub' : 'Sync failed', ok ? 'success' : 'error'));
            } else {
                showToast('GitHub sync not available', 'error');
            }
        }
        
        function showToast(msg, type) {
            const t = document.createElement('div');
            t.className = 'toast ' + type;
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
