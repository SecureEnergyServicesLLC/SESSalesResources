<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Lookup</title>
    <style>
        :root {
            --primary: #003366;
            --accent: #FF6B35;
            --success: #28a745;
            --account-active: #3b82f6;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-input: #0f1629;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --border: #2d3748;
            --profile-active: #0d9488;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            padding: 12px;
            min-height: 100%;
        }
        .widget-container {
            background: var(--bg-card);
            border-radius: 10px;
            overflow: visible;
        }
        .widget-header {
            background: linear-gradient(135deg, var(--primary) 0%, #004080 100%);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }
        .widget-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .widget-body { 
            padding: 14px; 
            position: relative;
        }
        
        /* Active Client Banner */
        .active-client-banner {
            background: linear-gradient(135deg, rgba(40,167,69,0.15) 0%, rgba(40,167,69,0.05) 100%);
            border: 1px solid var(--success);
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 12px;
        }
        .active-client-banner.has-account {
            background: linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(59,130,246,0.05) 100%);
            border-color: var(--account-active);
        }
        .active-label {
            font-size: 0.65rem;
            color: var(--success);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .active-client-banner.has-account .active-label {
            color: var(--account-active);
        }
        .active-name {
            font-size: 1.05rem;
            font-weight: 600;
            margin-bottom: 4px;
            word-wrap: break-word;
        }
        .active-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .banner-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        /* Active Account Banner (below client) */
        .active-account-banner {
            background: linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(59,130,246,0.05) 100%);
            border: 1px solid var(--account-active);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .active-account-info {
            flex: 1;
            min-width: 0;
        }
        .active-account-label {
            font-size: 0.6rem;
            color: var(--account-active);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .active-account-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--account-active);
            word-wrap: break-word;
        }
        .active-account-parent {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* Accounts Section (within client selection) */
        .accounts-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .accounts-header {
            font-size: 0.7rem;
            color: var(--account-active);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .accounts-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .account-card {
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.15s;
        }
        .account-card:hover {
            border-color: rgba(59,130,246,0.5);
            background: rgba(59,130,246,0.05);
        }
        .account-card.active-account {
            border-color: var(--account-active);
            background: rgba(59,130,246,0.15);
        }
        .account-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }
        .account-card-info {
            flex: 1;
            min-width: 0;
        }
        .account-card-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 2px;
            word-wrap: break-word;
        }
        .account-card-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .account-card-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        .account-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 600;
            background: rgba(59,130,246,0.3);
            color: var(--account-active);
        }
        
        .no-client {
            background: var(--bg-input);
            border: 1px dashed var(--border);
            border-radius: 8px;
            padding: 20px 16px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        /* Search and Dropdown */
        .search-container {
            position: relative;
            margin-bottom: 12px;
            z-index: 100;
        }
        .search-input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .search-input:focus { 
            outline: none; 
            border-color: var(--accent); 
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }
        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 350px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        .dropdown-item {
            padding: 12px 14px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: rgba(255,107,53,0.1); }
        .dropdown-item.selected { background: rgba(40,167,69,0.15); }
        .dropdown-item-name {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 4px;
            word-wrap: break-word;
            line-height: 1.3;
        }
        .dropdown-item-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            word-wrap: break-word;
        }
        .dropdown-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }
        
        /* Buttons */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.7rem;
        }
        .btn-clear {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .btn-clear:hover { 
            background: var(--bg-input); 
            color: var(--text-primary); 
        }
        .btn-success {
            background: rgba(40,167,69,0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .btn-success:hover { background: rgba(40,167,69,0.3); }
        .btn-primary {
            background: rgba(59,130,246,0.2);
            color: var(--account-active);
            border: 1px solid var(--account-active);
        }
        .btn-primary:hover { background: rgba(59,130,246,0.3); }
        .btn-profile {
            background: rgba(13,148,136,0.2);
            color: var(--profile-active);
            border: 1px solid var(--profile-active);
        }
        .btn-profile:hover { background: rgba(13,148,136,0.3); }
        
        /* Badges */
        .client-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 600;
            background: rgba(0,51,102,0.3);
            color: #4da6ff;
        }
        .accounts-count-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 600;
            background: rgba(59,130,246,0.2);
            color: var(--account-active);
        }
        .has-profile-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--profile-active);
            vertical-align: middle;
        }
        
        /* Usage Profile Section */
        .usage-profile-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .usage-profile-display {
            background: linear-gradient(135deg, rgba(13,148,136,0.15) 0%, rgba(13,148,136,0.05) 100%);
            border: 1px solid var(--profile-active);
            border-radius: 8px;
            padding: 10px 12px;
        }
        .usage-profile-label {
            font-size: 0.65rem;
            color: var(--profile-active);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .usage-profile-name {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .usage-profile-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .no-profile {
            background: var(--bg-input);
            border: 1px dashed var(--border);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        .no-profile a {
            color: var(--profile-active);
            cursor: pointer;
            text-decoration: underline;
        }
        .usage-summary {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        .usage-summary-item {
            background: rgba(0,0,0,0.2);
            padding: 6px 10px;
            border-radius: 6px;
            flex: 1;
            text-align: center;
        }
        .usage-summary-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .usage-summary-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-input); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4a5568; }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: var(--success); color: white; }
        .toast.info { background: var(--account-active); color: white; }
        .toast.error { background: #dc3545; color: white; }
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="widget-header">
            <div class="widget-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                Client Lookup
            </div>
        </div>
        <div class="widget-body">
            <!-- Active Client Banner -->
            <div id="activeClientBanner"></div>
            
            <!-- Active Account Banner -->
            <div id="activeAccountBanner"></div>
            
            <!-- Search -->
            <div class="search-container">
                <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" class="search-input" id="searchInput" placeholder="Search clients by name, location, or account..." autocomplete="off">
                <div class="dropdown" id="dropdown" style="display: none;"></div>
            </div>
            
            <!-- Usage Profile Display -->
            <div id="usageProfileDisplay"></div>
        </div>
    </div>

    <script>
        // ========================================
        // STORES AND STATE
        // ========================================
        let ClientStore = null;
        let ProfileStore = null;
        let allClients = [];
        let activeAccount = null;
        let currentUser = null;
        
        // Helper to get context key for storage
        function getContextKey() {
            const client = ClientStore?.getActiveClient();
            if (activeAccount && client) {
                return `${client.id}_${activeAccount.id}`;
            } else if (client) {
                return client.id;
            }
            return null;
        }
        
        // Get display name for current context
        function getContextDisplayName() {
            const client = ClientStore?.getActiveClient();
            if (activeAccount && client) {
                return `${client.name} ‚Üí ${activeAccount.accountName || activeAccount.id}`;
            } else if (client) {
                return client.name;
            }
            return null;
        }
        
        function initStores() {
            // Initialize Client Store
            if (window.parent?.SecureEnergyClients) ClientStore = window.parent.SecureEnergyClients;
            else if (window.SecureEnergyClients) ClientStore = window.SecureEnergyClients;
            
            // Initialize Usage Profile Store
            if (window.parent?.UsageProfileStore) ProfileStore = window.parent.UsageProfileStore;
            else if (window.UsageProfileStore) ProfileStore = window.UsageProfileStore;
            
            return !!ClientStore;
        }
        
        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            // Request current user from parent
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'GET_CURRENT_USER' }, '*');
                window.parent.postMessage({ type: 'REQUEST_ACTIVE_CLIENT' }, '*');
            }
            
            setTimeout(() => {
                if (initStores()) {
                    allClients = ClientStore.getAllClients();
                    
                    // Get active account from store if available
                    activeAccount = ClientStore.getActiveAccount?.() || null;
                    
                    updateActiveClientBanner();
                    updateActiveAccountBanner();
                    updateUsageProfileDisplay();
                    
                    ClientStore.subscribe((event, data) => {
                        allClients = ClientStore.getAllClients();
                        
                        if (event === 'activeClientChanged') {
                            activeAccount = data?.account || null;
                        }
                        if (event === 'activeAccountChanged') {
                            activeAccount = data?.account || null;
                        }
                        
                        updateActiveClientBanner();
                        updateActiveAccountBanner();
                        updateUsageProfileDisplay();
                    });
                    
                    if (ProfileStore) {
                        ProfileStore.subscribe(() => {
                            updateUsageProfileDisplay();
                        });
                    }
                }
                initSearch();
            }, 100);
        });
        
        // ========================================
        // MESSAGE HANDLING
        // ========================================
        window.addEventListener('message', function(e) {
            if (e.data?.type === 'CURRENT_USER') {
                currentUser = e.data.user;
            }
            if (e.data?.type === 'ACTIVE_CLIENT_CHANGED' || e.data?.type === 'ACTIVE_CLIENT_RESPONSE') {
                activeAccount = e.data.account || null;
                updateActiveClientBanner();
                updateActiveAccountBanner();
                updateUsageProfileDisplay();
            }
            if (e.data?.type === 'ACTIVE_ACCOUNT_CHANGED') {
                activeAccount = e.data.account || null;
                updateActiveAccountBanner();
                updateUsageProfileDisplay();
            }
            if (e.data?.type === 'USAGE_PROFILE_CHANGED') {
                updateUsageProfileDisplay();
            }
        });
        
        // ========================================
        // ACTIVE CLIENT BANNER
        // ========================================
        function updateActiveClientBanner() {
            const container = document.getElementById('activeClientBanner');
            const client = ClientStore?.getActiveClient();
            
            if (client) {
                const hasUsageProfile = client.usageProfile && 
                    (client.usageProfile.electric?.some(v => v > 0) || client.usageProfile.gas?.some(v => v > 0));
                const hasAccounts = client.accounts && client.accounts.length > 0;
                const hasActiveAccount = activeAccount !== null;
                
                // Build accounts section HTML
                let accountsHtml = '';
                if (hasAccounts) {
                    const activeAccountId = activeAccount?.id;
                    accountsHtml = `
                        <div class="accounts-section">
                            <div class="accounts-header">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="8.5" cy="7" r="4"/>
                                    <path d="M20 8v6M23 11h-6"/>
                                </svg>
                                Child Accounts (${client.accounts.length})
                            </div>
                            <div class="accounts-list">
                                ${client.accounts.map(acc => `
                                    <div class="account-card${acc.id === activeAccountId ? ' active-account' : ''}">
                                        <div class="account-card-header">
                                            <div class="account-card-info">
                                                <div class="account-card-name">
                                                    ${acc.accountName || 'Unnamed Account'}
                                                    ${acc.id === activeAccountId ? '<span class="account-badge">ACTIVE</span>' : ''}
                                                </div>
                                                <div class="account-card-meta">
                                                    ${acc.accountNumber ? '#' + acc.accountNumber + ' ‚Ä¢ ' : ''}
                                                    ${acc.serviceZip ? 'üìç ' + acc.serviceZip : ''}
                                                    ${acc.electricUtility ? ' ‚Ä¢ ‚ö° ' + acc.electricUtility : ''}
                                                </div>
                                            </div>
                                            <div class="account-card-actions">
                                                ${acc.id === activeAccountId 
                                                    ? '<button class="btn btn-clear btn-sm" onclick="clearActiveAccount()">Clear</button>' 
                                                    : '<button class="btn btn-primary btn-sm" onclick="setAccountAsActive(\'' + acc.id + '\')">Set Active</button>'}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = `
                    <div class="active-client-banner${hasActiveAccount ? ' has-account' : ''}">
                        <div class="active-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            Active Parent Client
                        </div>
                        <div class="active-name">
                            ${client.name}
                            ${client.iso ? '<span class="client-badge">' + client.iso + '</span>' : ''}
                            ${hasUsageProfile ? '<span class="has-profile-indicator" title="Has Usage Profile"></span>' : ''}
                        </div>
                        <div class="active-meta">
                            ${client.city ? client.city + ', ' + client.state : ''}
                            ${client.annualUsageMWh ? ' ‚Ä¢ ' + Number(client.annualUsageMWh).toLocaleString() + ' MWh/yr' : ''}
                            ${hasAccounts ? ' ‚Ä¢ ' + client.accounts.length + ' account' + (client.accounts.length > 1 ? 's' : '') : ''}
                        </div>
                        <div class="banner-actions">
                            <button class="btn btn-clear" onclick="clearActiveClient()">Clear Client</button>
                            ${hasUsageProfile ? '<button class="btn btn-profile" onclick="loadClientProfile()">Load Profile</button>' : ''}
                        </div>
                        ${accountsHtml}
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="no-client">
                        <p style="font-weight: 600; margin-bottom: 4px;">No client selected</p>
                        <p style="font-size: 0.75rem;">Search below to select a parent client, then choose a child account for analysis</p>
                    </div>
                `;
            }
        }
        
        // ========================================
        // ACTIVE ACCOUNT BANNER
        // ========================================
        function updateActiveAccountBanner() {
            const container = document.getElementById('activeAccountBanner');
            const client = ClientStore?.getActiveClient();
            
            if (activeAccount && client) {
                container.innerHTML = `
                    <div class="active-account-banner">
                        <div class="active-account-info">
                            <div class="active-account-label">Active Child Account</div>
                            <div class="active-account-name">${activeAccount.accountName || activeAccount.id}</div>
                            <div class="active-account-parent">‚Üê under ${client.name}</div>
                        </div>
                        <button class="btn btn-clear btn-sm" onclick="clearActiveAccount()">Clear Account</button>
                    </div>
                `;
                container.style.display = 'block';
            } else {
                container.innerHTML = '';
                container.style.display = 'none';
            }
        }
        
        // ========================================
        // CLIENT ACTIONS
        // ========================================
        function setClientAsActive(clientId) {
            if (ClientStore) {
                ClientStore.setActiveClient(clientId);
                activeAccount = null; // Clear account when switching clients
                showToast('Client set as active', 'success');
            }
        }
        
        function clearActiveClient() {
            if (ClientStore) {
                ClientStore.clearActiveClient();
                activeAccount = null;
                showToast('Client cleared', 'info');
            }
        }
        
        function setAccountAsActive(accountId) {
            if (ClientStore && accountId) {
                if (ClientStore.setActiveAccount) {
                    ClientStore.setActiveAccount(accountId);
                } else {
                    // Fallback: manually set and broadcast
                    const client = ClientStore.getActiveClient();
                    if (client?.accounts) {
                        activeAccount = client.accounts.find(a => a.id === accountId) || null;
                        if (window.parent !== window) {
                            window.parent.postMessage({
                                type: 'ACTIVE_ACCOUNT_CHANGED',
                                client: client,
                                clientId: client.id,
                                account: activeAccount,
                                accountId: activeAccount?.id || null
                            }, '*');
                        }
                    }
                }
                updateActiveClientBanner();
                updateActiveAccountBanner();
                showToast('Account set as active', 'success');
            }
        }
        
        function clearActiveAccount() {
            if (ClientStore) {
                if (ClientStore.clearActiveAccount) {
                    ClientStore.clearActiveAccount();
                } else {
                    activeAccount = null;
                    const client = ClientStore.getActiveClient();
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'ACTIVE_ACCOUNT_CHANGED',
                            client: client,
                            clientId: client?.id || null,
                            account: null,
                            accountId: null
                        }, '*');
                    }
                }
                updateActiveClientBanner();
                updateActiveAccountBanner();
                showToast('Account cleared', 'info');
            }
        }
        
        // ========================================
        // SEARCH AND DROPDOWN
        // ========================================
        function initSearch() {
            const input = document.getElementById('searchInput');
            const dropdown = document.getElementById('dropdown');
            let debounceTimer;
            
            input.addEventListener('focus', () => showDropdown());
            input.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => showDropdown(input.value), 150);
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        function showDropdown(query = '') {
            const dropdown = document.getElementById('dropdown');
            const activeId = ClientStore?.getActiveClientId();
            
            let filtered = allClients;
            if (query) {
                const q = query.toLowerCase();
                filtered = allClients.filter(c => 
                    c.name?.toLowerCase().includes(q) ||
                    c.city?.toLowerCase().includes(q) ||
                    c.state?.toLowerCase().includes(q) ||
                    c.iso?.toLowerCase().includes(q) ||
                    c.salesforceId?.toLowerCase().includes(q) ||
                    // Search within accounts
                    c.accounts?.some(a => 
                        a.accountName?.toLowerCase().includes(q) ||
                        a.accountNumber?.toLowerCase().includes(q) ||
                        a.serviceZip?.includes(q)
                    )
                );
            }
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="dropdown-item" style="color: var(--text-secondary); cursor: default;">No clients found</div>';
            } else {
                dropdown.innerHTML = filtered.slice(0, 20).map(c => {
                    const hasProfile = c.usageProfile && 
                        (c.usageProfile.electric?.some(v => v > 0) || c.usageProfile.gas?.some(v => v > 0));
                    const accountCount = c.accounts?.length || 0;
                    
                    return `
                        <div class="dropdown-item ${c.id === activeId ? 'selected' : ''}" onclick="selectClient('${c.id}')">
                            <div class="dropdown-item-name">
                                ${c.name || 'Unnamed Client'}
                            </div>
                            <div class="dropdown-item-meta">
                                ${c.city ? c.city + ', ' + c.state : 'No location'}
                                ${c.annualUsageMWh ? ' ‚Ä¢ ' + Number(c.annualUsageMWh).toLocaleString() + ' MWh/yr' : ''}
                            </div>
                            <div class="dropdown-badges">
                                ${c.iso ? '<span class="client-badge">' + c.iso + '</span>' : ''}
                                ${accountCount > 0 ? '<span class="accounts-count-badge">' + accountCount + ' account' + (accountCount > 1 ? 's' : '') + '</span>' : ''}
                                ${hasProfile ? '<span class="has-profile-indicator" title="Has Usage Profile"></span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            dropdown.style.display = 'block';
        }
        
        function selectClient(id) {
            if (ClientStore) {
                ClientStore.setActiveClient(id);
                activeAccount = null;
                document.getElementById('searchInput').value = '';
                document.getElementById('dropdown').style.display = 'none';
                showToast('Client selected', 'success');
            }
        }
        
        // ========================================
        // USAGE PROFILE
        // ========================================
        function updateUsageProfileDisplay() {
            const container = document.getElementById('usageProfileDisplay');
            if (!container) return;
            
            let activeProfile = null;
            if (ProfileStore) {
                activeProfile = ProfileStore.getActiveProfile();
            }
            
            const client = ClientStore?.getActiveClient();
            const clientHasProfile = client?.usageProfile && 
                (client.usageProfile.electric?.some(v => v > 0) || client.usageProfile.gas?.some(v => v > 0));
            
            if (activeProfile) {
                const electricTotal = activeProfile.electricUsage?.reduce((a, b) => a + b, 0) || 0;
                const gasTotal = activeProfile.gasUsage?.reduce((a, b) => a + b, 0) || 0;
                
                container.innerHTML = `
                    <div class="usage-profile-section">
                        <div class="usage-profile-display">
                            <div class="usage-profile-label">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                                </svg>
                                Active Usage Profile
                            </div>
                            <div class="usage-profile-name">${activeProfile.name}</div>
                            <div class="usage-summary">
                                <div class="usage-summary-item">
                                    <div class="usage-summary-label">Annual Electric</div>
                                    <div class="usage-summary-value">${(electricTotal / 1000).toLocaleString(undefined, {maximumFractionDigits: 0})} MWh</div>
                                </div>
                                ${gasTotal > 0 ? `
                                <div class="usage-summary-item">
                                    <div class="usage-summary-label">Annual Gas</div>
                                    <div class="usage-summary-value">${gasTotal.toLocaleString(undefined, {maximumFractionDigits: 0})} Therms</div>
                                </div>
                                ` : ''}
                            </div>
                            <button class="btn btn-clear" style="margin-top: 10px; width: 100%;" onclick="clearProfile()">Clear Profile</button>
                        </div>
                    </div>
                `;
            } else if (clientHasProfile) {
                const electricTotal = client.usageProfile.electric?.reduce((a, b) => a + b, 0) || 0;
                
                container.innerHTML = `
                    <div class="usage-profile-section">
                        <div class="no-profile">
                            <p>‚ö° Client has usage data available</p>
                            <p style="margin-top: 6px;">
                                <a onclick="loadClientProfile()">Click to load ${(electricTotal / 1000).toLocaleString(undefined, {maximumFractionDigits: 0})} MWh profile</a>
                            </p>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="usage-profile-section">
                        <div class="no-profile">
                            <p>No usage profile active</p>
                            <p style="font-size: 0.7rem; margin-top: 4px;">
                                Enter usage data in the Energy Utilization widget
                            </p>
                        </div>
                    </div>
                `;
            }
        }
        
        async function loadClientProfile() {
            const client = ClientStore?.getActiveClient();
            if (!client || !client.usageProfile) return;
            
            const displayName = getContextDisplayName() || client.name;
            
            if (ProfileStore) {
                const result = await ProfileStore.createFromClient(client);
                if (result.success && result.profile) {
                    ProfileStore.setActiveProfile(result.profile.id);
                }
            }
            
            const message = {
                type: 'USAGE_PROFILE_LOADED',
                profile: {
                    name: displayName + ' - Usage Profile',
                    clientId: client.id,
                    clientName: client.name,
                    accountId: activeAccount?.id || null,
                    accountName: activeAccount?.accountName || null,
                    contextKey: getContextKey(),
                    electricUsage: client.usageProfile.electric || Array(12).fill(0),
                    gasUsage: client.usageProfile.gas || Array(12).fill(0)
                }
            };
            
            if (window.parent !== window) {
                window.parent.postMessage(message, '*');
            }
            
            updateUsageProfileDisplay();
            showToast('Profile loaded', 'success');
        }
        
        function clearProfile() {
            if (ProfileStore) {
                ProfileStore.clearActiveProfile();
            }
            
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'USAGE_PROFILE_CHANGED', profile: null, profileId: null }, '*');
            }
            
            updateUsageProfileDisplay();
            showToast('Profile cleared', 'info');
        }
        
        // ========================================
        // TOAST NOTIFICATIONS
        // ========================================
        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 2500);
        }
    </script>
</body>
</html>
