<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMP Data Manager | SES Sales Resources</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .nav-back {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
            text-decoration: none;
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        
        .nav-back:hover {
            opacity: 1;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        .status-bar {
            background: white;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
        }
        
        .status-dot.loading {
            background: var(--warning);
            animation: pulse 1s infinite;
        }
        
        .status-dot.error {
            background: var(--danger);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
        }
        
        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .iso-list {
            list-style: none;
        }
        
        .iso-item {
            border-bottom: 1px solid var(--gray-100);
        }
        
        .iso-item:last-child {
            border-bottom: none;
        }
        
        .iso-header {
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .iso-header:hover {
            background: var(--gray-50);
        }
        
        .iso-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .iso-stats {
            font-size: 0.75rem;
            color: var(--gray-600);
        }
        
        .iso-details {
            padding: 0 1.5rem 1rem;
            display: none;
        }
        
        .iso-item.expanded .iso-details {
            display: block;
        }
        
        .iso-item.expanded .iso-header {
            background: var(--gray-50);
        }
        
        .year-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .year-badge {
            padding: 0.25rem 0.5rem;
            background: var(--primary-light);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            text-align: center;
        }
        
        .zone-list {
            margin-top: 1rem;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.8rem;
        }
        
        .zone-item {
            padding: 0.25rem 0;
            color: var(--gray-600);
            border-bottom: 1px solid var(--gray-100);
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.2s;
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
            padding: 1.5rem;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-zone {
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-zone:hover {
            border-color: var(--primary);
            background: var(--gray-50);
        }
        
        .upload-zone.dragover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-light);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-outline {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
        }
        
        .btn-outline:hover {
            background: var(--gray-50);
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .data-table th {
            background: var(--gray-50);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .data-table tbody tr:hover {
            background: var(--gray-50);
        }
        
        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .chart-container {
            height: 300px;
            margin-top: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .form-select,
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .form-select:focus,
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: var(--gray-100);
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .code-block {
            background: var(--gray-800);
            color: #e5e7eb;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .actions-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="../index.html" class="nav-back">‚Üê Back to Portal</a>
        <h1>üìä LMP Data Manager</h1>
        <p>Manage LMP data stored in the GitHub repository</p>
    </div>
    
    <div class="container">
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Initializing...</span>
            </div>
            <div class="status-item">
                <span id="recordCount">-</span>
            </div>
        </div>
        
        <div class="grid">
            <!-- Sidebar: Data Index -->
            <div>
                <div class="card">
                    <div class="card-header">
                        üìÅ Data Repository
                        <button class="btn btn-sm btn-outline" onclick="refreshIndex()">‚Üª Refresh</button>
                    </div>
                    <ul class="iso-list" id="isoList">
                        <li style="padding: 1rem; color: var(--gray-600);">Loading...</li>
                    </ul>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="card">
                <div class="tabs">
                    <div class="tab active" data-tab="browse" onclick="switchTab('browse')">üìã Browse Data</div>
                    <div class="tab" data-tab="add" onclick="switchTab('add')">‚ûï Add Data</div>
                    <div class="tab" data-tab="export" onclick="switchTab('export')">üì§ Export for GitHub</div>
                </div>
                
                <!-- Browse Tab -->
                <div class="tab-content active" id="tab-browse">
                    <div class="form-group">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                            <div>
                                <label class="form-label">ISO</label>
                                <select class="form-select" id="browseISO" onchange="updateBrowseFilters()">
                                    <option value="">Select ISO</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Year</label>
                                <select class="form-select" id="browseYear" onchange="loadBrowseData()">
                                    <option value="">All Years</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Zone</label>
                                <select class="form-select" id="browseZone" onchange="loadBrowseData()">
                                    <option value="">All Zones</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button class="btn btn-primary" onclick="loadBrowseData()">Load Data</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="browseResults" class="hidden">
                        <div class="actions-bar" style="margin-bottom: 1rem;">
                            <button class="btn btn-sm btn-outline" onclick="exportToExcel()">üì• Export to Excel</button>
                            <button class="btn btn-sm btn-outline" onclick="toggleChart()">üìà Toggle Chart</button>
                        </div>
                        
                        <div class="chart-container hidden" id="chartContainer">
                            <canvas id="lmpChart"></canvas>
                        </div>
                        
                        <div class="table-wrapper">
                            <table class="data-table" id="browseTable">
                                <thead>
                                    <tr>
                                        <th>ISO</th>
                                        <th>Year</th>
                                        <th>Month</th>
                                        <th>Zone</th>
                                        <th>Zone Name</th>
                                        <th>Avg DA LMP</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Add Data Tab -->
                <div class="tab-content" id="tab-add">
                    <div class="alert alert-info">
                        <strong>üìå How to add new LMP data:</strong><br>
                        Upload a CSV file with columns: ISO, Year, Month, Zone, Zone_Name, Avg_DA_LMP.<br>
                        The data will be converted to JSON format for adding to the GitHub repository.
                    </div>
                    
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">üìÅ</div>
                        <h3>Drop CSV file here</h3>
                        <p style="color: var(--gray-600); margin-top: 0.5rem;">or click to browse</p>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                    </div>
                    
                    <div id="uploadPreview" class="hidden" style="margin-top: 1.5rem;">
                        <h3 style="margin-bottom: 1rem;">Preview Uploaded Data</h3>
                        <div id="uploadStats" class="alert alert-success"></div>
                        <div class="table-wrapper">
                            <table class="data-table" id="previewTable">
                                <thead>
                                    <tr>
                                        <th>ISO</th>
                                        <th>Year</th>
                                        <th>Month</th>
                                        <th>Zone</th>
                                        <th>Zone Name</th>
                                        <th>Avg DA LMP</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-success" onclick="generateExportFiles()">
                                ‚úì Generate JSON Files for GitHub
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Export Tab -->
                <div class="tab-content" id="tab-export">
                    <div class="alert alert-info">
                        <strong>üìå Export data files for GitHub:</strong><br>
                        Generate JSON files that can be committed directly to your repository's <code>/data/lmp/</code> folder.
                    </div>
                    
                    <div id="exportOptions">
                        <div class="form-group">
                            <label class="form-label">Select ISO to Export</label>
                            <select class="form-select" id="exportISO">
                                <option value="">Select ISO</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Select Years</label>
                            <div class="checkbox-group" id="exportYears"></div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="exportForGitHub()">
                            üì§ Download JSON Files
                        </button>
                    </div>
                    
                    <div id="exportInstructions" class="hidden" style="margin-top: 1.5rem;">
                        <h3>üìã Instructions</h3>
                        <p style="margin: 1rem 0;">After downloading the JSON files:</p>
                        <ol style="margin-left: 1.5rem; color: var(--gray-700);">
                            <li>Extract the ZIP file</li>
                            <li>Copy the files to your repository's <code>/data/lmp/[iso]/</code> folder</li>
                            <li>Update the <code>data-index.json</code> file</li>
                            <li>Commit and push to GitHub</li>
                        </ol>
                        <div class="code-block">
git add data/lmp/
git commit -m "Add LMP data for [ISO] [YEARS]"
git push origin main
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="../scripts/shared-data-store.js"></script>
    <script>
        // Global state
        let currentBrowseData = [];
        let uploadedData = [];
        let lmpChart = null;
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
            setupFileUpload();
        });
        
        async function initializeApp() {
            setStatus('loading', 'Loading data index...');
            
            try {
                await LMPDataStore.init();
                renderISOList();
                populateFilters();
                setStatus('ready', 'Data store ready');
            } catch (error) {
                console.error('Init error:', error);
                setStatus('error', 'Failed to load data index');
            }
        }
        
        function setStatus(state, text) {
            const dot = document.getElementById('statusDot');
            const textEl = document.getElementById('statusText');
            
            dot.className = 'status-dot';
            if (state === 'loading') dot.classList.add('loading');
            if (state === 'error') dot.classList.add('error');
            
            textEl.textContent = text;
        }
        
        function renderISOList() {
            const list = document.getElementById('isoList');
            const index = LMPDataStore.getIndex();
            
            if (!index || !index.isos || Object.keys(index.isos).length === 0) {
                list.innerHTML = '<li style="padding: 1rem; color: var(--gray-600);">No data available. Upload CSV to add data.</li>';
                return;
            }
            
            let totalRecords = 0;
            let html = '';
            
            for (const [isoKey, isoData] of Object.entries(index.isos)) {
                totalRecords += isoData.totalRecords || 0;
                
                html += `
                    <li class="iso-item" data-iso="${isoKey}">
                        <div class="iso-header" onclick="toggleISO('${isoKey}')">
                            <div class="iso-name">
                                ${isoKey === 'isone' ? '‚ö°' : 'üîå'} ${isoData.name}
                            </div>
                            <div class="iso-stats">
                                ${isoData.years?.length || 0} years ¬∑ ${isoData.totalRecords || 0} records
                            </div>
                        </div>
                        <div class="iso-details">
                            <strong>Years:</strong>
                            <div class="year-grid">
                                ${(isoData.years || []).map(y => `<span class="year-badge">${y}</span>`).join('')}
                            </div>
                            <div class="zone-list">
                                <strong>Zones:</strong>
                                ${(isoData.zones || []).map(z => `<div class="zone-item">${z.Zone_Name} (${z.Zone})</div>`).join('')}
                            </div>
                        </div>
                    </li>
                `;
            }
            
            list.innerHTML = html;
            document.getElementById('recordCount').textContent = `${totalRecords.toLocaleString()} total records`;
        }
        
        function toggleISO(iso) {
            const item = document.querySelector(`.iso-item[data-iso="${iso}"]`);
            item.classList.toggle('expanded');
        }
        
        function populateFilters() {
            const isos = LMPDataStore.getISOs();
            
            // Browse filters
            const browseISO = document.getElementById('browseISO');
            const exportISO = document.getElementById('exportISO');
            
            isos.forEach(iso => {
                browseISO.innerHTML += `<option value="${iso}">${iso.toUpperCase()}</option>`;
                exportISO.innerHTML += `<option value="${iso}">${iso.toUpperCase()}</option>`;
            });
            
            // Export ISO change handler
            exportISO.addEventListener('change', updateExportYears);
        }
        
        function updateBrowseFilters() {
            const iso = document.getElementById('browseISO').value;
            const yearSelect = document.getElementById('browseYear');
            const zoneSelect = document.getElementById('browseZone');
            
            // Reset
            yearSelect.innerHTML = '<option value="">All Years</option>';
            zoneSelect.innerHTML = '<option value="">All Zones</option>';
            
            if (!iso) return;
            
            const years = LMPDataStore.getYears(iso);
            const zones = LMPDataStore.getZones(iso);
            
            years.forEach(y => {
                yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
            });
            
            zones.forEach(z => {
                zoneSelect.innerHTML += `<option value="${z.Zone}">${z.Zone_Name}</option>`;
            });
        }
        
        async function loadBrowseData() {
            const iso = document.getElementById('browseISO').value;
            const year = document.getElementById('browseYear').value;
            const zone = document.getElementById('browseZone').value;
            
            if (!iso) {
                alert('Please select an ISO');
                return;
            }
            
            setStatus('loading', 'Loading data...');
            
            const queryOptions = { iso };
            if (year) queryOptions.years = [parseInt(year)];
            if (zone) queryOptions.zones = [zone];
            
            currentBrowseData = await LMPDataStore.query(queryOptions);
            
            // Sort by year, month
            currentBrowseData.sort((a, b) => {
                if (a.Year !== b.Year) return a.Year - b.Year;
                if (a.Month !== b.Month) return a.Month - b.Month;
                return a.Zone.localeCompare(b.Zone);
            });
            
            renderBrowseTable();
            document.getElementById('browseResults').classList.remove('hidden');
            setStatus('ready', `Loaded ${currentBrowseData.length} records`);
        }
        
        function renderBrowseTable() {
            const tbody = document.querySelector('#browseTable tbody');
            tbody.innerHTML = currentBrowseData.map(row => `
                <tr>
                    <td>${row.ISO}</td>
                    <td>${row.Year}</td>
                    <td>${row.Month}</td>
                    <td>${row.Zone}</td>
                    <td>${row.Zone_Name}</td>
                    <td>$${parseFloat(row.Avg_DA_LMP).toFixed(2)}</td>
                </tr>
            `).join('');
        }
        
        function toggleChart() {
            const container = document.getElementById('chartContainer');
            container.classList.toggle('hidden');
            
            if (!container.classList.contains('hidden')) {
                renderChart();
            }
        }
        
        function renderChart() {
            const ctx = document.getElementById('lmpChart').getContext('2d');
            
            if (lmpChart) {
                lmpChart.destroy();
            }
            
            // Group by zone
            const zones = [...new Set(currentBrowseData.map(d => d.Zone))];
            
            // Create datasets
            const datasets = zones.slice(0, 5).map((zone, idx) => {
                const zoneData = currentBrowseData.filter(d => d.Zone === zone);
                const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'];
                
                return {
                    label: zone,
                    data: zoneData.map(d => ({
                        x: `${d.Year}-${String(d.Month).padStart(2, '0')}`,
                        y: d.Avg_DA_LMP
                    })),
                    borderColor: colors[idx],
                    backgroundColor: colors[idx] + '20',
                    tension: 0.3
                };
            });
            
            lmpChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Month' }},
                        y: { title: { display: true, text: 'Avg DA LMP ($/MWh)' }}
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }
        
        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(currentBrowseData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'LMP Data');
            XLSX.writeFile(wb, `lmp_data_export_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
        
        // Tab switching
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }
        
        // File upload
        function setupFileUpload() {
            const zone = document.getElementById('uploadZone');
            const input = document.getElementById('fileInput');
            
            zone.addEventListener('click', () => input.click());
            
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
            
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                handleFile(e.dataTransfer.files[0]);
            });
            
            input.addEventListener('change', (e) => {
                handleFile(e.target.files[0]);
            });
        }
        
        function handleFile(file) {
            if (!file) return;
            
            const reader = new FileReader();
            
            if (file.name.endsWith('.csv')) {
                reader.onload = (e) => parseCSV(e.target.result);
                reader.readAsText(file);
            } else {
                reader.onload = (e) => {
                    const wb = XLSX.read(e.target.result, { type: 'binary' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const csv = XLSX.utils.sheet_to_csv(ws);
                    parseCSV(csv);
                };
                reader.readAsBinaryString(file);
            }
        }
        
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/\r/g, ''));
            
            uploadedData = lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/\r/g, ''));
                const row = {};
                headers.forEach((h, i) => row[h] = values[i]);
                return row;
            }).filter(row => row.ISO && row.Year);
            
            // Show preview
            const stats = {};
            uploadedData.forEach(row => {
                const key = `${row.ISO}-${row.Year}`;
                stats[key] = (stats[key] || 0) + 1;
            });
            
            document.getElementById('uploadStats').innerHTML = `
                <strong>Uploaded ${uploadedData.length} records</strong><br>
                ${Object.entries(stats).map(([k, v]) => `${k}: ${v} records`).join(' ¬∑ ')}
            `;
            
            const tbody = document.querySelector('#previewTable tbody');
            tbody.innerHTML = uploadedData.slice(0, 50).map(row => `
                <tr>
                    <td>${row.ISO}</td>
                    <td>${row.Year}</td>
                    <td>${row.Month}</td>
                    <td>${row.Zone}</td>
                    <td>${row.Zone_Name}</td>
                    <td>$${parseFloat(row.Avg_DA_LMP).toFixed(2)}</td>
                </tr>
            `).join('');
            
            if (uploadedData.length > 50) {
                tbody.innerHTML += `<tr><td colspan="6" style="text-align: center; color: var(--gray-600);">... and ${uploadedData.length - 50} more rows</td></tr>`;
            }
            
            document.getElementById('uploadPreview').classList.remove('hidden');
        }
        
        function generateExportFiles() {
            if (uploadedData.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Group by ISO and Year
            const grouped = {};
            uploadedData.forEach(row => {
                const iso = row.ISO.toLowerCase();
                const year = parseInt(row.Year);
                
                if (!grouped[iso]) grouped[iso] = {};
                if (!grouped[iso][year]) grouped[iso][year] = [];
                
                grouped[iso][year].push({
                    ISO: row.ISO,
                    Year: year,
                    Month: parseInt(row.Month),
                    Zone: row.Zone,
                    Zone_Name: row.Zone_Name,
                    Avg_DA_LMP: parseFloat(row.Avg_DA_LMP)
                });
            });
            
            // Generate JSON files and download
            const files = [];
            
            for (const [iso, years] of Object.entries(grouped)) {
                for (const [year, data] of Object.entries(years)) {
                    const jsonContent = JSON.stringify({
                        iso: iso.toUpperCase(),
                        year: parseInt(year),
                        recordCount: data.length,
                        data: data
                    }, null, 2);
                    
                    files.push({
                        name: `${iso}/${year}.json`,
                        content: jsonContent
                    });
                }
            }
            
            // Generate updated data-index.json
            const newIndex = generateDataIndex(grouped);
            files.push({
                name: 'data-index.json',
                content: JSON.stringify(newIndex, null, 2)
            });
            
            // Download each file
            files.forEach(file => {
                const blob = new Blob([file.content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name.replace('/', '_');
                a.click();
                URL.revokeObjectURL(url);
            });
            
            alert(`Downloaded ${files.length} JSON files. Place them in your /data/lmp/ folder and commit to GitHub.`);
        }
        
        function generateDataIndex(grouped) {
            const index = {
                lastUpdated: new Date().toISOString(),
                isos: {}
            };
            
            for (const [iso, years] of Object.entries(grouped)) {
                const allData = Object.values(years).flat();
                const zones = [...new Map(allData.map(d => [d.Zone, { Zone: d.Zone, Zone_Name: d.Zone_Name }])).values()];
                
                index.isos[iso] = {
                    name: iso.toUpperCase(),
                    years: Object.keys(years).map(y => parseInt(y)).sort(),
                    zones: zones,
                    totalRecords: allData.length
                };
            }
            
            return index;
        }
        
        function updateExportYears() {
            const iso = document.getElementById('exportISO').value;
            const container = document.getElementById('exportYears');
            
            if (!iso) {
                container.innerHTML = '<span style="color: var(--gray-600);">Select an ISO first</span>';
                return;
            }
            
            const years = LMPDataStore.getYears(iso);
            container.innerHTML = years.map(y => `
                <label class="checkbox-item">
                    <input type="checkbox" value="${y}" checked>
                    ${y}
                </label>
            `).join('');
        }
        
        async function exportForGitHub() {
            const iso = document.getElementById('exportISO').value;
            if (!iso) {
                alert('Please select an ISO');
                return;
            }
            
            const selectedYears = [...document.querySelectorAll('#exportYears input:checked')]
                .map(cb => parseInt(cb.value));
            
            if (selectedYears.length === 0) {
                alert('Please select at least one year');
                return;
            }
            
            setStatus('loading', 'Generating export files...');
            
            for (const year of selectedYears) {
                const data = await LMPDataStore.loadYear(iso, year);
                
                const jsonContent = JSON.stringify({
                    iso: iso.toUpperCase(),
                    year: year,
                    recordCount: data.length,
                    data: data
                }, null, 2);
                
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${iso}_${year}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            document.getElementById('exportInstructions').classList.remove('hidden');
            setStatus('ready', `Exported ${selectedYears.length} files`);
        }
        
        async function refreshIndex() {
            setStatus('loading', 'Refreshing...');
            LMPDataStore.clearCache();
            await LMPDataStore.init();
            renderISOList();
            populateFilters();
            setStatus('ready', 'Data store ready');
        }
    </script>
</body>
</html>
