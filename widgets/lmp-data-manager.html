<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMP Data Management - Secure Energy</title>
    <style>
        :root {
            --se-dark-green: #004D40;
            --se-light-green: #3EB489;
            --se-gradient: linear-gradient(135deg, #004D40 0%, #3EB489 100%);
            --bg-primary: #0A0E1A;
            --bg-secondary: #131824;
            --bg-tertiary: #1A2030;
            --bg-elevated: #222938;
            --text-primary: #FFFFFF;
            --text-secondary: #A0AEC0;
            --text-tertiary: #718096;
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-success: #00E676;
            --accent-warning: #FFB300;
            --accent-error: #FF5252;
            --accent-info: #00B8D4;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--se-gradient);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--se-light-green);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--se-light-green);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-item {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--se-light-green);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-tertiary);
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: var(--se-light-green);
            background: rgba(62, 180, 137, 0.1);
        }

        /* Import Mode Toggle */
        .import-mode-toggle {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .mode-option {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-option:hover {
            border-color: var(--se-light-green);
        }

        .mode-option input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: var(--se-light-green);
        }

        .mode-option input[type="radio"]:checked + .mode-label strong {
            color: var(--se-light-green);
        }

        .mode-option:has(input:checked) {
            border-color: var(--se-light-green);
            background: rgba(62, 180, 137, 0.1);
        }

        .mode-label {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .mode-label strong {
            font-size: 14px;
            color: var(--text-primary);
        }

        .mode-label small {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .upload-zone svg {
            width: 48px;
            height: 48px;
            fill: var(--text-secondary);
            margin-bottom: 12px;
        }

        .upload-zone h3 {
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upload-zone p {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .file-input {
            display: none;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--se-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(62, 180, 137, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .iso-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .iso-table th, .iso-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .iso-table th {
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .iso-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--se-gradient);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-dot.active {
            background: var(--accent-success);
            box-shadow: 0 0 8px var(--accent-success);
        }

        .status-dot.empty {
            background: var(--text-tertiary);
        }

        .log-container {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: var(--text-tertiary);
        }

        .log-success {
            color: var(--accent-success);
        }

        .log-error {
            color: var(--accent-error);
        }

        .log-info {
            color: var(--accent-info);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 16px;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: var(--se-gradient);
            transition: width 0.3s;
            width: 0%;
        }

        .meta-info {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .meta-row:last-child {
            border-bottom: none;
        }

        .meta-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .meta-value {
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
        }

        .embedded-csv {
            background: rgba(62, 180, 137, 0.1);
            border: 1px solid var(--se-light-green);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .embedded-csv h4 {
            color: var(--se-light-green);
            margin-bottom: 8px;
        }

        .embedded-csv p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Consolas', monospace;
            font-size: 12px;
            resize: vertical;
            margin-top: 12px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--se-light-green);
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° LMP Data Management</h1>
            <p>Central data store for Locational Marginal Pricing across all ISOs</p>
        </div>

        <div class="grid">
            <!-- Status Overview -->
            <div class="card">
                <div class="card-title">üìä Data Store Status</div>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalRecords">0</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeISOs">0</div>
                        <div class="stat-label">Active ISOs</div>
                    </div>
                </div>
                <div class="meta-info">
                    <div class="meta-row">
                        <span class="meta-label">Last Update</span>
                        <span class="meta-value" id="lastUpdate">Never</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Data Source</span>
                        <span class="meta-value" id="dataSource">None</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Date Range</span>
                        <span class="meta-value" id="dateRange">N/A</span>
                    </div>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="card">
                <div class="card-title">üìÅ Bulk CSV Import</div>
                
                <!-- Import Mode Toggle -->
                <div class="import-mode-toggle">
                    <label class="mode-option">
                        <input type="radio" name="importMode" value="append" checked>
                        <span class="mode-label">
                            <strong>‚ûï Append</strong>
                            <small>Add to existing data (keeps ISONE, PJM, etc.)</small>
                        </span>
                    </label>
                    <label class="mode-option">
                        <input type="radio" name="importMode" value="replace">
                        <span class="mode-label">
                            <strong>üîÑ Replace</strong>
                            <small>Clear all and load fresh</small>
                        </span>
                    </label>
                </div>
                
                <div class="upload-zone" id="uploadZone">
                    <svg viewBox="0 0 24 24"><path d="M14,2L20,8V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V4A2,2 0 0,1 6,2H14M18,20V9H13V4H6V20H18M12,12L16,16H13.5V19H10.5V16H8L12,12Z"/></svg>
                    <h3>Drop CSV File Here</h3>
                    <p>or click to browse files</p>
                    <p style="margin-top: 8px; font-size: 11px;">Expected format: ISO, Year, Month, Zone, Zone_Name, Avg_DA_LMP</p>
                </div>
                <input type="file" class="file-input" id="fileInput" accept=".csv">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                        üìÇ Browse Files
                    </button>
                    <button class="btn-secondary" onclick="showPasteModal()">
                        üìã Paste CSV Data
                    </button>
                </div>
            </div>
        </div>

        <!-- ISO Details -->
        <div class="card">
            <div class="card-title">üè≠ ISO Data Summary</div>
            <table class="iso-table">
                <thead>
                    <tr>
                        <th>ISO</th>
                        <th>Status</th>
                        <th>Records</th>
                        <th>Zones</th>
                        <th>Year Range</th>
                    </tr>
                </thead>
                <tbody id="isoTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-secondary);">
                            No data loaded. Import CSV to get started.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Actions & Log -->
        <div class="grid" style="margin-top: 20px;">
            <div class="card">
                <div class="card-title">üîß Actions</div>
                <div class="button-group">
                    <button class="btn-success" onclick="exportData()">
                        üíæ Export CSV
                    </button>
                    <button class="btn-secondary" onclick="refreshFromStorage()">
                        üîÑ Refresh from Storage
                    </button>
                    <button class="btn-danger" onclick="clearAllData()">
                        üóëÔ∏è Clear All Data
                    </button>
                </div>
                
                <div class="embedded-csv">
                    <h4>üöÄ Quick Load: Fetch from Azure</h4>
                    <p>Click below to load the latest LMP data from Azure Blob Storage (falls back to GitHub if Azure is unavailable).</p>
                    <button class="btn-primary" style="margin-top: 12px;" onclick="loadEmbeddedData()">
                        ‚ö° Load from Azure
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìù Activity Log</div>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-time">[--:--:--]</span>
                        <span class="log-info">System ready. Waiting for data...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paste CSV Modal -->
        <div id="pasteModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 40px;">
            <div class="card" style="max-width: 800px; margin: 0 auto; max-height: 90vh; overflow-y: auto;">
                <div class="card-title">üìã Paste CSV Data</div>
                <p style="color: var(--text-secondary); margin-bottom: 12px;">
                    Paste your CSV data below. First row should be headers: ISO, Year, Month, Zone, Zone_Name, Avg_DA_LMP
                </p>
                <textarea id="pasteArea" placeholder="ISO,Year,Month,Zone,Zone_Name,Avg_DA_LMP
ISONE,2024,1,4000_ISONE,ISO NE CA,70.47
ISONE,2024,1,4001_Maine,ME,68.31
..."></textarea>
                <div class="button-group">
                    <button class="btn-primary" onclick="loadFromPaste()">Import Data</button>
                    <button class="btn-secondary" onclick="closePasteModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include the shared data store -->
    <script src="../scripts/shared-data-store.js"></script>
    
    <script>
        // Embedded CSV data (will be populated with actual data)
        const EMBEDDED_CSV_DATA = `ISO,Year,Month,Zone,Zone_Name,Avg_DA_LMP
ISONE,2016,1,4000_ISONE,ISO NE CA,38.6
ISONE,2016,1,4001_Maine,ME,37.21
ISONE,2016,1,4002_NH,NH,38.36
ISONE,2016,1,4003_Vermont,VT,38.4
ISONE,2016,1,4004_Connecticut,CT,38.35
ISONE,2016,1,4005_Rhode_Island,RI,38.54
ISONE,2016,1,4006_SEMA,SEMA,38.73
ISONE,2016,1,4007_WCMA,WCMA,38.68
ISONE,2016,1,4008_NEMA,NEMA,38.63`;

        // DOM Elements
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const logContainer = document.getElementById('logContainer');

        // Append CSV data to existing records (instead of replacing)
        function appendFromCSV(dataStore, csvContent, source) {
            try {
                const lines = csvContent.trim().split('\n');
                if (lines.length < 2) {
                    return { success: false, error: 'CSV is empty' };
                }
                
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const newRecords = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length >= headers.length) {
                        const record = {};
                        headers.forEach((h, idx) => {
                            record[h] = values[idx]?.trim() || '';
                        });
                        
                        // Normalize
                        newRecords.push({
                            iso: record.iso || '',
                            year: record.year || '',
                            month: record.month || '',
                            zone: record.zone_name || record.zone || '',
                            zoneId: record.zone || '',
                            lmp: parseFloat(record.avg_da_lmp || record.lmp || 0)
                        });
                    }
                }
                
                // Get existing records
                const existingRecords = dataStore.getRecords() || [];
                
                // Combine existing + new (avoid duplicates by checking ISO+Year+Month+Zone)
                const existingKeys = new Set(
                    existingRecords.map(r => `${r.iso}-${r.year}-${r.month}-${r.zoneId || r.zone}`)
                );
                
                let addedCount = 0;
                let skippedCount = 0;
                
                newRecords.forEach(r => {
                    const key = `${r.iso}-${r.year}-${r.month}-${r.zoneId || r.zone}`;
                    if (!existingKeys.has(key)) {
                        existingRecords.push(r);
                        existingKeys.add(key);
                        addedCount++;
                    } else {
                        skippedCount++;
                    }
                });
                
                // Save combined data
                if (dataStore.data) {
                    dataStore.data.records = existingRecords;
                    dataStore.data.meta = {
                        source: source,
                        loadedAt: new Date().toISOString(),
                        recordCount: existingRecords.length
                    };
                    // Save to localStorage
                    const STORAGE_KEY = 'secureEnergy_LMP_Data';
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataStore.data));
                }
                
                if (skippedCount > 0) {
                    log('info', `Skipped ${skippedCount} duplicate records`);
                }
                
                return { success: true, count: addedCount, total: existingRecords.length };
            } catch (e) {
                return { success: false, error: e.message };
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize data store (will create standalone if needed)
            const dataStore = getDataStore();
            
            // Initialize standalone store if using it
            if (dataStore && dataStore.init) {
                dataStore.init().then(() => {
                    updateUI();
                    log('info', 'Data management dashboard initialized');
                }).catch(() => {
                    updateUI();
                    log('info', 'Data management dashboard initialized (standalone mode)');
                });
            } else {
                setTimeout(() => {
                    updateUI();
                    log('info', 'Data management dashboard initialized');
                }, 100);
            }
        });

        // Drag and drop handling
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                processFile(file);
            } else {
                log('error', 'Please drop a CSV file');
            }
        });

        uploadZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        });

        // Process uploaded file
        function processFile(file) {
            const importMode = document.querySelector('input[name="importMode"]:checked')?.value || 'append';
            log('info', `Processing file: ${file.name} (${formatBytes(file.size)}) - Mode: ${importMode.toUpperCase()}`);
            progressBar.style.display = 'block';
            progressFill.style.width = '20%';

            const reader = new FileReader();
            reader.onload = (e) => {
                progressFill.style.width = '60%';
                const csvText = e.target.result;
                
                try {
                    const dataStore = getDataStore();
                    if (!dataStore) {
                        log('error', 'Data store not available');
                        return;
                    }
                    
                    let result;
                    if (importMode === 'append') {
                        result = appendFromCSV(dataStore, csvText, `file: ${file.name}`);
                    } else {
                        result = dataStore.loadFromCSV(csvText, `file: ${file.name}`);
                    }
                    progressFill.style.width = '100%';
                    
                    if (result && result.success) {
                        const modeText = importMode === 'append' ? 'appended' : 'loaded';
                        log('success', `Successfully ${modeText} ${result.count} records from ${file.name}. Total: ${result.total || result.count} records`);
                        updateUI();
                    } else if (result && result.error) {
                        log('error', `Failed to parse CSV: ${result.error}`);
                    } else {
                        log('error', 'Failed to parse CSV file. Check format.');
                    }
                } catch (err) {
                    log('error', `Error processing file: ${err.message}`);
                }
                
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 1000);
            };
            
            reader.onerror = () => {
                log('error', 'Error reading file');
                progressBar.style.display = 'none';
            };
            
            reader.readAsText(file);
        }
        
        // Get the data store (works in iframe or standalone)
        function getDataStore() {
            // Try parent window first (if in iframe and same origin)
            try {
                if (window.parent !== window && window.parent.SecureEnergyData) {
                    return window.parent.SecureEnergyData;
                }
            } catch (e) {
                // Cross-origin error - use local fallback
                console.log('Using standalone mode (cross-origin or local file)');
            }
            
            // Try current window
            if (window.SecureEnergyData) {
                return window.SecureEnergyData;
            }
            
            // Create a standalone data store for local testing
            if (!window._standaloneDataStore) {
                window._standaloneDataStore = createStandaloneDataStore();
            }
            return window._standaloneDataStore;
        }
        
        // Friendly display names for zones (dbName ‚Üí user-friendly label)
        const ZONE_DISPLAY_NAMES = {
            'AEN': 'AEN', 'CPS': 'CPS Energy', 'HOUSTON': 'Houston', 'LCRA': 'LCRA',
            'NORTH': 'North', 'RAYBN': 'Rayburn', 'SOUTH': 'South', 'WEST': 'West',
            '4001_Maine': 'Maine', '4002_NH': 'New Hampshire', '4003_Vermont': 'Vermont',
            '4004_Connecticut': 'Connecticut', '4005_Rhode_Island': 'Rhode Island',
            '4006_SEMA': 'SE Mass (SEMA)', '4007_WCMA': 'W/C Mass (WCMA)', '4008_NEMA': 'NE Mass (NEMA)',
            '4000_ISONE': 'ISO-NE Hub',
            'ARKANSAS': 'Arkansas', 'ILLINOIS': 'Illinois', 'INDIANA': 'Indiana',
            'LOUISIANA': 'Louisiana', 'MICHIGAN': 'Michigan', 'MINN': 'Minnesota',
            'MS': 'Mississippi', 'TEXAS': 'Texas',
            '61752': 'West (Zone A)', '61753': 'Genesee (Zone B)', '61754': 'Central (Zone C)',
            '61755': 'North (Zone D)', '61756': 'Mohawk Valley (Zone E)', '61757': 'Capital (Zone F)',
            '61758': 'Hudson Valley (Zone G)', '61759': 'Millwood (Zone H)',
            '61760': 'Dunwoodie (Zone I)', '61761': 'NYC (Zone J)', '61762': 'Long Island (Zone K)',
            '61844': 'Zone J Hub', '61845': 'Zone K Hub', '61846': 'Zone A Hub', '61847': 'Zone F Hub',
            'AECO': 'AECO', 'AEP': 'AEP', 'APS': 'APS', 'ATSI': 'ATSI', 'BGE': 'BGE',
            'COMED': 'ComEd', 'DAY': 'Dayton', 'DEOK': 'Duke Energy OH/KY', 'DOM': 'Dominion',
            'DPL': 'DPL', 'DUQ': 'Duquesne', 'EKPC': 'EKPC', 'EXTERNAL': 'External',
            'JCPL': 'JCPL', 'METED': 'Met-Ed', 'PECO': 'PECO', 'PENELEC': 'Penelec',
            'PEPCO': 'Pepco', 'PPL': 'PPL', 'PSEG': 'PSEG', 'RECO': 'RECO'
        };
        function getZoneDisplayName(dbName) { return ZONE_DISPLAY_NAMES[dbName] || dbName; }

        // Standalone data store for local testing
        function createStandaloneDataStore() {
            const STORAGE_KEY = 'secureEnergy_LMP_Data';
            const AZURE_API = 'https://ses-data-api-gpaqghfbehhrb6c2.eastus-01.azurewebsites.net/api/data';
            const LMP_FILE = 'lmp-database.json';
            const GITHUB_RAW_URL = 'https://raw.githubusercontent.com/ClemmensSES/SESSalesResources/main/data/lmp-database.json';
            
            // Convert Azure format { data: { ISONE: [...], PJM: [...] } } to flat records array
            function convertAzureToRecords(azureData) {
                const records = [];
                if (azureData && azureData.data) {
                    Object.keys(azureData.data).forEach(iso => {
                        if (Array.isArray(azureData.data[iso])) {
                            azureData.data[iso].forEach(item => {
                                records.push({
                                    iso: iso,
                                    year: item.year || '',
                                    month: item.month || '',
                                    zone: item.zone || item.zone_name || '',
                                    zoneId: item.zone_id || '',
                                    lmp: parseFloat(item.avg_da_lmp || item.lmp || 0)
                                });
                            });
                        }
                    });
                }
                return records;
            }
            
            return {
                data: null,
                
                async init() {
                    // First load from localStorage (cache)
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        try {
                            this.data = JSON.parse(stored);
                            console.log('[DataManager] Loaded from localStorage cache');
                        } catch (e) {
                            this.data = null;
                        }
                    }
                    
                    // Then try to load fresh data from Azure first, then GitHub
                    try {
                        const loaded = await this.loadFromAzure();
                        if (!loaded) {
                            await this.loadFromGitHub();
                        }
                    } catch (e) {
                        console.warn('[DataManager] Remote load failed, using cached data');
                    }
                    
                    return Promise.resolve();
                },
                
                async loadFromAzure() {
                    try {
                        // Try parent's AzureDataService first (if in iframe)
                        if (window.parent !== window && window.parent.AzureDataService) {
                            try {
                                console.log('[DataManager] Trying parent AzureDataService...');
                                const azureData = await window.parent.AzureDataService.get(LMP_FILE);
                                if (azureData) {
                                    return this._processAzureData(azureData, 'Azure (parent service)');
                                }
                            } catch (e) {
                                console.warn('[DataManager] Parent AzureDataService failed:', e.message);
                            }
                        }
                        
                        // Try direct Azure API call
                        let apiKey = null;
                        try {
                            if (window.parent !== window && window.parent.AzureDataService) {
                                apiKey = window.parent.AzureDataService.getApiKey?.() || null;
                            }
                        } catch (e) {}
                        if (!apiKey) apiKey = 'ses-widget-mno345pqr678';
                        
                        console.log('[DataManager] Trying direct Azure API...');
                        const response = await fetch(`${AZURE_API}/${LMP_FILE}`, {
                            headers: { 'X-API-Key': apiKey }
                        });
                        if (response.ok) {
                            const azureData = await response.json();
                            return this._processAzureData(azureData, 'Azure Blob Storage');
                        } else {
                            console.warn(`[DataManager] Azure API returned ${response.status}`);
                        }
                    } catch (e) {
                        console.warn('[DataManager] Azure load failed:', e.message);
                    }
                    return false;
                },
                
                _processAzureData(azureData, source) {
                    let records;
                    // Handle { records: [...] } format
                    if (azureData.records && azureData.records.length > 0) {
                        records = azureData.records;
                    }
                    // Handle { data: { ISONE: [...], PJM: [...] } } format
                    else if (azureData.data) {
                        records = convertAzureToRecords(azureData);
                    }
                    
                    if (records && records.length > 0) {
                        this.data = {
                            records: records,
                            meta: {
                                source: source,
                                loadedAt: new Date().toISOString(),
                                recordCount: records.length
                            }
                        };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));
                        console.log(`[DataManager] Loaded ${records.length} records from ${source}`);
                        return true;
                    }
                    return false;
                },
                
                async loadFromGitHub() {
                    try {
                        console.log('[DataManager] Falling back to GitHub...');
                        const response = await fetch(GITHUB_RAW_URL + '?t=' + Date.now());
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const jsonData = await response.json();
                        // Handle both formats
                        let records;
                        if (jsonData.records && jsonData.records.length > 0) {
                            records = jsonData.records;
                        } else if (jsonData.data) {
                            records = convertAzureToRecords(jsonData);
                        }
                        
                        if (records && records.length > 0) {
                            this.data = {
                                records: records,
                                meta: {
                                    source: 'GitHub Repository',
                                    loadedAt: new Date().toISOString(),
                                    recordCount: records.length
                                }
                            };
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));
                            console.log(`[DataManager] Loaded ${records.length} records from GitHub`);
                            return true;
                        }
                    } catch (e) {
                        console.warn('[DataManager] GitHub load failed:', e.message);
                    }
                    return false;
                },
                
                loadFromCSV(csvContent, source) {
                    try {
                        const lines = csvContent.trim().split('\n');
                        if (lines.length < 2) {
                            return { success: false, error: 'CSV is empty' };
                        }
                        
                        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                        const records = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',');
                            if (values.length >= headers.length) {
                                const record = {};
                                headers.forEach((h, idx) => {
                                    record[h] = values[idx]?.trim() || '';
                                });
                                
                                // Normalize
                                records.push({
                                    iso: record.iso || '',
                                    year: record.year || '',
                                    month: record.month || '',
                                    zone: record.zone_name || record.zone || '',
                                    zoneId: record.zone || '',
                                    lmp: parseFloat(record.avg_da_lmp || record.lmp || 0)
                                });
                            }
                        }
                        
                        this.data = {
                            records: records,
                            meta: {
                                source: source,
                                loadedAt: new Date().toISOString(),
                                recordCount: records.length
                            }
                        };
                        
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));
                        return { success: true, count: records.length };
                    } catch (e) {
                        return { success: false, error: e.message };
                    }
                },
                
                getRecords() {
                    return this.data?.records || [];
                },
                
                getStats() {
                    const records = this.getRecords();
                    const isos = [...new Set(records.map(r => r.iso).filter(Boolean))];
                    const years = [...new Set(records.map(r => r.year).filter(Boolean))];
                    
                    return {
                        totalRecords: records.length,
                        isoCount: isos.length,
                        yearRange: years.sort(),
                        lastUpdate: this.data?.meta?.loadedAt || null,
                        isLoaded: records.length > 0
                    };
                },
                
                clear() {
                    this.data = null;
                    localStorage.removeItem(STORAGE_KEY);
                }
            };
        }

        // Load embedded data (from Azure or GitHub JSON)
        async function loadEmbeddedData() {
            log('info', 'Loading LMP data from Azure...');
            
            const dataStore = getDataStore();
            if (!dataStore) {
                log('error', 'Data store not available');
                return;
            }
            
            // Check if running locally (file:// protocol)
            if (window.location.protocol === 'file:') {
                log('warning', 'Remote data loading is not available when testing locally (file:// protocol).');
                log('info', 'Please upload the CSV file manually, or use a local web server.');
                return;
            }
            
            // Try Azure first
            if (dataStore.loadFromAzure) {
                try {
                    log('info', 'Fetching from Azure...');
                    const loaded = await dataStore.loadFromAzure();
                    if (loaded) {
                        const stats = dataStore.getStats();
                        log('success', `Loaded ${stats.totalRecords} records from Azure`);
                        updateUI();
                        return;
                    } else {
                        log('warning', 'Azure returned no data, trying GitHub...');
                    }
                } catch (e) {
                    log('warning', 'Azure load failed: ' + e.message);
                }
            }
            
            // Fallback to GitHub JSON
            const githubUrl = 'https://raw.githubusercontent.com/ClemmensSES/SESSalesResources/main/data/lmp-database.json';
            
            try {
                log('info', 'Fetching from GitHub...');
                const response = await fetch(githubUrl + '?t=' + Date.now());
                if (response.ok) {
                    const jsonData = await response.json();
                    let records;
                    if (jsonData && jsonData.records && jsonData.records.length > 0) {
                        records = jsonData.records;
                    } else if (jsonData && jsonData.data) {
                        // Handle Azure format from GitHub
                        records = [];
                        Object.keys(jsonData.data).forEach(iso => {
                            if (Array.isArray(jsonData.data[iso])) {
                                jsonData.data[iso].forEach(item => {
                                    records.push({
                                        iso: iso,
                                        year: item.year || '',
                                        month: item.month || '',
                                        zone: item.zone || item.zone_name || '',
                                        zoneId: item.zone_id || '',
                                        lmp: parseFloat(item.avg_da_lmp || item.lmp || 0)
                                    });
                                });
                            }
                        });
                    }
                    
                    if (records && records.length > 0) {
                        dataStore.data = {
                            records: records,
                            meta: {
                                source: 'GitHub Repository',
                                loadedAt: new Date().toISOString(),
                                recordCount: records.length
                            }
                        };
                        localStorage.setItem('secureEnergy_LMP_Data', JSON.stringify(dataStore.data));
                        log('success', `Loaded ${records.length} records from GitHub`);
                        updateUI();
                        return;
                    }
                }
            } catch (e) {
                log('warning', 'GitHub JSON load failed: ' + e.message);
            }
            
            // Last resort: Try CSV files
            log('info', 'Trying fallback CSV files...');
            const possiblePaths = [
                'lmp_data_combined.csv',
                '../data/lmp_data_combined.csv',
                '/data/lmp_data_combined.csv',
                'data/lmp_data_combined.csv'
            ];
            
            tryLoadFromPaths(possiblePaths, 0, dataStore);
        }
        
        function tryLoadFromPaths(paths, index, dataStore) {
            if (index >= paths.length) {
                log('error', 'Could not find CSV file. Try uploading manually.');
                return;
            }
            
            fetch(paths[index])
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Not found');
                    }
                    return response.text();
                })
                .then(csvText => {
                    const result = dataStore.loadFromCSV(csvText, 'embedded-data');
                    if (result && result.success) {
                        log('success', `Loaded ${result.count} records from embedded data`);
                        updateUI();
                    } else {
                        log('error', 'Failed to parse embedded data');
                    }
                })
                .catch(err => {
                    // Try next path
                    tryLoadFromPaths(paths, index + 1, dataStore);
                });
        }

        // Paste modal functions
        function showPasteModal() {
            document.getElementById('pasteModal').style.display = 'block';
        }

        function closePasteModal() {
            document.getElementById('pasteModal').style.display = 'none';
        }

        function loadFromPaste() {
            const csvText = document.getElementById('pasteArea').value;
            if (!csvText.trim()) {
                log('error', 'No data to import');
                return;
            }
            
            const dataStore = getDataStore();
            if (!dataStore) {
                log('error', 'Data store not available');
                return;
            }
            
            const importMode = document.querySelector('input[name="importMode"]:checked')?.value || 'append';
            
            let result;
            if (importMode === 'append') {
                result = appendFromCSV(dataStore, csvText, 'pasted-data');
            } else {
                result = dataStore.loadFromCSV(csvText, 'pasted-data');
            }
            
            if (result && result.success) {
                const modeText = importMode === 'append' ? 'appended' : 'loaded';
                log('success', `Successfully ${modeText} ${result.count} records from pasted data. Total: ${result.total || result.count} records`);
                updateUI();
                closePasteModal();
            } else {
                log('error', 'Failed to parse pasted CSV data');
            }
        }

        // Export data
        function exportData() {
            const dataStore = getDataStore();
            if (!dataStore) {
                log('error', 'Data store not available');
                return;
            }
            
            const records = dataStore.getRecords();
            if (!records || records.length === 0) {
                log('error', 'No data to export');
                return;
            }
            
            // Convert to CSV
            const headers = ['ISO', 'Year', 'Month', 'Zone_ID', 'Zone_Name', 'Avg_DA_LMP'];
            const csvRows = [headers.join(',')];
            
            records.forEach(r => {
                csvRows.push([
                    r.iso || '',
                    r.year || '',
                    r.month || '',
                    r.zoneId || r.zone || '',
                    getZoneDisplayName(r.zone || r.zoneId || ''),
                    r.lmp || ''
                ].join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lmp_data_export.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('success', 'Data exported to CSV');
        }

        // Refresh from storage (tries Azure first, then localStorage)
        async function refreshFromStorage() {
            const dataStore = getDataStore();
            if (dataStore) {
                log('info', 'Refreshing data from Azure...');
                if (dataStore.loadFromAzure) {
                    try {
                        const loaded = await dataStore.loadFromAzure();
                        if (loaded) {
                            updateUI();
                            log('success', 'Refreshed data from Azure');
                            return;
                        }
                    } catch (e) {
                        log('warning', 'Azure refresh failed: ' + e.message);
                    }
                }
                // Fallback to re-init (localStorage + GitHub)
                dataStore.init().then(() => {
                    updateUI();
                    log('info', 'Refreshed data from cache');
                });
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all LMP data? This cannot be undone.')) {
                const dataStore = getDataStore();
                if (dataStore) {
                    dataStore.clear();
                    updateUI();
                    log('success', 'All data cleared');
                }
            }
        }

        // Update UI with current data
        function updateUI() {
            const dataStore = getDataStore();
            if (!dataStore) return;
            
            const stats = dataStore.getStats();
            const records = dataStore.getRecords();
            
            // Update stats
            document.getElementById('totalRecords').textContent = (stats.totalRecords || 0).toLocaleString();
            document.getElementById('activeISOs').textContent = stats.isoCount || 0;
            document.getElementById('lastUpdate').textContent = stats.lastUpdate 
                ? new Date(stats.lastUpdate).toLocaleString() 
                : 'Never';
            document.getElementById('dataSource').textContent = dataStore.data?.meta?.source || 'None';
            
            // Update date range based on actual data
            if (records && records.length > 0) {
                const years = [...new Set(records.map(r => r.year).filter(Boolean))].sort();
                if (years.length > 0) {
                    document.getElementById('dateRange').textContent = 
                        years.length > 1 ? `${years[0]} - ${years[years.length - 1]}` : years[0];
                } else {
                    document.getElementById('dateRange').textContent = 'N/A';
                }
            } else {
                document.getElementById('dateRange').textContent = 'N/A';
            }
            
            // Update ISO table
            const tbody = document.getElementById('isoTableBody');
            const isos = ['ISONE', 'PJM', 'ERCOT', 'MISO', 'NYISO', 'CAISO', 'SPP'];
            
            if (!records || records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-secondary);">
                            No data loaded. Import CSV to get started.
                        </td>
                    </tr>
                `;
            } else {
                // Calculate stats per ISO from records
                const isoStats = {};
                records.forEach(r => {
                    const iso = r.iso?.toUpperCase();
                    if (!iso) return;
                    
                    if (!isoStats[iso]) {
                        isoStats[iso] = {
                            records: 0,
                            zones: new Set(),
                            years: new Set()
                        };
                    }
                    isoStats[iso].records++;
                    if (r.zone) isoStats[iso].zones.add(r.zone);
                    if (r.year) isoStats[iso].years.add(r.year);
                });
                
                tbody.innerHTML = isos.map(iso => {
                    const stats = isoStats[iso];
                    const hasData = stats && stats.records > 0;
                    
                    let yearRange = '-';
                    if (hasData) {
                        const years = [...stats.years].sort();
                        yearRange = years.length > 1 ? `${years[0]}-${years[years.length - 1]}` : years[0] || '-';
                    }
                    
                    return `
                        <tr>
                            <td><span class="iso-badge">${iso}</span></td>
                            <td>
                                <div class="status-indicator">
                                    <span class="status-dot ${hasData ? 'active' : 'empty'}"></span>
                                    ${hasData ? 'Active' : 'No Data'}
                                </div>
                            </td>
                            <td>${hasData ? stats.records.toLocaleString() : '-'}</td>
                            <td>${hasData ? stats.zones.size : '-'}</td>
                            <td>${yearRange}</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Logging function
        function log(type, message) {
            const now = new Date();
            const time = now.toTimeString().split(' ')[0];
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-${type}">${message}</span>
            `;
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Utility: Format bytes
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Listen for data broadcasts from other windows
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'LMP_DATA_BROADCAST') {
                updateUI();
                log('info', 'Received data update from another widget');
            }
        });
    </script>
</body>
</html>
