<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Energy Utilization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #003366;
            --primary-light: #004080;
            --accent: #FF6B35;
            --accent-hover: #e85a28;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-input: #0f1629;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --border: #2d3748;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 16px;
        }
        .widget-container {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .widget-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .widget-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .client-indicator {
            background: rgba(40,167,69,0.2);
            border: 1px solid var(--success);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 350px;
        }
        .client-indicator.no-client {
            background: rgba(255,193,7,0.2);
            border-color: var(--warning);
            color: var(--warning);
        }
        .client-indicator.has-account {
            background: rgba(59,130,246,0.2);
            border-color: #3b82f6;
        }
        .context-display {
            display: flex;
            flex-direction: column;
            gap: 2px;
            line-height: 1.2;
        }
        .context-client {
            font-weight: 600;
            font-size: 0.8rem;
        }
        .context-account {
            font-size: 0.7rem;
            color: #3b82f6;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .context-account::before {
            content: "â””";
            color: var(--text-secondary);
        }
        .widget-body { padding: 20px; }
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-input);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.05); }
        .tab-btn.active { background: var(--accent); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .usage-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .usage-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .usage-item label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .usage-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 0.9rem;
            text-align: center;
            font-weight: 600;
        }
        .usage-item input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .usage-item input.gas {
            border-color: rgba(59, 130, 246, 0.3);
        }
        .usage-item input.gas:focus {
            border-color: #3b82f6;
        }
        .summary-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        .summary-card.electric { border-left: 4px solid var(--accent); }
        .summary-card.gas { border-left: 4px solid #3b82f6; }
        .summary-card.total { border-left: 4px solid var(--success); }
        .summary-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .summary-unit {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .chart-container {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            height: 280px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
        
        /* Import button group with template icon */
        .import-btn-group {
            display: inline-flex;
            align-items: center;
            gap: 0;
        }
        .import-btn-group .btn {
            border-radius: 6px 0 0 6px;
        }
        .template-download-btn {
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-left: none;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .template-download-btn:hover {
            background: var(--border);
            color: var(--accent);
        }
        .template-download-btn svg {
            width: 16px;
            height: 16px;
        }
        .template-download-btn[title]::after {
            content: attr(title);
        }
        
        .import-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }
        .import-zone:hover { border-color: var(--accent); background: rgba(255,107,53,0.05); }
        .import-zone p { color: var(--text-secondary); font-size: 0.85rem; }
        .history-list { max-height: 300px; overflow-y: auto; }
        .history-item {
            background: var(--bg-input);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item-info {
            flex: 1;
        }
        .history-item-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .history-item-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); color: #333; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
        }
        .modal-header {
            padding: 16px 20px;
            background: var(--bg-input);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 1rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.5rem; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; }
        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        .empty-state svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-input); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        
        /* Template info in modal */
        .template-info {
            background: rgba(0,51,102,0.2);
            border: 1px solid rgba(0,51,102,0.4);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .template-info svg {
            flex-shrink: 0;
            color: #4da6ff;
        }
        .template-info-text {
            flex: 1;
        }
        .template-info-text strong {
            display: block;
            color: #4da6ff;
            font-size: 0.85rem;
            margin-bottom: 2px;
        }
        .template-info-text span {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .template-download-link {
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.8rem;
        }
        .template-download-link:hover {
            color: var(--accent-hover);
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="widget-header">
            <div class="widget-title">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                Client Energy Utilization
            </div>
            <div class="client-indicator no-client" id="clientIndicator">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <span id="clientName">No client selected</span>
            </div>
        </div>
        
        <div class="widget-body">
            <div class="tabs">
                <button class="tab-btn active" data-tab="electric">âš¡ Electric (kWh)</button>
                <button class="tab-btn" data-tab="gas">ðŸ”¥ Gas (Therms)</button>
                <button class="tab-btn" data-tab="history">ðŸ“‹ Saved Profiles</button>
            </div>
            
            <!-- Electric Usage Tab -->
            <div class="tab-content active" id="tab-electric">
                <div class="summary-row">
                    <div class="summary-card electric">
                        <div class="summary-label">Annual Electric</div>
                        <div class="summary-value" id="totalElectric">0</div>
                        <div class="summary-unit">kWh</div>
                    </div>
                    <div class="summary-card electric">
                        <div class="summary-label">Monthly Average</div>
                        <div class="summary-value" id="avgElectric">0</div>
                        <div class="summary-unit">kWh</div>
                    </div>
                    <div class="summary-card electric">
                        <div class="summary-label">Peak Month</div>
                        <div class="summary-value" id="peakElectric">-</div>
                        <div class="summary-unit" id="peakElectricValue"></div>
                    </div>
                </div>
                
                <div class="usage-grid" id="electricGrid">
                    <!-- Generated by JS -->
                </div>
                
                <div class="chart-container">
                    <canvas id="electricChart"></canvas>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveToClient()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save to Client
                    </button>
                    <button class="btn btn-secondary" onclick="exportUsage()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export Excel
                    </button>
                    <div class="import-btn-group">
                        <button class="btn btn-secondary" onclick="showImportModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Import
                        </button>
                        <button class="template-download-btn" onclick="downloadImportTemplate()" title="Download Import Template">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="12" y1="18" x2="12" y2="12"/>
                                <line x1="9" y1="15" x2="12" y2="18"/>
                                <line x1="15" y1="15" x2="12" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    <button class="btn btn-secondary" onclick="clearUsage('electric')">Clear</button>
                </div>
            </div>
            
            <!-- Gas Usage Tab -->
            <div class="tab-content" id="tab-gas">
                <div class="summary-row">
                    <div class="summary-card gas">
                        <div class="summary-label">Annual Gas</div>
                        <div class="summary-value" id="totalGas">0</div>
                        <div class="summary-unit">Therms</div>
                    </div>
                    <div class="summary-card gas">
                        <div class="summary-label">Monthly Average</div>
                        <div class="summary-value" id="avgGas">0</div>
                        <div class="summary-unit">Therms</div>
                    </div>
                    <div class="summary-card gas">
                        <div class="summary-label">Peak Month</div>
                        <div class="summary-value" id="peakGas">-</div>
                        <div class="summary-unit" id="peakGasValue"></div>
                    </div>
                </div>
                
                <div class="usage-grid" id="gasGrid">
                    <!-- Generated by JS -->
                </div>
                
                <div class="chart-container">
                    <canvas id="gasChart"></canvas>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveToClient()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save to Client
                    </button>
                    <button class="btn btn-secondary" onclick="exportUsage()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export Excel
                    </button>
                    <div class="import-btn-group">
                        <button class="btn btn-secondary" onclick="showImportModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Import
                        </button>
                        <button class="template-download-btn" onclick="downloadImportTemplate()" title="Download Import Template">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="12" y1="18" x2="12" y2="12"/>
                                <line x1="9" y1="15" x2="12" y2="18"/>
                                <line x1="15" y1="15" x2="12" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    <button class="btn btn-secondary" onclick="clearUsage('gas')">Clear</button>
                </div>
            </div>
            
            <!-- History Tab -->
            <div class="tab-content" id="tab-history">
                <div id="historyList" class="history-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Import Usage Data</span>
                <button class="modal-close" onclick="closeImportModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- Template Download Info -->
                <div class="template-info">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <div class="template-info-text">
                        <strong>Need the correct format?</strong>
                        <span>Download the import template to ensure your data imports correctly.</span>
                    </div>
                    <span class="template-download-link" onclick="downloadImportTemplate(); return false;">Download Template</span>
                </div>
                
                <div class="import-zone" onclick="document.getElementById('importFile').click()">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom:8px;color:var(--text-secondary);">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <p><strong>Click to upload</strong> or drag and drop</p>
                    <p style="font-size:0.75rem;">Excel or CSV with monthly usage data</p>
                    <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display:none;" onchange="handleImport(event)">
                </div>
                <div class="form-group">
                    <label class="form-label">Import Type</label>
                    <select class="form-select" id="importType">
                        <option value="electric">Electric (kWh)</option>
                        <option value="gas">Gas (Therms)</option>
                        <option value="both">Both (Electric & Gas)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- No Usage Prompt Modal -->
    <div class="modal-overlay" id="noUsageModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">âš¡ Usage Data Required</span>
                <button class="modal-close" onclick="closeNoUsageModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:16px;">
                    <strong id="noUsageClientName">This client</strong> doesn't have any energy utilization data on file.
                </p>
                <p style="color:var(--text-secondary);font-size:0.9rem;">
                    Would you like to add their 12-month usage profile now? This data will be saved to the client record and can be used for LMP analysis.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNoUsageModal()">Skip for Now</button>
                <button class="btn btn-primary" onclick="startUsageEntry()">Enter Usage Data</button>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================================
        // STANDARDIZED EXPORT METADATA UTILITY
        // This pattern should be used across ALL widgets for consistency
        // ============================================================
        const ExportMetadata = {
            // Widget identification
            widgetName: 'Energy Utilization',
            widgetVersion: '1.1',
            
            // Get current user info from parent or localStorage
            getCurrentUser: function() {
                // Try to get from parent portal
                if (window.parent?.SecureEnergyAuth?.currentUser) {
                    const user = window.parent.SecureEnergyAuth.currentUser;
                    return {
                        name: user.name || user.username || 'Unknown User',
                        email: user.email || '',
                        role: user.role || 'user'
                    };
                }
                // Fallback to localStorage
                try {
                    const stored = localStorage.getItem('secure_energy_user');
                    if (stored) {
                        const user = JSON.parse(stored);
                        return {
                            name: user.name || user.username || 'Unknown User',
                            email: user.email || '',
                            role: user.role || 'user'
                        };
                    }
                } catch (e) {}
                return { name: 'Unknown User', email: '', role: 'user' };
            },
            
            // Get active client info
            getActiveClient: function() {
                if (activeClient) {
                    return {
                        name: activeClient.name || 'Unknown Client',
                        id: activeClient.id || '',
                        iso: activeClient.iso || '',
                        accountNumber: activeClient.accountNumber || ''
                    };
                }
                return { name: 'No Client Selected', id: '', iso: '', accountNumber: '' };
            },
            
            // Get active account info (child under client)
            getActiveAccount: function() {
                if (activeAccount) {
                    return {
                        name: activeAccount.accountName || 'Unknown Account',
                        id: activeAccount.id || '',
                        accountNumber: activeAccount.accountNumber || '',
                        serviceZip: activeAccount.serviceZip || ''
                    };
                }
                return null;
            },
            
            // Get full context display name
            getContextDisplayName: function() {
                const client = this.getActiveClient();
                const account = this.getActiveAccount();
                if (account && client.name !== 'No Client Selected') {
                    return `${client.name} â†’ ${account.name}`;
                }
                return client.name;
            },
            
            // Generate standardized metadata header rows for Excel export
            generateMetadataRows: function(additionalInfo = {}) {
                const user = this.getCurrentUser();
                const client = this.getActiveClient();
                const account = this.getActiveAccount();
                const now = new Date();
                
                const metadata = [
                    ['SECURE ENERGY SERVICES - EXPORT REPORT'],
                    [''],
                    ['Export Information'],
                    ['Export Date:', now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })],
                    ['Export Time:', now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' })],
                    ['Exported By:', user.name + (user.email ? ` (${user.email})` : '')],
                    ['User Role:', user.role.charAt(0).toUpperCase() + user.role.slice(1)],
                    [''],
                    ['Client Information'],
                    ['Client Name:', client.name],
                    ['Client ID:', client.id || 'N/A'],
                    ['ISO/RTO:', client.iso || 'N/A'],
                    ['Account Number:', client.accountNumber || 'N/A']
                ];
                
                // Add account info if available
                if (account) {
                    metadata.push(['']);
                    metadata.push(['Account Information']);
                    metadata.push(['Account Name:', account.name]);
                    metadata.push(['Account ID:', account.id || 'N/A']);
                    metadata.push(['Account Number:', account.accountNumber || 'N/A']);
                    metadata.push(['Service ZIP:', account.serviceZip || 'N/A']);
                }
                
                metadata.push(['']);
                metadata.push(['Widget Information']);
                metadata.push(['Widget:', this.widgetName]);
                metadata.push(['Version:', this.widgetVersion]);
                metadata.push(['']);
                
                // Add any additional custom info
                if (Object.keys(additionalInfo).length > 0) {
                    metadata.push(['Additional Details']);
                    for (const [key, value] of Object.entries(additionalInfo)) {
                        metadata.push([key + ':', value]);
                    }
                    metadata.push(['']);
                }
                
                return metadata;
            },
            
            // Apply professional styling to metadata section
            styleMetadataSheet: function(ws, metadataRowCount) {
                // Set column widths
                ws['!cols'] = [
                    { wch: 20 },  // Label column
                    { wch: 50 }   // Value column
                ];
                
                // Merge title row
                if (!ws['!merges']) ws['!merges'] = [];
                ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 1 } });
                
                return ws;
            },
            
            // Generate filename with timestamp (includes account if present)
            generateFilename: function(baseName, extension = 'xlsx') {
                const client = this.getActiveClient();
                const account = this.getActiveAccount();
                const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                
                let namePart = '';
                if (client.name !== 'No Client Selected') {
                    namePart = client.name.replace(/[^a-z0-9]/gi, '_');
                    if (account) {
                        namePart += '_' + account.name.replace(/[^a-z0-9]/gi, '_');
                    }
                    namePart += '_';
                }
                return `${namePart}${baseName}_${timestamp}.${extension}`;
            }
        };
        
        // ============================================================
        // IMPORT TEMPLATE GENERATOR
        // Creates downloadable templates for data import
        // ============================================================
        const ImportTemplates = {
            // Generate and download the usage import template
            generateUsageTemplate: function() {
                const wb = XLSX.utils.book_new();
                
                // Instructions sheet
                const instructions = [
                    ['ENERGY UTILIZATION IMPORT TEMPLATE'],
                    [''],
                    ['Instructions:'],
                    ['1. Enter your 12-month usage data in the "Usage Data" sheet'],
                    ['2. Electric usage should be in kWh (kilowatt-hours)'],
                    ['3. Gas usage should be in Therms'],
                    ['4. Leave cells blank or enter 0 for months with no data'],
                    ['5. Save the file and import using the Import button'],
                    [''],
                    ['Import Options:'],
                    ['- Electric Only: Only the Electric (kWh) column will be imported'],
                    ['- Gas Only: Only the Gas (Therms) column will be imported'],
                    ['- Both: Both columns will be imported'],
                    [''],
                    ['Notes:'],
                    ['- Data should be for a rolling 12-month period'],
                    ['- Months should be in calendar order starting from January'],
                    ['- Do not change the column headers'],
                    ['']
                ];
                const wsInstructions = XLSX.utils.aoa_to_sheet(instructions);
                wsInstructions['!cols'] = [{ wch: 60 }];
                XLSX.utils.book_append_sheet(wb, wsInstructions, 'Instructions');
                
                // Data template sheet
                const template = [
                    ['Month', 'Electric (kWh)', 'Gas (Therms)'],
                    ['January', '', ''],
                    ['February', '', ''],
                    ['March', '', ''],
                    ['April', '', ''],
                    ['May', '', ''],
                    ['June', '', ''],
                    ['July', '', ''],
                    ['August', '', ''],
                    ['September', '', ''],
                    ['October', '', ''],
                    ['November', '', ''],
                    ['December', '', '']
                ];
                const wsData = XLSX.utils.aoa_to_sheet(template);
                wsData['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, wsData, 'Usage Data');
                
                // Download
                XLSX.writeFile(wb, 'Energy_Utilization_Import_Template.xlsx');
            }
        };
        
        // Download import template function (called from UI)
        function downloadImportTemplate() {
            ImportTemplates.generateUsageTemplate();
            showToast('Template downloaded', 'success');
        }
        
        // ============================================================
        // WIDGET STATE & DATA
        // ============================================================
        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const FULL_MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        let electricData = Array(12).fill(0);
        let gasData = Array(12).fill(0);
        let electricChart = null;
        let gasChart = null;
        let activeClient = null;
        let activeAccount = null;  // Track active account (child) under active client
        
        // Helper to get storage key for current context (parent or parent+child)
        function getContextKey() {
            if (activeAccount && activeClient) {
                return `${activeClient.id}_${activeAccount.id}`;
            } else if (activeClient) {
                return activeClient.id;
            }
            return null;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            renderUsageGrids();
            initCharts();
            initClientContext();
            loadHistory();
        });
        
        // Tabs
        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(`tab-${tab}`).classList.add('active');
                    
                    if (tab === 'history') loadHistory();
                });
            });
        }
        
        // Render Usage Grids
        function renderUsageGrids() {
            const electricGrid = document.getElementById('electricGrid');
            const gasGrid = document.getElementById('gasGrid');
            
            electricGrid.innerHTML = MONTHS.map((m, i) => `
                <div class="usage-item">
                    <label>${m}</label>
                    <input type="number" id="electric-${i}" value="0" min="0" 
                           onchange="updateElectric(${i}, this.value)" 
                           onfocus="this.select()">
                </div>
            `).join('');
            
            gasGrid.innerHTML = MONTHS.map((m, i) => `
                <div class="usage-item">
                    <label>${m}</label>
                    <input type="number" id="gas-${i}" value="0" min="0" class="gas"
                           onchange="updateGas(${i}, this.value)" 
                           onfocus="this.select()">
                </div>
            `).join('');
        }
        
        // Update handlers
        function updateElectric(index, value) {
            electricData[index] = parseFloat(value) || 0;
            updateSummary('electric');
            updateChart('electric');
        }
        
        function updateGas(index, value) {
            gasData[index] = parseFloat(value) || 0;
            updateSummary('gas');
            updateChart('gas');
        }
        
        // Update Summary
        function updateSummary(type) {
            const data = type === 'electric' ? electricData : gasData;
            const total = data.reduce((a, b) => a + b, 0);
            const avg = total / 12;
            const peakIndex = data.indexOf(Math.max(...data));
            const peak = data[peakIndex];
            
            document.getElementById(`total${type.charAt(0).toUpperCase() + type.slice(1)}`).textContent = total.toLocaleString();
            document.getElementById(`avg${type.charAt(0).toUpperCase() + type.slice(1)}`).textContent = Math.round(avg).toLocaleString();
            document.getElementById(`peak${type.charAt(0).toUpperCase() + type.slice(1)}`).textContent = peak > 0 ? MONTHS[peakIndex] : '-';
            document.getElementById(`peak${type.charAt(0).toUpperCase() + type.slice(1)}Value`).textContent = peak > 0 ? `${peak.toLocaleString()} ${type === 'electric' ? 'kWh' : 'Therms'}` : '';
        }
        
        // Charts
        function initCharts() {
            const chartConfig = (type) => ({
                type: 'bar',
                data: {
                    labels: MONTHS,
                    datasets: [{
                        label: type === 'electric' ? 'Electric (kWh)' : 'Gas (Therms)',
                        data: type === 'electric' ? electricData : gasData,
                        backgroundColor: type === 'electric' ? 'rgba(255, 107, 53, 0.7)' : 'rgba(59, 130, 246, 0.7)',
                        borderColor: type === 'electric' ? '#FF6B35' : '#3b82f6',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#a0aec0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#a0aec0' }
                        }
                    }
                }
            });
            
            electricChart = new Chart(document.getElementById('electricChart'), chartConfig('electric'));
            gasChart = new Chart(document.getElementById('gasChart'), chartConfig('gas'));
        }
        
        function updateChart(type) {
            const chart = type === 'electric' ? electricChart : gasChart;
            const data = type === 'electric' ? electricData : gasData;
            chart.data.datasets[0].data = [...data];
            chart.update();
        }
        
        // Client Context
        function initClientContext() {
            // Set up message listener FIRST (always works)
            window.addEventListener('message', handleMessage);
            console.log('[EnergyUtil] Message listener set up');
            
            // Request active client from parent
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'REQUEST_ACTIVE_CLIENT' }, '*');
                console.log('[EnergyUtil] Requested active client from parent');
            }
            
            // Try to directly access ClientStore from parent (with retry)
            tryConnectToClientStore(0);
        }
        
        function tryConnectToClientStore(attempt) {
            const maxAttempts = 10;
            const ClientStore = window.parent?.SecureEnergyClients || window.SecureEnergyClients;
            
            if (ClientStore) {
                console.log('[EnergyUtil] Connected to ClientStore on attempt', attempt + 1);
                
                // Get current active client and account directly
                const client = ClientStore.getActiveClient?.();
                const account = ClientStore.getActiveAccount?.();
                
                if (client) {
                    console.log('[EnergyUtil] Got active client from ClientStore:', client.name, 'Account:', account?.accountName);
                    setActiveClient(client, account);
                } else {
                    console.log('[EnergyUtil] No active client currently set');
                }
                
                // Subscribe to ClientStore events for real-time updates
                ClientStore.subscribe?.((event, data) => {
                    console.log('[EnergyUtil] ClientStore event received:', event);
                    if (event === 'activeClientChanged') {
                        console.log('[EnergyUtil] ClientStore activeClientChanged - Client:', data.client?.name);
                        setActiveClient(data.client, data.account || null);
                    }
                    if (event === 'activeAccountChanged') {
                        console.log('[EnergyUtil] ClientStore activeAccountChanged - Account:', data.account?.accountName);
                        setActiveAccount(data.account, data.client);
                    }
                });
                console.log('[EnergyUtil] Subscribed to ClientStore events');
            } else if (attempt < maxAttempts) {
                // Retry after a short delay
                console.log('[EnergyUtil] ClientStore not available, retrying... (attempt', attempt + 1, ')');
                setTimeout(() => tryConnectToClientStore(attempt + 1), 100);
            } else {
                console.warn('[EnergyUtil] Could not connect to ClientStore after', maxAttempts, 'attempts');
            }
        }
        
        function handleMessage(event) {
            const data = event.data;
            if (!data || !data.type) return;
            
            // Log all relevant messages for debugging
            if (data.type.includes('CLIENT') || data.type.includes('ACCOUNT')) {
                console.log('[EnergyUtil] Message received:', data.type, data);
            }
            
            if (data.type === 'ACTIVE_CLIENT_CHANGED' || data.type === 'ACTIVE_CLIENT_RESPONSE') {
                console.log('[EnergyUtil] Processing', data.type, '- Client:', data.client?.name, 'Account:', data.account?.accountName);
                setActiveClient(data.client, data.account || null);
            }
            
            if (data.type === 'ACTIVE_ACCOUNT_CHANGED') {
                console.log('[EnergyUtil] Processing ACTIVE_ACCOUNT_CHANGED - Account:', data.account?.accountName, 'Client:', data.client?.name);
                // Account changed under same client
                setActiveAccount(data.account, data.client);
            }
        }
        
        function setActiveClient(client, account = null) {
            console.log('[EnergyUtil] setActiveClient called - Client:', client?.name, 'Account:', account?.accountName);
            activeClient = client;
            activeAccount = account;
            updateContextIndicator();
            
            if (client) {
                loadContextUsage();
            }
        }
        
        function setActiveAccount(account, client = null) {
            console.log('[EnergyUtil] setActiveAccount called - Account:', account?.accountName, 'Client:', client?.name);
            // If client provided and different, update it
            if (client && (!activeClient || activeClient.id !== client.id)) {
                activeClient = client;
            }
            activeAccount = account;
            updateContextIndicator();
            loadContextUsage();
        }
        
        function updateContextIndicator() {
            const indicator = document.getElementById('clientIndicator');
            
            if (activeClient) {
                indicator.classList.remove('no-client');
                
                if (activeAccount) {
                    // Has both client and account
                    indicator.classList.add('has-account');
                    indicator.innerHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        <div class="context-display">
                            <span class="context-client">${activeClient.name}</span>
                            <span class="context-account">${activeAccount.accountName || activeAccount.id}</span>
                        </div>
                    `;
                } else {
                    // Client only, no account
                    indicator.classList.remove('has-account');
                    indicator.innerHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        <span id="clientName">${activeClient.name}</span>
                    `;
                }
            } else {
                indicator.classList.add('no-client');
                indicator.classList.remove('has-account');
                indicator.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <span id="clientName">No client selected</span>
                `;
            }
        }
        
        function loadContextUsage() {
            const contextKey = getContextKey();
            if (!contextKey) return;
            
            // Clear current data first
            electricData = Array(12).fill(0);
            gasData = Array(12).fill(0);
            
            // Try UsageProfileStore first (GitHub-synced centralized store)
            const ProfileStore = window.parent?.UsageProfileStore || window.UsageProfileStore;
            if (ProfileStore && ProfileStore.getByContext) {
                const profile = ProfileStore.getByContext(activeClient?.id, activeAccount?.id);
                if (profile && (profile.electricUsage?.some(v => v > 0) || profile.gasUsage?.some(v => v > 0))) {
                    electricData = [...(profile.electricUsage || Array(12).fill(0))];
                    gasData = [...(profile.gasUsage || Array(12).fill(0))];
                    updateUIFromData();
                    console.log('[EnergyUtil] Loaded from UsageProfileStore:', profile.name);
                    return;
                }
            }
            
            // Fallback: try localStorage with context key
            const stored = localStorage.getItem(`usage_${contextKey}`);
            if (stored) {
                try {
                    const profile = JSON.parse(stored);
                    if (profile.electric) {
                        electricData = [...profile.electric];
                    }
                    if (profile.gas) {
                        gasData = [...profile.gas];
                    }
                    updateUIFromData();
                    console.log('[EnergyUtil] Loaded from localStorage:', contextKey);
                    return;
                } catch {}
            }
            
            // Fallback: try client-only key if we have account but no account-specific data
            if (activeAccount && activeClient) {
                // First try UsageProfileStore for client-level
                if (ProfileStore && ProfileStore.getByContext) {
                    const clientProfile = ProfileStore.getByContext(activeClient.id, null);
                    if (clientProfile && (clientProfile.electricUsage?.some(v => v > 0) || clientProfile.gasUsage?.some(v => v > 0))) {
                        electricData = [...(clientProfile.electricUsage || Array(12).fill(0))];
                        gasData = [...(clientProfile.gasUsage || Array(12).fill(0))];
                        updateUIFromData();
                        showToast('Loaded parent-level usage (no account-specific data yet)', 'info');
                        console.log('[EnergyUtil] Loaded parent profile from UsageProfileStore');
                        return;
                    }
                }
                
                // Then try localStorage
                const clientOnlyKey = `usage_${activeClient.id}`;
                const clientStored = localStorage.getItem(clientOnlyKey);
                if (clientStored) {
                    try {
                        const profile = JSON.parse(clientStored);
                        if (profile.electric) {
                            electricData = [...profile.electric];
                        }
                        if (profile.gas) {
                            gasData = [...profile.gas];
                        }
                        updateUIFromData();
                        // Show toast that we're using parent-level data
                        showToast('Loaded parent-level usage (no account-specific data yet)', 'info');
                        return;
                    } catch {}
                }
            }
            
            // Check if client has usage in store
            if (window.parent?.SecureEnergyClients && activeClient) {
                const client = window.parent.SecureEnergyClients.getClient(activeClient.id);
                if (client?.usageProfile) {
                    electricData = [...(client.usageProfile.electric || Array(12).fill(0))];
                    gasData = [...(client.usageProfile.gas || Array(12).fill(0))];
                    updateUIFromData();
                    return;
                }
            }
            
            // No usage found - update UI with zeros and prompt
            updateUIFromData();
            
            if (activeClient) {
                const displayName = activeAccount 
                    ? `${activeClient.name} â†’ ${activeAccount.accountName || 'Account'}` 
                    : activeClient.name;
                document.getElementById('noUsageClientName').textContent = displayName;
                document.getElementById('noUsageModal').classList.add('show');
            }
        }
        
        function updateUIFromData() {
            electricData.forEach((v, i) => document.getElementById(`electric-${i}`).value = v);
            gasData.forEach((v, i) => document.getElementById(`gas-${i}`).value = v);
            updateSummary('electric');
            updateSummary('gas');
            updateChart('electric');
            updateChart('gas');
        }
        
        // Legacy function for backward compatibility
        function loadClientUsage(clientId) {
            loadContextUsage();
        }
        
        function closeNoUsageModal() {
            document.getElementById('noUsageModal').classList.remove('show');
        }
        
        function startUsageEntry() {
            closeNoUsageModal();
            // Switch to electric tab and focus first input
            document.querySelector('[data-tab="electric"]').click();
            setTimeout(() => document.getElementById('electric-0').focus(), 100);
        }
        
        // Save to Client
        async function saveToClient() {
            if (!activeClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const contextKey = getContextKey();
            const displayName = activeAccount 
                ? `${activeClient.name} â†’ ${activeAccount.accountName || 'Account'}` 
                : activeClient.name;
            
            const profile = {
                electric: [...electricData],
                gas: [...gasData],
                totalElectric: electricData.reduce((a, b) => a + b, 0),
                totalGas: gasData.reduce((a, b) => a + b, 0),
                clientId: activeClient.id,
                clientName: activeClient.name,
                accountId: activeAccount?.id || null,
                accountName: activeAccount?.accountName || null,
                updatedAt: new Date().toISOString()
            };
            
            // Save to parent's client store (at client level for aggregation)
            if (window.parent?.SecureEnergyClients) {
                window.parent.SecureEnergyClients.updateClient(activeClient.id, {
                    usageProfile: profile,
                    annualUsageMWh: profile.totalElectric / 1000 // Convert kWh to MWh
                });
            }
            
            // Save to localStorage with context key (quick local cache)
            localStorage.setItem(`usage_${contextKey}`, JSON.stringify(profile));
            
            // Save to UsageProfileStore for GitHub sync and cross-device availability
            await saveToUsageProfileStore(profile);
            
            // Log activity to ActivityLog
            logUsageActivity(profile);
            
            // Notify other widgets
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'CLIENT_USAGE_UPDATED',
                    clientId: activeClient.id,
                    accountId: activeAccount?.id || null,
                    contextKey: contextKey,
                    profile: profile
                }, '*');
            }
            
            showToast(`Usage saved for ${displayName}`, 'success');
        }
        
        // Save to UsageProfileStore (GitHub-synced centralized store)
        async function saveToUsageProfileStore(profile) {
            // Try to access UsageProfileStore from parent window
            const ProfileStore = window.parent?.UsageProfileStore || window.UsageProfileStore;
            
            if (ProfileStore && ProfileStore.createOrUpdateByContext) {
                try {
                    // Get user info for createdBy field
                    let userInfo = {};
                    try {
                        const user = window.parent?.UserStore?.getCurrentUser?.();
                        if (user) {
                            userInfo = {
                                createdBy: user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null,
                                createdByEmail: user.email || null
                            };
                        }
                    } catch (e) { /* ignore */ }
                    
                    const result = await ProfileStore.createOrUpdateByContext(
                        profile.clientId,
                        profile.accountId,
                        {
                            name: profile.accountName 
                                ? `${profile.clientName} â†’ ${profile.accountName}`
                                : profile.clientName,
                            clientName: profile.clientName,
                            accountName: profile.accountName,
                            electricUsage: profile.electric,
                            gasUsage: profile.gas,
                            totalElectric: profile.totalElectric,
                            totalGas: profile.totalGas,
                            ...userInfo
                        }
                    );
                    
                    if (result.success) {
                        console.log('[EnergyUtil] Profile saved to UsageProfileStore:', result.profile?.id);
                    } else {
                        console.warn('[EnergyUtil] UsageProfileStore save failed:', result.error);
                    }
                } catch (e) {
                    console.warn('[EnergyUtil] Failed to save to UsageProfileStore:', e);
                }
            } else {
                // Fallback: send message to parent to handle the save
                window.parent?.postMessage({
                    type: 'SAVE_USAGE_PROFILE',
                    clientId: profile.clientId,
                    accountId: profile.accountId,
                    profile: {
                        name: profile.accountName 
                            ? `${profile.clientName} â†’ ${profile.accountName}`
                            : profile.clientName,
                        clientName: profile.clientName,
                        accountName: profile.accountName,
                        electricUsage: profile.electric,
                        gasUsage: profile.gas,
                        totalElectric: profile.totalElectric,
                        totalGas: profile.totalGas
                    }
                }, '*');
                console.log('[EnergyUtil] Sent SAVE_USAGE_PROFILE message to parent');
            }
        }
        
        // Log usage entry to ActivityLog
        function logUsageActivity(profile) {
            // Try to get current user info
            let userInfo = { userId: null, userName: null, userEmail: null };
            try {
                // First try parent's UserStore
                if (window.parent?.UserStore) {
                    const user = window.parent.UserStore.getCurrentUser();
                    if (user) {
                        userInfo = {
                            userId: user.id || null,
                            userName: user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null,
                            userEmail: user.email || null
                        };
                    }
                }
                // Fallback to localStorage
                if (!userInfo.userId) {
                    const sessionData = localStorage.getItem('secureEnergy_currentUser');
                    if (sessionData) {
                        const user = JSON.parse(sessionData);
                        userInfo = {
                            userId: user.id || null,
                            userName: user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null,
                            userEmail: user.email || null
                        };
                    }
                }
            } catch (e) { 
                console.warn('[EnergyUtil] Could not get user info for activity log:', e);
            }
            
            // Try to use parent's ActivityLog
            if (window.parent?.ActivityLog?.logUsageEntry) {
                window.parent.ActivityLog.logUsageEntry({
                    ...userInfo,
                    clientId: profile.clientId,
                    clientName: profile.clientName,
                    accountId: profile.accountId,
                    accountName: profile.accountName,
                    totalElectric: profile.totalElectric,
                    totalGas: profile.totalGas,
                    electricData: profile.electric,
                    gasData: profile.gas
                });
                console.log('[EnergyUtil] Usage entry logged to ActivityLog');
            } else if (window.parent?.ActivityLog?.log) {
                // Fallback to generic log method
                window.parent.ActivityLog.log({
                    ...userInfo,
                    widget: 'energy-utilization',
                    action: 'Usage Entry',
                    clientName: profile.clientName,
                    data: {
                        clientId: profile.clientId,
                        clientName: profile.clientName,
                        accountId: profile.accountId,
                        accountName: profile.accountName,
                        totalElectric: profile.totalElectric,
                        totalGas: profile.totalGas
                    }
                });
                console.log('[EnergyUtil] Usage entry logged to ActivityLog (generic)');
            } else {
                // Send message to parent to log
                window.parent?.postMessage({
                    type: 'LOG_USAGE_ACTIVITY',
                    ...userInfo,
                    clientId: profile.clientId,
                    clientName: profile.clientName,
                    accountId: profile.accountId,
                    accountName: profile.accountName,
                    totalElectric: profile.totalElectric,
                    totalGas: profile.totalGas,
                    electricData: profile.electric,
                    gasData: profile.gas
                }, '*');
                console.log('[EnergyUtil] Usage entry sent via postMessage');
            }
        }
        
        // Clear Usage
        function clearUsage(type) {
            if (type === 'electric') {
                electricData = Array(12).fill(0);
                MONTHS.forEach((_, i) => document.getElementById(`electric-${i}`).value = 0);
                updateSummary('electric');
                updateChart('electric');
            } else {
                gasData = Array(12).fill(0);
                MONTHS.forEach((_, i) => document.getElementById(`gas-${i}`).value = 0);
                updateSummary('gas');
                updateChart('gas');
            }
        }
        
        // ============================================================
        // ENHANCED EXPORT WITH METADATA
        // ============================================================
        function exportUsage() {
            const wb = XLSX.utils.book_new();
            
            // Get metadata rows
            const metadataRows = ExportMetadata.generateMetadataRows({
                'Total Electric Usage': electricData.reduce((a, b) => a + b, 0).toLocaleString() + ' kWh',
                'Total Gas Usage': gasData.reduce((a, b) => a + b, 0).toLocaleString() + ' Therms',
                'Peak Electric Month': MONTHS[electricData.indexOf(Math.max(...electricData))] || 'N/A',
                'Peak Gas Month': MONTHS[gasData.indexOf(Math.max(...gasData))] || 'N/A'
            });
            
            // Create combined data with metadata
            const data = [
                ...metadataRows,
                ['MONTHLY USAGE DATA'],
                ['Month', 'Electric (kWh)', 'Gas (Therms)'],
                ...FULL_MONTHS.map((m, i) => [m, electricData[i], gasData[i]]),
                ['', '', ''],
                ['TOTALS', electricData.reduce((a, b) => a + b, 0), gasData.reduce((a, b) => a + b, 0)],
                ['AVERAGES', Math.round(electricData.reduce((a, b) => a + b, 0) / 12), Math.round(gasData.reduce((a, b) => a + b, 0) / 12)]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Set column widths
            ws['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 20 }];
            
            // Add merge for title
            ws['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Usage Profile');
            
            // Generate filename with client name and date
            const filename = ExportMetadata.generateFilename('Usage_Profile');
            
            XLSX.writeFile(wb, filename);
            showToast('Usage profile exported with metadata', 'success');
        }
        
        // Import
        function showImportModal() {
            document.getElementById('importModal').classList.add('show');
        }
        
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('show');
            document.getElementById('importFile').value = '';
        }
        
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    
                    // Try to find the data sheet (could be "Usage Data" from template or first sheet)
                    let ws = wb.Sheets['Usage Data'] || wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    
                    const importType = document.getElementById('importType').value;
                    
                    // Try to parse - expect Month, Electric, Gas columns or just Month, Value
                    let startRow = 0;
                    // Find the header row (look for "Month" or similar)
                    for (let i = 0; i < Math.min(json.length, 10); i++) {
                        const row = json[i];
                        if (row && row[0] && typeof row[0] === 'string' && 
                            row[0].toLowerCase().includes('month')) {
                            startRow = i + 1;
                            break;
                        }
                    }
                    
                    let importedCount = 0;
                    json.forEach((row, i) => {
                        if (i < startRow) return; // Skip header and anything before
                        const monthIndex = i - startRow;
                        if (monthIndex >= 12) return; // Only 12 months
                        
                        if (importType === 'electric' || importType === 'both') {
                            const elecVal = parseFloat(row[1]) || 0;
                            electricData[monthIndex] = elecVal;
                            document.getElementById(`electric-${monthIndex}`).value = elecVal;
                            if (elecVal > 0) importedCount++;
                        }
                        
                        if (importType === 'gas' || importType === 'both') {
                            const gasVal = parseFloat(importType === 'both' ? row[2] : row[1]) || 0;
                            gasData[monthIndex] = gasVal;
                            document.getElementById(`gas-${monthIndex}`).value = gasVal;
                            if (gasVal > 0) importedCount++;
                        }
                    });
                    
                    updateSummary('electric');
                    updateSummary('gas');
                    updateChart('electric');
                    updateChart('gas');
                    
                    closeImportModal();
                    showToast(`Imported ${importedCount} values successfully`, 'success');
                } catch (err) {
                    showToast('Failed to parse file', 'error');
                    console.error(err);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // History
        function loadHistory() {
            const list = document.getElementById('historyList');
            
            // Get all saved profiles from localStorage
            const profiles = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('usage_')) {
                    try {
                        const profile = JSON.parse(localStorage.getItem(key));
                        const contextKey = key.replace('usage_', '');
                        
                        // Parse context key - could be "clientId" or "clientId_accountId"
                        const parts = contextKey.split('_');
                        const clientId = parts[0];
                        const accountId = parts.length > 1 ? parts.slice(1).join('_') : null;
                        
                        let displayName = contextKey;
                        let clientName = clientId;
                        let accountName = null;
                        
                        // Try to get names from store
                        if (window.parent?.SecureEnergyClients) {
                            const client = window.parent.SecureEnergyClients.getClient(clientId);
                            if (client) {
                                clientName = client.name;
                                displayName = client.name;
                                
                                // If there's an account ID, try to find account name
                                if (accountId && client.accounts) {
                                    const account = client.accounts.find(a => a.id === accountId);
                                    if (account) {
                                        accountName = account.accountName || accountId;
                                        displayName = `${clientName} â†’ ${accountName}`;
                                    }
                                }
                            }
                        }
                        
                        // Use stored names as fallback
                        if (profile.clientName) clientName = profile.clientName;
                        if (profile.accountName) accountName = profile.accountName;
                        if (accountName && clientName) {
                            displayName = `${clientName} â†’ ${accountName}`;
                        } else if (clientName) {
                            displayName = clientName;
                        }
                        
                        profiles.push({
                            contextKey,
                            clientId,
                            accountId,
                            clientName,
                            accountName,
                            displayName,
                            ...profile
                        });
                    } catch {}
                }
            }
            
            // Sort by update date (most recent first)
            profiles.sort((a, b) => {
                const dateA = a.updatedAt ? new Date(a.updatedAt) : new Date(0);
                const dateB = b.updatedAt ? new Date(b.updatedAt) : new Date(0);
                return dateB - dateA;
            });
            
            if (profiles.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        <p>No saved usage profiles yet</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = profiles.map(p => `
                <div class="history-item">
                    <div class="history-item-info">
                        <div class="history-item-title">${p.displayName}</div>
                        <div class="history-item-meta">
                            ${p.totalElectric?.toLocaleString() || 0} kWh | ${p.totalGas?.toLocaleString() || 0} Therms
                            ${p.updatedAt ? ' | ' + new Date(p.updatedAt).toLocaleDateString() : ''}
                            ${p.accountId ? ' <span style="color:#3b82f6;">â— Account</span>' : ''}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="loadProfile('${p.contextKey}')">Load</button>
                </div>
            `).join('');
        }
        
        function loadProfile(contextKey) {
            // Parse context key to get client and account IDs
            const parts = contextKey.split('_');
            const clientId = parts[0];
            const accountId = parts.length > 1 ? parts.slice(1).join('_') : null;
            
            // Load from localStorage
            const stored = localStorage.getItem(`usage_${contextKey}`);
            if (stored) {
                try {
                    const profile = JSON.parse(stored);
                    electricData = [...(profile.electric || Array(12).fill(0))];
                    gasData = [...(profile.gas || Array(12).fill(0))];
                    updateUIFromData();
                    
                    // Update display
                    let displayName = contextKey;
                    if (window.parent?.SecureEnergyClients) {
                        const client = window.parent.SecureEnergyClients.getClient(clientId);
                        if (client) {
                            displayName = client.name;
                            if (accountId && client.accounts) {
                                const account = client.accounts.find(a => a.id === accountId);
                                if (account) {
                                    displayName = `${client.name} â†’ ${account.accountName || accountId}`;
                                }
                            }
                        }
                    }
                    
                    document.querySelector('[data-tab="electric"]').click();
                    showToast(`Loaded profile for ${displayName}`, 'success');
                } catch (e) {
                    showToast('Failed to load profile', 'error');
                }
            }
        }
        
        // Toast
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
