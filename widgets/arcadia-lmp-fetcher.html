<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcadia LMP Fetcher - COMPLETE</title>
    <style>
        :root {
            --se-gradient: linear-gradient(135deg, #004D40 0%, #3EB489 100%);
            --bg-primary: #0A0E1A;
            --bg-secondary: #131824;
            --bg-tertiary: #1A2030;
            --text-primary: #FFFFFF;
            --text-secondary: #A0AEC0;
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-success: #00E676;
            --accent-error: #FF5252;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
        }
        
        .header { margin-bottom: 20px; }
        .header h2 { font-size: 18px; color: #3EB489; margin-bottom: 6px; }
        .header .badge { 
            display: inline-block; background: var(--accent-success); 
            color: white; padding: 3px 10px; border-radius: 4px; 
            font-size: 10px; margin-left: 8px; font-weight: 700;
        }
        
        .alert-box {
            background: rgba(0, 230, 118, 0.1); border: 1px solid rgba(0, 230, 118, 0.3);
            border-radius: 8px; padding: 15px; margin-bottom: 20px;
        }
        .alert-box h4 { color: var(--accent-success); font-size: 14px; margin-bottom: 8px; }
        .alert-box ul { margin-left: 20px; margin-top: 8px; }
        .alert-box li { font-size: 11px; color: var(--text-secondary); line-height: 1.6; }
        
        .section {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 16px; margin-bottom: 15px;
        }
        .section-title {
            font-size: 14px; font-weight: 600; margin-bottom: 12px;
            padding-bottom: 8px; border-bottom: 2px solid #3EB489;
        }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { 
            display: block; font-size: 11px; font-weight: 600; 
            color: var(--text-secondary); margin-bottom: 4px; 
        }
        .form-group input, .form-group select {
            width: 100%; padding: 8px 10px; background: var(--bg-tertiary);
            border: 1px solid var(--border-color); border-radius: 6px;
            color: var(--text-primary); font-size: 13px;
        }
        
        button {
            padding: 10px 18px; border: none; border-radius: 6px;
            font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: var(--se-gradient); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); }
        .btn-success { background: linear-gradient(135deg, #00C853, #00E676); color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .iso-grid { display: flex; gap: 10px; flex-wrap: wrap; }
        .iso-btn {
            padding: 12px 24px; background: var(--bg-tertiary); color: var(--text-primary);
            border: 2px solid var(--border-color); border-radius: 8px; font-weight: 600;
            font-size: 13px; cursor: pointer; transition: all 0.2s;
        }
        .iso-btn:hover { border-color: #3EB489; transform: translateY(-2px); }
        .iso-btn.active { background: var(--se-gradient); border-color: #3EB489; }
        
        .zones-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px; max-height: 400px; overflow-y: auto; padding: 12px;
            background: var(--bg-tertiary); border-radius: 6px;
        }
        .zone-item {
            display: flex; align-items: center; padding: 8px 12px;
            background: var(--bg-primary); border-radius: 6px; font-size: 12px; cursor: pointer;
            transition: all 0.2s;
        }
        .zone-item:hover { background: rgba(62, 180, 137, 0.15); transform: translateX(3px); }
        .zone-item input { margin-right: 8px; width: 16px; height: 16px; cursor: pointer; }
        
        .loading { display: none; text-align: center; padding: 30px; }
        .loading.active { display: block; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--bg-tertiary);
            border-top-color: #3EB489; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .results-section { display: none; margin-top: 20px; }
        .results-section.active { display: block; }
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px; margin-bottom: 20px; 
        }
        .stat-card { background: var(--se-gradient); padding: 16px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .stat-label { font-size: 11px; opacity: 0.9; text-transform: uppercase; }
        
        .data-table-container { 
            overflow-x: auto; border-radius: 8px; border: 1px solid var(--border-color); 
            max-height: 450px; overflow-y: auto; 
        }
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .data-table thead { background: var(--bg-tertiary); position: sticky; top: 0; z-index: 10; }
        .data-table th, .data-table td { 
            padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); 
        }
        .data-table tbody tr:hover { background: var(--bg-tertiary); }
        
        .status-message {
            padding: 12px 16px; border-radius: 6px; margin-top: 15px;
            font-size: 13px; display: none; font-weight: 500;
        }
        .status-message.active { display: block; }
        .status-message.success { 
            background: rgba(0, 230, 118, 0.1); color: var(--accent-success); 
            border: 1px solid rgba(0, 230, 118, 0.3);
        }
        .status-message.error { 
            background: rgba(255, 82, 82, 0.1); color: var(--accent-error); 
            border: 1px solid rgba(255, 82, 82, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>âš¡ Arcadia LMP Data Fetcher <span class="badge">âœ… ALL ISOS WORKING</span></h2>
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                Complete API-Verified Zone IDs â€¢ 5 ISOs â€¢ 79 Total Zones
            </p>
            <div style="font-size: 10px; color: #718096; margin-top: 4px;">
                v5.0.1 FINAL â€¢ CORS Proxy Failover â€¢ Auto-generated from API Discovery Tool
            </div>
        </div>
        
        <div class="alert-box">
            <h4>ðŸŽ‰ Complete Zone Discovery Applied!</h4>
            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                This fetcher uses zone IDs discovered directly from the Genability API
            </p>
            <ul>
                <li><strong>ERCOT:</strong> 8 zones (AEN, CPS, HOUSTON, LCRA, NORTH, RAYBN, SOUTH, WEST)</li>
                <li><strong>ISO-NE:</strong> 8 zones (Maine, NH, Vermont, Connecticut, RI, SEMA, WCMA, NEMA)</li>
                <li><strong>MISO:</strong> 8 zones (ARKANSAS, ILLINOIS, INDIANA, LOUISIANA, MICHIGAN, MINN, MS, TEXAS)</li>
                <li><strong>NYISO:</strong> 15 zones (All 11 main zones + 4 hub zones)</li>
                <li><strong>PJM:</strong> 40 zones (All 21 main zones + 19 additional hub/aggregate zones)</li>
            </ul>
        </div>
        
        <div class="section">
            <div class="section-title">1. Genability API Credentials</div>
            <div class="form-row">
                <div class="form-group">
                    <label>App ID</label>
                    <input type="text" id="appId" placeholder="Enter Genability App ID">
                </div>
                <div class="form-group">
                    <label>App Key</label>
                    <input type="password" id="appKey" placeholder="Enter Genability App Key">
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">2. Date Range</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="endDate">
                </div>
            </div>
            <p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                ðŸ’¡ Use past dates only (yesterday and earlier) - future dates have no data
            </p>
        </div>
        
        <div class="section">
            <div class="section-title">3. Select ISO Market</div>
            <div class="iso-grid" id="isoSelector"></div>
        </div>
        
        <div class="section" id="zoneSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div class="section-title" style="margin: 0; border: none; padding: 0;">4. Select Zones</div>
                <button class="btn-primary" onclick="toggleSelectAll()" style="padding: 6px 14px; font-size: 11px;">
                    Select All
                </button>
            </div>
            <div class="zones-grid" id="zonesGrid"></div>
        </div>
        
        <div class="section">
            <button class="btn-primary" onclick="fetchData()" style="width: 100%; padding: 14px; font-size: 14px;">
                âš¡ Fetch Hourly LMP Data
            </button>
            <button class="btn-success" id="exportBtn" onclick="exportCSV()" style="width: 100%; margin-top: 12px; padding: 12px;" disabled>
                ðŸ“¥ Export CSV
            </button>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: var(--text-secondary); font-size: 13px; font-weight: 500;">Fetching hourly data from Genability API...</p>
        </div>
        
        <div class="section results-section" id="resultsSection">
            <div class="section-title">ðŸ“Š Results - Hourly LMP Data</div>
            <div class="stats-grid" id="statsGrid"></div>
            <h4 style="margin-bottom: 12px; font-size: 13px; color: var(--text-secondary);">
                Hourly Records (First 100 shown)
            </h4>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ISO</th>
                            <th>Zone</th>
                            <th>Zone ID</th>
                            <th>DateTime</th>
                            <th>Price ($/MWh)</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // COMPLETE ISO CONFIGURATION
        // Auto-generated from API Zone Discovery
        // ============================================
        const ISO_CONFIG = {
            ERCOT: {
                name: 'ERCOT',
                propertyKey: 'hourlyPricingDayAheadERCOT',
                zones: [
                    { value: 'AEN', label: 'AEN', dbName: 'AEN' },
                    { value: 'CPS', label: 'CPS Energy', dbName: 'CPS' },
                    { value: 'HOUSTON', label: 'Houston', dbName: 'HOUSTON' },
                    { value: 'LCRA', label: 'LCRA', dbName: 'LCRA' },
                    { value: 'NORTH', label: 'North', dbName: 'NORTH' },
                    { value: 'RAYBN', label: 'Rayburn', dbName: 'RAYBN' },
                    { value: 'SOUTH', label: 'South', dbName: 'SOUTH' },
                    { value: 'WEST', label: 'West', dbName: 'WEST' },
                ]
            },
            ISONE: {
                name: 'ISO-NE',
                propertyKey: 'hourlyPricingDayAheadISONE',
                zones: [
                    { value: '4001', label: 'Maine', dbName: '4001_Maine' },
                    { value: '4002', label: 'NH', dbName: '4002_NH' },
                    { value: '4003', label: 'Vermont', dbName: '4003_Vermont' },
                    { value: '4004', label: 'Connecticut', dbName: '4004_Connecticut' },
                    { value: '4005', label: 'Rhode Island', dbName: '4005_Rhode_Island' },
                    { value: '4006', label: 'SEMA', dbName: '4006_SEMA' },
                    { value: '4007', label: 'WCMA', dbName: '4007_WCMA' },
                    { value: '4008', label: 'NEMA', dbName: '4008_NEMA' },
                ]
            },
            MISO: {
                name: 'MISO',
                propertyKey: 'hourlyPricingDayAheadMISO',
                zones: [
                    { value: 'ARKANSAS', label: 'Arkansas', dbName: 'ARKANSAS' },
                    { value: 'ILLINOIS', label: 'Illinois', dbName: 'ILLINOIS' },
                    { value: 'INDIANA', label: 'Indiana', dbName: 'INDIANA' },
                    { value: 'LOUISIANA', label: 'Louisiana', dbName: 'LOUISIANA' },
                    { value: 'MICHIGAN', label: 'Michigan', dbName: 'MICHIGAN' },
                    { value: 'MINN', label: 'Minnesota', dbName: 'MINN' },
                    { value: 'MS', label: 'Mississippi', dbName: 'MS' },
                    { value: 'TEXAS', label: 'Texas', dbName: 'TEXAS' },
                ]
            },
            NYISO: {
                name: 'NYISO',
                propertyKey: 'hourlyPricingDayAheadNYISO',
                zones: [
                    { value: '61752', label: 'West (A)', dbName: '61752' },
                    { value: '61753', label: 'Genesee (B)', dbName: '61753' },
                    { value: '61754', label: 'Central (C)', dbName: '61754' },
                    { value: '61755', label: 'North (D)', dbName: '61755' },
                    { value: '61756', label: 'Mohawk Valley (E)', dbName: '61756' },
                    { value: '61757', label: 'Capital (F)', dbName: '61757' },
                    { value: '61758', label: 'Hudson Valley (G)', dbName: '61758' },
                    { value: '61759', label: 'Millwood (H)', dbName: '61759' },
                    { value: '61760', label: 'Dunwoodie (I)', dbName: '61760' },
                    { value: '61761', label: 'NYC (J)', dbName: '61761' },
                    { value: '61762', label: 'Long Island (K)', dbName: '61762' },
                    { value: '61844', label: 'Zone J Hub', dbName: '61844' },
                    { value: '61845', label: 'Zone K Hub', dbName: '61845' },
                    { value: '61846', label: 'Zone A Hub', dbName: '61846' },
                    { value: '61847', label: 'Zone F Hub', dbName: '61847' },
                ]
            },
            PJM: {
                name: 'PJM',
                propertyKey: 'hourlyPricingDayAheadPJM',
                zones: [
                    { value: '51291', label: 'AECO', dbName: 'AECO' },
                    { value: '51292', label: 'BGE', dbName: 'BGE' },
                    { value: '51293', label: 'DPL', dbName: 'DPL' },
                    { value: '51295', label: 'JCPL', dbName: 'JCPL' },
                    { value: '51296', label: 'Met-Ed', dbName: 'METED' },
                    { value: '51297', label: 'PECO', dbName: 'PECO' },
                    { value: '51298', label: 'Penelec', dbName: 'PENELEC' },
                    { value: '51299', label: 'Pepco', dbName: 'PEPCO' },
                    { value: '51300', label: 'PPL', dbName: 'PPL' },
                    { value: '51301', label: 'Duquesne', dbName: 'DUQ' },
                    { value: '7633629', label: 'EKPC', dbName: 'EKPC' },
                    { value: '8394954', label: 'APS', dbName: 'APS' },
                    { value: '8445784', label: 'AEP', dbName: 'AEP' },
                    { value: '33092371', label: 'ComEd', dbName: 'COMED' },
                    { value: '34508503', label: 'Dayton', dbName: 'DAY' },
                    { value: '34964545', label: 'Dominion', dbName: 'DOM' },
                    { value: '37737283', label: 'RECO', dbName: 'RECO' },
                    { value: '116013753', label: 'ATSI', dbName: 'ATSI' },
                    { value: '116472927', label: 'PJM Hub 927', dbName: '116472927' },
                    { value: '116472931', label: 'PJM Hub 931', dbName: '116472931' },
                    { value: '116472933', label: 'PJM Hub 933', dbName: '116472933' },
                    { value: '116472935', label: 'PJM Hub 935', dbName: '116472935' },
                    { value: '116472937', label: 'PJM Hub 937', dbName: '116472937' },
                    { value: '116472939', label: 'PJM Hub 939', dbName: '116472939' },
                    { value: '116472941', label: 'PJM Hub 941', dbName: '116472941' },
                    { value: '116472943', label: 'PJM Hub 943', dbName: '116472943' },
                    { value: '116472945', label: 'PJM Hub 945', dbName: '116472945' },
                    { value: '116472947', label: 'PJM Hub 947', dbName: '116472947' },
                    { value: '116472949', label: 'PJM Hub 949', dbName: '116472949' },
                    { value: '116472951', label: 'PJM Hub 951', dbName: '116472951' },
                    { value: '116472953', label: 'PJM Hub 953', dbName: '116472953' },
                    { value: '116472955', label: 'PJM Hub 955', dbName: '116472955' },
                    { value: '116472957', label: 'PJM Hub 957', dbName: '116472957' },
                    { value: '116472959', label: 'PJM Hub 959', dbName: '116472959' },
                    { value: '124076095', label: 'Duke Energy OH/KY', dbName: 'DEOK' },
                    { value: '126769999', label: 'Zone 999', dbName: '126769999' },
                    { value: '970242670', label: 'External', dbName: 'EXTERNAL' },
                    { value: '1069452904', label: 'Hub 904', dbName: '1069452904' },
                    { value: '1127872598', label: 'Hub 598', dbName: '1127872598' },
                    { value: '1258625176', label: 'Hub 176', dbName: '1258625176' },
                ]
            },
        };
        
        let currentISO = null;
        let selectedZones = [];
        let fetchedData = { hourly: [] };

        // ============================================
        // CORS PROXY FAILOVER CHAIN
        // Auto-rotates if a proxy goes down
        // ============================================
        const CORS_PROXIES = [
            {
                name: 'allorigins',
                buildUrl: (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
            },
            {
                name: 'corsproxy.io',
                buildUrl: (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`
            },
            {
                name: 'corsproxy.org',
                buildUrl: (url) => `https://corsproxy.org/?${encodeURIComponent(url)}`
            }
        ];
        let currentProxyIndex = 0;

        function getProxyUrl(targetUrl) {
            return CORS_PROXIES[currentProxyIndex].buildUrl(targetUrl);
        }

        function tryNextProxy() {
            if (currentProxyIndex < CORS_PROXIES.length - 1) {
                currentProxyIndex++;
                console.log(`[CORS] Switching to proxy: ${CORS_PROXIES[currentProxyIndex].name}`);
                return true;
            }
            return false;
        }

        function init() {
            // Set dates to past week
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            
            document.getElementById('endDate').value = yesterday.toISOString().split('T')[0];
            document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
            
            // Build ISO selector
            const sel = document.getElementById('isoSelector');
            Object.keys(ISO_CONFIG).forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'iso-btn';
                btn.textContent = `${ISO_CONFIG[key].name} (${ISO_CONFIG[key].zones.length})`;
                btn.onclick = () => selectISO(key);
                sel.appendChild(btn);
            });
        }
        
        function selectISO(iso) {
            currentISO = iso;
            selectedZones = [];
            
            document.querySelectorAll('.iso-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            const grid = document.getElementById('zonesGrid');
            grid.innerHTML = '';
            
            ISO_CONFIG[iso].zones.forEach(zone => {
                const item = document.createElement('div');
                item.className = 'zone-item';
                item.innerHTML = `<input type="checkbox" value="${zone.value}" id="zone_${zone.value}"> <label for="zone_${zone.value}" style="cursor: pointer;">${zone.label}</label>`;
                item.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const checkbox = item.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                    }
                    updateSelectedZones();
                };
                grid.appendChild(item);
            });
            
            document.getElementById('zoneSection').style.display = 'block';
        }
        
        function updateSelectedZones() {
            selectedZones = Array.from(document.querySelectorAll('.zone-item input:checked')).map(i => i.value);
        }
        
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.zone-item input');
            const allChecked = Array.from(checkboxes).every(c => c.checked);
            checkboxes.forEach(c => c.checked = !allChecked);
            updateSelectedZones();
        }
        
        function showStatus(msg, type = 'info') {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = `status-message active ${type}`;
        }
        
        async function fetchData() {
            if (!currentISO || !selectedZones.length) {
                showStatus('âŒ Please select an ISO and at least one zone', 'error');
                return;
            }
            
            const appId = document.getElementById('appId').value.trim();
            const appKey = document.getElementById('appKey').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!appId || !appKey) {
                showStatus('âŒ Please enter API credentials', 'error');
                return;
            }
            
            if (!startDate || !endDate) {
                showStatus('âŒ Please select date range', 'error');
                return;
            }
            
            document.getElementById('loading').classList.add('active');
            document.getElementById('resultsSection').classList.remove('active');
            
            const creds = btoa(`${appId}:${appKey}`);
            const cfg = ISO_CONFIG[currentISO];
            fetchedData = { hourly: [] };
            
            try {
                for (const zid of selectedZones) {
                    const zoneObj = cfg.zones.find(z => z.value === zid);
                    const recs = await fetchZoneData(creds, cfg.propertyKey, zid, startDate, endDate);
                    
                    if (recs.length) {
                        fetchedData.hourly.push(...recs.map(r => ({ 
                            ...r, 
                            zone: zoneObj.dbName,
                            zone_id: zid, 
                            iso: currentISO 
                        })));
                    }
                }
                
                if (fetchedData.hourly.length > 0) {
                    displayResults();
                    showStatus(`âœ… Successfully fetched ${fetchedData.hourly.length.toLocaleString()} hourly records!`, 'success');
                    document.getElementById('exportBtn').disabled = false;
                } else {
                    showStatus('âš ï¸ No data found for selected zones and date range', 'error');
                }
            } catch (e) {
                showStatus(`âŒ Error: ${e.message}`, 'error');
            } finally { 
                document.getElementById('loading').classList.remove('active'); 
            }
        }
        
        async function fetchZoneData(creds, propKey, zoneId, start, end) {
            const base = 'https://api.genability.com/rest/public/properties';
            let all = [];
            let page = 0;
            let more = true;
            
            while (more) {
                const params = new URLSearchParams({ 
                    subKeyName: zoneId,
                    fromDateTime: `${start}T00:00:00`,
                    toDateTime: `${end}T23:59:59`,
                    pageStart: page,
                    pageCount: 1000
                });
                
                const rawUrl = `${base}/${propKey}/lookups?${params}`;
                let fetched = false;
                let lastError = null;

                // Try current proxy, failover to next on error
                const startProxy = currentProxyIndex;
                do {
                    const proxyUrl = getProxyUrl(rawUrl);
                    try {
                        console.log(`[CORS] Using ${CORS_PROXIES[currentProxyIndex].name} for ${zoneId} page ${page}`);
                        
                        const res = await fetch(proxyUrl, {
                            method: 'GET',
                            headers: { 
                                'Authorization': `Basic ${creds}`,
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (res.status === 401) throw new Error('Invalid API credentials');
                        
                        if (!res.ok) {
                            throw new Error(`Proxy ${CORS_PROXIES[currentProxyIndex].name} returned ${res.status}`);
                        }

                        const data = await res.json();
                        
                        if (data.results?.length) {
                            all.push(...data.results.map(i => ({ 
                                datetime: i.fromDateTime,
                                price: parseFloat(i.actualValue || i.bestValue || 0)
                            })).filter(r => !isNaN(r.price)));
                            
                            more = data.count > page + 1000;
                            page += 1000;
                        } else {
                            more = false;
                        }
                        fetched = true;

                    } catch (err) {
                        lastError = err;
                        // Don't rotate on auth errors
                        if (err.message.includes('Invalid API credentials')) throw err;
                        
                        console.warn(`[CORS] ${CORS_PROXIES[currentProxyIndex].name} failed: ${err.message}`);
                        if (!tryNextProxy()) {
                            currentProxyIndex = 0; // reset for next call
                            break;
                        }
                    }
                } while (!fetched);

                if (!fetched) {
                    throw new Error(`All CORS proxies failed for ${zoneId}. Last error: ${lastError?.message || 'unknown'}`);
                }
            }
            
            return all;
        }
        
        function displayResults() {
            document.getElementById('resultsSection').classList.add('active');
            const total = fetchedData.hourly.length;
            
            const prices = fetchedData.hourly.map(r => r.price);
            const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const uniqueZones = new Set(fetchedData.hourly.map(r => r.zone)).size;
            
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total.toLocaleString()}</div>
                    <div class="stat-label">Hourly Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${uniqueZones}</div>
                    <div class="stat-label">Zones</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${avgPrice.toFixed(2)}</div>
                    <div class="stat-label">Avg $/MWh</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${minPrice.toFixed(2)}</div>
                    <div class="stat-label">Min Price</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${maxPrice.toFixed(2)}</div>
                    <div class="stat-label">Max Price</div>
                </div>
            `;
            
            const displayData = fetchedData.hourly.slice(0, 100);
            document.getElementById('resultsBody').innerHTML = displayData.map(r => 
                `<tr>
                    <td><strong>${r.iso}</strong></td>
                    <td>${r.zone}</td>
                    <td style="color: #718096;">${r.zone_id}</td>
                    <td>${new Date(r.datetime).toLocaleString()}</td>
                    <td style="color: #3EB489; font-weight: 600;">$${r.price.toFixed(4)}</td>
                </tr>`
            ).join('');
            
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function exportCSV() {
            if (!fetchedData.hourly.length) return;
            
            const csv = [
                'ISO,Zone,Zone_ID,DateTime,Price_$/MWh',
                ...fetchedData.hourly.map(r => 
                    `${r.iso},${r.zone},${r.zone_id},${r.datetime},${r.price.toFixed(4)}`
                )
            ].join('\n');
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            a.download = `lmp_hourly_${currentISO}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
