<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcadia LMP Data Fetcher</title>
    <style>
        :root {
            --se-dark-green: #004D40;
            --se-light-green: #3EB489;
            --se-gradient: linear-gradient(135deg, #004D40 0%, #3EB489 100%);
            --bg-primary: #0A0E1A;
            --bg-secondary: #131824;
            --bg-tertiary: #1A2030;
            --bg-elevated: #222938;
            --text-primary: #FFFFFF;
            --text-secondary: #A0AEC0;
            --text-tertiary: #718096;
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-success: #00E676;
            --accent-warning: #FFB300;
            --accent-error: #FF5252;
            --accent-info: #00B8D4;
            --accent-purple: #B388FF;
            --accent-azure: #0078D4;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
        }
        
        .header { margin-bottom: 20px; }
        .header h2 { font-size: 18px; color: var(--se-light-green); margin-bottom: 6px; }
        .header p { font-size: 12px; color: var(--text-secondary); }
        .header .version { font-size: 10px; color: var(--text-tertiary); margin-top: 4px; }
        .header .azure-badge { display: inline-block; background: var(--accent-azure); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px; }
        
        .mode-tabs {
            display: flex; gap: 0; margin-bottom: 16px;
            background: var(--bg-secondary); border-radius: 10px; padding: 4px; border: 1px solid var(--border-color);
        }
        .mode-tab {
            flex: 1; padding: 12px 16px; background: transparent; border: none;
            color: var(--text-secondary); font-size: 13px; font-weight: 600;
            cursor: pointer; border-radius: 8px; transition: all 0.2s;
        }
        .mode-tab:hover { color: var(--text-primary); }
        .mode-tab.active { background: var(--se-gradient); color: white; }
        .mode-tab .tab-icon { margin-right: 8px; }
        
        .mode-content { display: none; }
        .mode-content.active { display: block; }
        
        .server-notice {
            background: rgba(179, 136, 255, 0.1); border: 1px solid rgba(179, 136, 255, 0.3);
            border-radius: 8px; padding: 12px; margin-bottom: 16px;
        }
        .server-notice h4 { color: var(--accent-purple); font-size: 13px; margin-bottom: 6px; }
        .server-notice p { font-size: 11px; color: var(--text-secondary); line-height: 1.4; }
        
        .azure-notice {
            background: rgba(0, 120, 212, 0.1); border: 1px solid rgba(0, 120, 212, 0.3);
            border-radius: 8px; padding: 12px; margin-bottom: 16px;
        }
        .azure-notice h4 { color: var(--accent-azure); font-size: 13px; margin-bottom: 6px; }
        .azure-notice p { font-size: 11px; color: var(--text-secondary); line-height: 1.4; }
        
        .cors-notice {
            background: rgba(255, 179, 0, 0.1); border: 1px solid rgba(255, 179, 0, 0.3);
            border-radius: 8px; padding: 12px; margin-bottom: 16px;
        }
        .cors-notice h4 { color: var(--accent-warning); font-size: 13px; margin-bottom: 6px; }
        .cors-notice p { font-size: 11px; color: var(--text-secondary); line-height: 1.4; }
        
        .section {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 16px; margin-bottom: 12px;
        }
        .section-title {
            font-size: 14px; font-weight: 600; margin-bottom: 12px;
            padding-bottom: 6px; border-bottom: 2px solid var(--se-light-green);
        }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; }
        .form-group input, .form-group select {
            width: 100%; padding: 8px 10px; background: var(--bg-tertiary);
            border: 1px solid var(--border-color); border-radius: 6px;
            color: var(--text-primary); font-size: 13px; transition: all 0.2s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--se-light-green);
            box-shadow: 0 0 0 2px rgba(62, 180, 137, 0.1);
        }
        .form-group .helper-text { font-size: 10px; color: var(--text-tertiary); margin-top: 4px; }
        
        button {
            padding: 8px 16px; border: none; border-radius: 6px;
            font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: var(--se-gradient); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(62, 180, 137, 0.3); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-success { background: linear-gradient(135deg, #00C853, #00E676); color: white; }
        .btn-purple { background: linear-gradient(135deg, #7C4DFF, #B388FF); color: white; }
        .btn-purple:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(179, 136, 255, 0.3); }
        .btn-azure { background: linear-gradient(135deg, #0078D4, #00BCF2); color: white; }
        .btn-azure:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .button-group { display: flex; gap: 10px; margin-top: 12px; }
        
        .iso-grid { display: flex; gap: 8px; flex-wrap: wrap; }
        .iso-btn {
            padding: 10px 20px; background: var(--bg-tertiary); color: var(--text-primary);
            border: 1px solid var(--border-color); border-radius: 6px; font-weight: 600;
        }
        .iso-btn:hover { border-color: var(--se-light-green); }
        .iso-btn.active { background: var(--se-gradient); border-color: var(--se-light-green); }
        
        .zones-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px; max-height: 150px; overflow-y: auto; padding: 10px;
            background: var(--bg-tertiary); border-radius: 6px;
        }
        .zone-item {
            display: flex; align-items: center; padding: 6px 10px;
            background: var(--bg-elevated); border-radius: 4px; font-size: 12px; cursor: pointer;
        }
        .zone-item:hover { background: rgba(62, 180, 137, 0.1); }
        .zone-item input { margin-right: 6px; width: 14px; height: 14px; }
        
        .status-message {
            padding: 10px 14px; border-radius: 6px; margin-top: 12px;
            font-size: 12px; display: none; align-items: center; gap: 8px;
        }
        .status-message.active { display: flex; }
        .status-message.success { background: rgba(0, 230, 118, 0.1); color: var(--accent-success); border: 1px solid rgba(0, 230, 118, 0.2); }
        .status-message.error { background: rgba(255, 82, 82, 0.1); color: var(--accent-error); border: 1px solid rgba(255, 82, 82, 0.2); }
        .status-message.info { background: rgba(0, 184, 212, 0.1); color: var(--accent-info); border: 1px solid rgba(0, 184, 212, 0.2); }
        .status-message.warning { background: rgba(255, 179, 0, 0.1); color: var(--accent-warning); border: 1px solid rgba(255, 179, 0, 0.2); }
        
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.active { display: block; }
        .spinner {
            width: 32px; height: 32px; border: 3px solid var(--bg-tertiary);
            border-top-color: var(--se-light-green); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .debug-console {
            background: #0D1117; border: 1px solid var(--border-color); border-radius: 6px;
            padding: 12px; font-family: 'Consolas', monospace; font-size: 11px;
            max-height: 250px; overflow-y: auto; display: none; margin-top: 12px;
        }
        .debug-console.active { display: block; }
        .debug-line { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .debug-line.success { color: var(--accent-success); }
        .debug-line.error { color: var(--accent-error); }
        .debug-line.warning { color: var(--accent-warning); }
        .debug-line.info { color: var(--accent-info); }
        .debug-line.azure { color: var(--accent-azure); }
        .debug-timestamp { color: var(--text-tertiary); margin-right: 6px; }
        .debug-actions { display: flex; gap: 8px; margin-bottom: 8px; }
        
        .results-section { display: none; }
        .results-section.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 16px; }
        .stat-card { background: var(--se-gradient); padding: 12px; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 20px; font-weight: 700; margin-bottom: 2px; }
        .stat-label { font-size: 10px; opacity: 0.9; }
        
        .data-table-container { overflow-x: auto; border-radius: 6px; border: 1px solid var(--border-color); }
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .data-table thead { background: var(--bg-tertiary); }
        .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table tbody tr:hover { background: var(--bg-tertiary); }
        
        .proxy-mode {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 12px;
        }
        .proxy-toggle { position: relative; width: 40px; height: 22px; }
        .proxy-toggle input { opacity: 0; width: 0; height: 0; }
        .proxy-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-elevated); border-radius: 22px; transition: 0.2s;
        }
        .proxy-slider:before {
            position: absolute; content: ""; height: 16px; width: 16px;
            left: 3px; bottom: 3px; background: var(--text-secondary);
            border-radius: 50%; transition: 0.2s;
        }
        .proxy-toggle input:checked + .proxy-slider { background: var(--se-light-green); }
        .proxy-toggle input:checked + .proxy-slider:before { transform: translateX(18px); background: white; }
        
        .workflow-status { background: var(--bg-tertiary); border-radius: 8px; padding: 16px; margin-top: 16px; }
        .workflow-status h4 { font-size: 13px; color: var(--text-primary); margin-bottom: 12px; }
        .workflow-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 12px; }
        .workflow-item:last-child { border-bottom: none; }
        .workflow-badge { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-decoration: none; }
        .workflow-badge.success { background: rgba(0, 230, 118, 0.2); color: var(--accent-success); }
        .workflow-badge.pending { background: rgba(255, 179, 0, 0.2); color: var(--accent-warning); }
        .workflow-badge.running { background: rgba(0, 184, 212, 0.2); color: var(--accent-info); }
        .workflow-badge.failed { background: rgba(255, 82, 82, 0.2); color: var(--accent-error); }

        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px 0; }
        .collapsible-header:hover { opacity: 0.8; }
        .collapsible-content { display: none; padding-top: 12px; }
        .collapsible-content.active { display: block; }
        .collapse-icon { transition: transform 0.2s; }
        .collapse-icon.rotated { transform: rotate(180deg); }
        
        .setup-steps { background: var(--bg-tertiary); border-radius: 8px; padding: 16px; }
        .setup-step { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-color); font-size: 12px; }
        .setup-step:last-child { border-bottom: none; }
        .step-number { width: 24px; height: 24px; background: var(--se-gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 11px; flex-shrink: 0; }
        .step-content { flex: 1; }
        .step-content strong { color: var(--text-primary); }
        .step-content p { color: var(--text-secondary); margin-top: 4px; line-height: 1.4; }
        .step-content code { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; font-size: 11px; color: var(--accent-info); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>‚ö° Arcadia LMP Data Fetcher <span class="azure-badge">‚òÅÔ∏è Azure</span></h2>
            <p>Fetch Day-Ahead LMP data from Genability API</p>
            <div class="version">v2.2.0 ‚Ä¢ Feb 2026 ‚Ä¢ Azure Storage Enabled</div>
        </div>
        
        <div class="mode-tabs">
            <button class="mode-tab active" onclick="switchMode('server')">
                <span class="tab-icon">üñ•Ô∏è</span> Server Update
            </button>
            <button class="mode-tab" onclick="switchMode('browser')">
                <span class="tab-icon">üåê</span> Browser Fetch
            </button>
        </div>
        
        <!-- Server Mode -->
        <div id="serverMode" class="mode-content active">
            <div class="azure-notice">
                <h4>‚òÅÔ∏è Azure Storage Integration Active</h4>
                <p>Data is now stored securely in Azure Blob Storage via the SES Data API. GitHub Actions fetches from Genability and saves directly to Azure.</p>
            </div>
            
            <div class="section">
                <div class="section-title">GitHub Configuration</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>GitHub Token (PAT)</label>
                        <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                        <div class="helper-text">Requires <code>repo</code> + <code>workflow</code> scopes</div>
                    </div>
                    <div class="form-group">
                        <label>Repository</label>
                        <input type="text" id="repoName" value="ClemmensSES/SESSalesResources" placeholder="owner/repo">
                    </div>
                </div>
                
                <div class="collapsible-header" onclick="toggleCollapsible('tokenHelp')">
                    <span style="font-size: 12px; color: var(--accent-info);">üìã How to get/refresh your GitHub Token</span>
                    <span class="collapse-icon" id="tokenHelpIcon">‚ñº</span>
                </div>
                <div class="collapsible-content" id="tokenHelp">
                    <div class="setup-steps" style="margin: 0;">
                        <div class="setup-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <strong>Go to GitHub Token Settings</strong>
                                <p><a href="https://github.com/settings/tokens/new?scopes=repo,workflow&description=LMP%20Fetcher" target="_blank" style="color: var(--se-light-green);">Click here for pre-configured token</a></p>
                            </div>
                        </div>
                        <div class="setup-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <strong>Set Expiration ‚Üí Generate ‚Üí Copy</strong>
                                <p>Choose 90 days, click Generate, then <strong>copy immediately</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Update Options</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date (Optional)</label>
                        <input type="date" id="serverStartDate">
                    </div>
                    <div class="form-group">
                        <label>End Date (Optional)</label>
                        <input type="date" id="serverEndDate">
                    </div>
                </div>
                <div class="form-group">
                    <label>ISO Markets</label>
                    <select id="serverIsoMarkets">
                        <option value="all">All Markets (ISONE, PJM, ERCOT)</option>
                        <option value="ISONE">ISO-NE Only</option>
                        <option value="PJM">PJM Only</option>
                        <option value="ERCOT">ERCOT Only</option>
                    </select>
                </div>
                <p style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                    Leave dates blank to fetch previous month. Data saves to Azure automatically.
                </p>
            </div>
            
            <div class="section">
                <div class="button-group">
                    <button class="btn-purple" onclick="triggerWorkflow()" style="flex: 1;">üöÄ Trigger Server Update</button>
                    <button class="btn-secondary" onclick="checkWorkflowStatus()">üìä Check Status</button>
                </div>
                <div class="status-message" id="serverStatus"></div>
                <div class="workflow-status" id="workflowStatusCard" style="display: none;">
                    <h4>üìã Recent Workflow Runs</h4>
                    <div id="workflowRuns"></div>
                </div>
            </div>
            
            <div class="section">
                <div class="collapsible-header" onclick="toggleCollapsible('troubleshoot')">
                    <span class="section-title" style="margin: 0; border: none; padding: 0;">üîß Troubleshooting</span>
                    <span class="collapse-icon" id="troubleshootIcon">‚ñº</span>
                </div>
                <div class="collapsible-content" id="troubleshoot">
                    <div class="setup-steps" style="margin: 0; background: transparent; padding: 0;">
                        <div class="setup-step">
                            <div class="step-number" style="background: var(--accent-error);">!</div>
                            <div class="step-content">
                                <strong>401 Unauthorized</strong>
                                <p>Token invalid/expired. <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--se-light-green);">Regenerate PAT</a></p>
                            </div>
                        </div>
                        <div class="setup-step">
                            <div class="step-number" style="background: var(--accent-warning);">!</div>
                            <div class="step-content">
                                <strong>Azure API Error</strong>
                                <p>Check GitHub Secrets: <code>AZURE_API_ENDPOINT</code> and <code>AZURE_API_KEY</code></p>
                            </div>
                        </div>
                        <div class="setup-step">
                            <div class="step-number" style="background: var(--accent-warning);">!</div>
                            <div class="step-content">
                                <strong>Genability Auth Failed</strong>
                                <p>Check GitHub Secrets: <code>ARCADIA_APP_ID</code> and <code>ARCADIA_APP_KEY</code></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Browser Mode -->
        <div id="browserMode" class="mode-content">
            <div class="cors-notice">
                <h4>‚ö†Ô∏è Browser Fetch Mode</h4>
                <p>Fetch directly from Genability API and sync to Azure. Requires CORS proxy for browser testing.</p>
            </div>
            
            <div class="section">
                <div class="section-title">1. API Credentials</div>
                <div class="proxy-mode">
                    <label class="proxy-toggle">
                        <input type="checkbox" id="useProxy" checked onchange="updateProxyStatus()">
                        <span class="proxy-slider"></span>
                    </label>
                    <div>
                        <strong style="font-size: 12px;">Use CORS Proxy</strong>
                        <p style="font-size: 10px; color: var(--text-tertiary);" id="proxyStatusText">Using corsproxy.io</p>
                    </div>
                    <select id="proxySelector" onchange="updateProxyStatus()" style="margin-left: auto; padding: 4px 8px; font-size: 11px; background: var(--bg-elevated); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                        <option value="corsproxy">corsproxy.io</option>
                        <option value="allorigins">allorigins.win</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Genability App ID</label>
                        <input type="text" id="appId" placeholder="Your Genability App ID">
                    </div>
                    <div class="form-group">
                        <label>Genability App Key</label>
                        <input type="password" id="appKey" placeholder="Your Genability App Key">
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="testCredentials()">Test Credentials</button>
                    <button class="btn-secondary" onclick="toggleDebug()">üîç Debug</button>
                </div>
                <div class="status-message" id="credStatus"></div>
            </div>
            
            <div class="section">
                <div class="section-title">2. Date Range</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">3. Select ISO Market</div>
                <div class="iso-grid" id="isoSelector"></div>
            </div>
            
            <div class="section" id="zoneSection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div class="section-title" style="margin: 0; border: none; padding: 0;">4. Select Zones</div>
                    <button class="btn-secondary" onclick="toggleSelectAll()" style="padding: 4px 10px; font-size: 11px;">Select All</button>
                </div>
                <div class="zones-grid" id="zonesGrid"></div>
            </div>
            
            <div class="section">
                <div class="button-group">
                    <button class="btn-primary" onclick="fetchData()" style="flex: 1;">‚ö° Fetch LMP Data</button>
                    <button class="btn-success" id="exportBtn" onclick="exportCSV()" style="flex: 1;" disabled>üì• Export CSV</button>
                </div>
            </div>
            
            <div class="status-message" id="statusMessage"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="color: var(--text-secondary); font-size: 12px;">Fetching data...</p>
            </div>
            
            <div class="debug-console" id="debugConsole">
                <div class="debug-actions">
                    <button class="btn-secondary" onclick="clearDebug()" style="padding: 4px 8px; font-size: 10px;">Clear</button>
                    <button class="btn-secondary" onclick="copyDebug()" style="padding: 4px 8px; font-size: 10px;">Copy</button>
                </div>
                <div id="debugLines"></div>
            </div>
            
            <div class="section results-section" id="resultsSection">
                <div class="section-title">Results</div>
                <div class="stats-grid" id="statsGrid"></div>
                <h4 style="margin-bottom: 10px; font-size: 13px;">Monthly Averages</h4>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead><tr><th>Zone</th><th>Month</th><th>Year</th><th>Avg $/MWh</th><th>Records</th></tr></thead>
                        <tbody id="resultsBody"></tbody>
                    </table>
                </div>
                <div class="button-group" style="margin-top: 12px;">
                    <button class="btn-azure" onclick="syncToAzure()">‚òÅÔ∏è Save to Azure</button>
                    <button class="btn-primary" onclick="sendToPortal()">üì§ Send to Portal</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            version: '2.2.0',
            defaultRepo: 'ClemmensSES/SESSalesResources',
            azure: {
                endpoint: 'https://ses-data-api-gpaqghfbehhrb6c2.eastus-01.azurewebsites.net/api/data',
                apiKey: 'ses-admin-abc123def456',
                lmpFile: 'lmp-database.json'
            },
            proxies: {
                corsproxy: url => 'https://corsproxy.io/?' + encodeURIComponent(url),
                allorigins: url => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url)
            }
        };
        
        const ISO_CONFIG = {
            ISONE: {
                name: 'ISO-NE', propertyKey: 'hourlyPricingDayAheadISONE',
                zones: [
                    { value: '4001', label: 'ISO NE CA' }, { value: '4002', label: 'Maine' },
                    { value: '4003', label: 'NH' }, { value: '4004', label: 'Vermont' },
                    { value: '4005', label: 'Connecticut' }, { value: '4006', label: 'Rhode Island' },
                    { value: '4007', label: 'SEMA' }, { value: '4008', label: 'WCMA' }, { value: '4009', label: 'NEMA' }
                ]
            },
            PJM: {
                name: 'PJM', propertyKey: 'hourlyPricingDayAheadPJM',
                zones: [
                    { value: '51291', label: 'AECO' }, { value: '51292', label: 'BGE' },
                    { value: '51293', label: 'DPL' }, { value: '51294', label: 'JCPL' },
                    { value: '51295', label: 'METED' }, { value: '51296', label: 'PECO' },
                    { value: '51297', label: 'PENELEC' }, { value: '51298', label: 'PEPCO' },
                    { value: '51299', label: 'PPL' }, { value: '51300', label: 'PSEG' }
                ]
            },
            ERCOT: {
                name: 'ERCOT', propertyKey: 'hourlyPricingDayAheadERCOT',
                zones: [
                    { value: 'LZ_HOUSTON', label: 'Houston' }, { value: 'LZ_NORTH', label: 'North' },
                    { value: 'LZ_SOUTH', label: 'South' }, { value: 'LZ_WEST', label: 'West' }
                ]
            }
        };
        
        let currentISO = null, selectedZones = [], fetchedData = { hourly: [], monthly: [] }, debugVisible = false;
        
        // ============================================
        // AZURE DATA SERVICE
        // ============================================
        const AzureService = {
            async get(file) {
                // Try parent's AzureDataService first (if in iframe)
                if (window.parent !== window && window.parent.AzureDataService) {
                    try {
                        addDebugLine('Using parent AzureDataService...', 'azure');
                        return await window.parent.AzureDataService.get(file);
                    } catch (e) {
                        addDebugLine('Parent service failed, using direct API', 'warning');
                    }
                }
                
                // Direct API call
                const res = await fetch(`${CONFIG.azure.endpoint}/${file}`, {
                    headers: { 'x-api-key': CONFIG.azure.apiKey }
                });
                if (!res.ok) throw new Error(`Azure GET failed: ${res.status}`);
                return res.json();
            },
            
            async save(file, data) {
                // Try parent's AzureDataService first
                if (window.parent !== window && window.parent.AzureDataService) {
                    try {
                        addDebugLine('Using parent AzureDataService...', 'azure');
                        return await window.parent.AzureDataService.save(file, data);
                    } catch (e) {
                        addDebugLine('Parent service failed, using direct API', 'warning');
                    }
                }
                
                // Direct API call
                const res = await fetch(`${CONFIG.azure.endpoint}/${file}`, {
                    method: 'PUT',
                    headers: {
                        'x-api-key': CONFIG.azure.apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error(`Azure PUT failed: ${res.status}`);
                return res.json();
            }
        };
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function getProxyUrl(url) {
            if (!document.getElementById('useProxy').checked) return url;
            return CONFIG.proxies[document.getElementById('proxySelector').value](url);
        }
        
        function updateProxyStatus() {
            const enabled = document.getElementById('useProxy').checked;
            const type = document.getElementById('proxySelector').value;
            document.getElementById('proxyStatusText').textContent = enabled ? `Using ${type}` : 'Direct (may fail)';
        }
        
        function addDebugLine(msg, type = 'info') {
            const el = document.getElementById('debugLines');
            const ts = new Date().toLocaleTimeString();
            el.innerHTML += `<div class="debug-line ${type}"><span class="debug-timestamp">[${ts}]</span>${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }
        
        function clearDebug() { document.getElementById('debugLines').innerHTML = ''; }
        function copyDebug() { navigator.clipboard.writeText(document.getElementById('debugLines').innerText); }
        function toggleDebug() { debugVisible = !debugVisible; document.getElementById('debugConsole').classList.toggle('active', debugVisible); }
        
        function showStatus(msg, type = 'info', id = 'statusMessage') {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.className = `status-message active ${type}`;
        }
        function hideStatus(id = 'statusMessage') { document.getElementById(id).className = 'status-message'; }
        function showServerStatus(msg, type) { showStatus(msg, type, 'serverStatus'); }
        
        function toggleCollapsible(id) {
            document.getElementById(id).classList.toggle('active');
            document.getElementById(id + 'Icon').classList.toggle('rotated');
        }
        
        function switchMode(mode) {
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));
            if (mode === 'server') {
                document.querySelector('.mode-tab:first-child').classList.add('active');
                document.getElementById('serverMode').classList.add('active');
            } else {
                document.querySelector('.mode-tab:last-child').classList.add('active');
                document.getElementById('browserMode').classList.add('active');
            }
        }
        
        // ============================================
        // SERVER MODE - GitHub Actions
        // ============================================
        async function triggerWorkflow() {
            const token = document.getElementById('githubToken').value.trim();
            const repo = document.getElementById('repoName').value.trim();
            if (!token) { showServerStatus('‚ùå Enter GitHub token', 'error'); return; }
            if (!repo) { showServerStatus('‚ùå Enter repository', 'error'); return; }
            
            showServerStatus('üîÑ Triggering workflow...', 'info');
            
            try {
                const inputs = { iso_markets: document.getElementById('serverIsoMarkets').value };
                const startDate = document.getElementById('serverStartDate').value;
                const endDate = document.getElementById('serverEndDate').value;
                if (startDate) inputs.start_date = startDate;
                if (endDate) inputs.end_date = endDate;
                
                const res = await fetch(`https://api.github.com/repos/${repo}/actions/workflows/update-lmp-data.yml/dispatches`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ref: 'main', inputs })
                });
                
                if (res.status === 204) {
                    showServerStatus('‚úÖ Workflow triggered! Data will save to Azure.', 'success');
                    localStorage.setItem('lmpFetcher_githubToken', token);
                    localStorage.setItem('lmpFetcher_repoName', repo);
                    setTimeout(checkWorkflowStatus, 3000);
                } else if (res.status === 404) {
                    showServerStatus('‚ùå Workflow not found', 'error');
                } else if (res.status === 401) {
                    showServerStatus('‚ùå Invalid token', 'error');
                } else {
                    showServerStatus(`‚ùå Error ${res.status}`, 'error');
                }
            } catch (e) { showServerStatus(`‚ùå ${e.message}`, 'error'); }
        }
        
        async function checkWorkflowStatus() {
            const token = document.getElementById('githubToken').value.trim();
            const repo = document.getElementById('repoName').value.trim();
            if (!token || !repo) return;
            
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/actions/workflows/update-lmp-data.yml/runs?per_page=5`, {
                    headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (!res.ok) return;
                
                const data = await res.json();
                const card = document.getElementById('workflowStatusCard');
                const runs = document.getElementById('workflowRuns');
                
                if (data.workflow_runs?.length > 0) {
                    card.style.display = 'block';
                    runs.innerHTML = data.workflow_runs.map(run => {
                        let badge = 'pending', text = run.status;
                        if (run.conclusion === 'success') { badge = 'success'; text = 'Success'; }
                        else if (run.conclusion === 'failure') { badge = 'failed'; text = 'Failed'; }
                        else if (run.status === 'in_progress') { badge = 'running'; text = 'Running...'; }
                        return `<div class="workflow-item"><div><div style="font-weight:600">#${run.run_number}</div><div style="font-size:10px;color:var(--text-tertiary)">${new Date(run.created_at).toLocaleString()}</div></div><a href="${run.html_url}" target="_blank" class="workflow-badge ${badge}">${text}</a></div>`;
                    }).join('');
                    if (data.workflow_runs.some(r => r.status === 'in_progress' || r.status === 'queued')) setTimeout(checkWorkflowStatus, 10000);
                }
            } catch (e) {}
        }
        
        // ============================================
        // BROWSER MODE
        // ============================================
        function init() {
            const savedToken = localStorage.getItem('lmpFetcher_githubToken');
            const savedRepo = localStorage.getItem('lmpFetcher_repoName');
            if (savedToken) document.getElementById('githubToken').value = savedToken;
            if (savedRepo) document.getElementById('repoName').value = savedRepo;
            
            const today = new Date(), ago = new Date(today);
            ago.setDate(today.getDate() - 30);
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = ago.toISOString().split('T')[0];
            
            const sel = document.getElementById('isoSelector');
            Object.keys(ISO_CONFIG).forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'iso-btn';
                btn.textContent = ISO_CONFIG[key].name;
                btn.onclick = () => selectISO(key, btn);
                sel.appendChild(btn);
            });
            
            window.addEventListener('message', handleMessage);
            addDebugLine(`LMP Fetcher v${CONFIG.version} ready (Azure enabled)`, 'success');
        }
        
        function selectISO(key, btn) {
            currentISO = key;
            selectedZones = [];
            document.querySelectorAll('.iso-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('zoneSection').style.display = 'block';
            document.getElementById('zonesGrid').innerHTML = ISO_CONFIG[key].zones.map(z => `<label class="zone-item"><input type="checkbox" value="${z.value}" onchange="updateSelectedZones()">${z.label}</label>`).join('');
        }
        
        function updateSelectedZones() { selectedZones = Array.from(document.querySelectorAll('.zone-item input:checked')).map(cb => cb.value); }
        function toggleSelectAll() {
            const cbs = document.querySelectorAll('.zone-item input');
            const all = Array.from(cbs).every(cb => cb.checked);
            cbs.forEach(cb => cb.checked = !all);
            updateSelectedZones();
        }
        
        async function testCredentials() {
            const appId = document.getElementById('appId').value.trim();
            const appKey = document.getElementById('appKey').value.trim();
            if (!appId || !appKey) { showStatus('Enter credentials', 'error', 'credStatus'); return; }
            
            showStatus('Testing...', 'info', 'credStatus');
            try {
                const creds = btoa(`${appId}:${appKey}`);
                const url = getProxyUrl('https://api.genability.com/rest/echo/hello');
                const res = await fetch(url, { headers: { 'Authorization': `Basic ${creds}` } });
                if (res.ok) showStatus('‚úì Valid!', 'success', 'credStatus');
                else showStatus('‚úó Invalid', 'error', 'credStatus');
            } catch (e) { showStatus('Connection error', 'error', 'credStatus'); }
        }
        
        async function fetchData() {
            const appId = document.getElementById('appId').value.trim();
            const appKey = document.getElementById('appKey').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!appId || !appKey) { showStatus('Enter credentials', 'error'); return; }
            if (!currentISO) { showStatus('Select an ISO', 'error'); return; }
            if (!selectedZones.length) { showStatus('Select zones', 'error'); return; }
            
            document.getElementById('loading').classList.add('active');
            hideStatus();
            
            const creds = btoa(`${appId}:${appKey}`);
            const cfg = ISO_CONFIG[currentISO];
            fetchedData = { hourly: [], monthly: [] };
            let total = 0;
            
            addDebugLine(`Fetching ${selectedZones.length} zones from ${cfg.name}...`, 'info');
            
            try {
                for (const zid of selectedZones) {
                    const zname = cfg.zones.find(z => z.value === zid)?.label || zid;
                    const recs = await fetchZoneData(creds, cfg.propertyKey, zid, startDate, endDate);
                    if (recs.length) {
                        fetchedData.hourly.push(...recs.map(r => ({ ...r, zone: zname, zone_id: zid, iso: currentISO })));
                        total += recs.length;
                        addDebugLine(`  ${zname}: ${recs.length} records`, 'success');
                    }
                }
                
                fetchedData.monthly = calcMonthly(fetchedData.hourly);
                displayResults();
                showStatus(`‚úÖ ${total.toLocaleString()} records`, 'success');
                document.getElementById('exportBtn').disabled = false;
            } catch (e) {
                addDebugLine(`Error: ${e.message}`, 'error');
                showStatus(`Error: ${e.message}`, 'error');
            } finally { document.getElementById('loading').classList.remove('active'); }
        }
        
        async function fetchZoneData(creds, propKey, zoneId, start, end) {
            const base = 'https://api.genability.com/rest/public/properties';
            let all = [], page = 0, more = true;
            
            while (more) {
                const params = new URLSearchParams({ subKeyName: zoneId, fromDateTime: `${start}T00:00:00`, toDateTime: `${end}T23:59:59`, pageStart: page, pageCount: 1000 });
                const res = await fetch(getProxyUrl(`${base}/${propKey}/lookups?${params}`), { headers: { 'Authorization': `Basic ${creds}` } });
                if (!res.ok) throw new Error(res.status === 401 ? 'Invalid credentials' : `API error: ${res.status}`);
                
                const data = await res.json();
                if (data.results?.length) {
                    all.push(...data.results.map(i => ({ datetime: i.fromDateTime || i.period, price: parseFloat(i.dataValue || i.lmpTotal || 0) })).filter(r => !isNaN(r.price)));
                    more = data.count > page + 1000;
                    page += 1000;
                } else more = false;
            }
            return all;
        }
        
        function calcMonthly(hourly) {
            const map = {};
            hourly.forEach(r => {
                const d = new Date(r.datetime), y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0');
                const k = `${r.zone}_${y}_${m}`;
                if (!map[k]) map[k] = { zone: r.zone, zone_id: r.zone_id, iso: r.iso, year: String(y), month: m, prices: [] };
                map[k].prices.push(r.price);
            });
            return Object.values(map).map(m => ({
                zone: m.zone, zone_id: m.zone_id, iso: m.iso, year: m.year, month: m.month,
                avg_da_lmp: m.prices.reduce((a, b) => a + b, 0) / m.prices.length,
                min_price: Math.min(...m.prices), max_price: Math.max(...m.prices), record_count: m.prices.length
            })).sort((a, b) => a.zone.localeCompare(b.zone) || a.year.localeCompare(b.year) || a.month.localeCompare(b.month));
        }
        
        function displayResults() {
            document.getElementById('resultsSection').classList.add('active');
            const m = fetchedData.monthly, total = fetchedData.hourly.length;
            const avg = m.length ? m.reduce((a, b) => a + b.avg_da_lmp, 0) / m.length : 0;
            
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card"><div class="stat-value">${total.toLocaleString()}</div><div class="stat-label">Records</div></div>
                <div class="stat-card"><div class="stat-value">$${avg.toFixed(2)}</div><div class="stat-label">Avg $/MWh</div></div>
            `;
            document.getElementById('resultsBody').innerHTML = m.slice(0, 15).map(r => `<tr><td>${r.zone}</td><td>${r.month}</td><td>${r.year}</td><td>$${r.avg_da_lmp.toFixed(2)}</td><td>${r.record_count}</td></tr>`).join('');
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function exportCSV() {
            if (!fetchedData.monthly.length) return;
            const csv = ['ISO,Zone,Month,Year,Avg_DA_LMP,Min,Max,Count', ...fetchedData.monthly.map(r => `${r.iso},${r.zone},${r.month},${r.year},${r.avg_da_lmp.toFixed(4)},${r.min_price.toFixed(4)},${r.max_price.toFixed(4)},${r.record_count}`)].join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            a.download = `lmp_${currentISO}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        async function syncToAzure() {
            if (!fetchedData.monthly.length) { showStatus('No data', 'warning'); return; }
            
            showStatus('‚òÅÔ∏è Syncing to Azure...', 'info');
            addDebugLine('Starting Azure sync...', 'azure');
            
            try {
                // Fetch existing database
                let database;
                try {
                    database = await AzureService.get(CONFIG.azure.lmpFile);
                    addDebugLine('Loaded existing database from Azure', 'azure');
                } catch (e) {
                    addDebugLine('No existing database, creating new', 'warning');
                    database = { meta: {}, data: { ISONE: [], PJM: [], ERCOT: [] } };
                }
                
                // Merge new data
                let added = 0, updated = 0;
                for (const record of fetchedData.monthly) {
                    if (!database.data[record.iso]) database.data[record.iso] = [];
                    const key = `${record.iso}_${record.zone_id}_${record.year}_${record.month}`;
                    const idx = database.data[record.iso].findIndex(r => `${r.iso}_${r.zone_id}_${r.year}_${r.month}` === key);
                    if (idx === -1) { database.data[record.iso].push(record); added++; }
                    else { database.data[record.iso][idx] = record; updated++; }
                }
                
                // Update metadata
                database.meta = {
                    lastUpdate: new Date().toISOString(),
                    source: 'arcadia-browser',
                    version: '2.0',
                    storage: 'azure'
                };
                
                // Save to Azure
                await AzureService.save(CONFIG.azure.lmpFile, database);
                
                showStatus(`‚úÖ Saved to Azure! Added: ${added}, Updated: ${updated}`, 'success');
                addDebugLine(`Azure sync complete: +${added} ~${updated}`, 'success');
            } catch (e) {
                showStatus(`‚ùå Azure error: ${e.message}`, 'error');
                addDebugLine(`Azure error: ${e.message}`, 'error');
            }
        }
        
        function sendToPortal() {
            if (!fetchedData.monthly.length) return;
            const data = fetchedData.monthly.map(r => ({ month: r.month, year: r.year, zone: r.zone_id, zone_name: r.zone, avg_da_lmp: r.avg_da_lmp }));
            if (window.parent !== window) window.parent.postMessage({ type: 'LMP_DATA_UPDATE', iso: currentISO, records: data, source: 'arcadia' }, '*');
            showStatus('Sent to portal', 'success');
        }
        
        function handleMessage(e) {
            if (e.data?.type === 'REQUEST_LMP_DATA') sendToPortal();
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
